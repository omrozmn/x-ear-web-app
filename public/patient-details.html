<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hasta Detaylarƒ± - X-Ear CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="assets/js/pdf-converter.js"></script>
    <script src="assets/js/spacy-backend-client.js"></script>
    <script src="assets/js/spacy-nlp-service.js"></script>
    <script src="assets/js/patient-matching-service.js"></script>
    <script src="assets/js/ocr-engine.js"></script>
    <script src="assets/js/ocr-integration.js"></script>
    <script src="assets/js/image-processor.js"></script>
    <link rel="stylesheet" href="assets/style.css?v=6">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563EB',
                        'light-gray': '#F9FAFB'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-light-gray">
    <!-- Sidebar Navigation -->
    <div id="sidebar-container"></div>

    <!-- Patient List Sidebar -->
    <div id="patient-list-sidebar" class="patient-list-sidebar">
        <div class="p-4 border-b border-gray-200">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-semibold text-gray-900">Hastalar</h3>
                <button onclick="togglePatientList()" class="p-1 rounded hover:bg-gray-100" title="Hasta listesini gizle/g√∂ster">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
            </div>
            <div class="relative">
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <input type="text" id="patientSearchInput" placeholder="Hasta ara..." 
                       class="w-full pl-10 pr-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
        </div>
        <div class="patient-list-container" id="patientListContainer">
            <!-- Patient list will be populated by JavaScript -->
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content patient-details-content">
        <!-- Patient List Toggle Button (when collapsed) -->
        <button id="patient-list-toggle-collapsed" onclick="togglePatientList()" 
                class="fixed left-4 top-20 z-20 p-2 bg-white rounded-lg shadow-lg border border-gray-200 hover:bg-gray-50 transition-all duration-200" 
                style="display: none;" title="Hasta listesini a√ß">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
        </button>

        <!-- Header -->
        <div id="header-container"></div>

        <!-- Patient Profile Section -->
        <div class="p-6">
            <div id="patient-profile-container"></div>

            <!-- Summary Cards -->
            <div id="stats-container"></div>

            <!-- Tabs -->
            <div id="tabs-container"></div>

            <!-- Tab Content -->
            <div id="tab-content" class="mt-6">
                <!-- Dynamic tab content will be loaded here -->
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="modals-container"></div>

    <!-- Widget Scripts -->
    <script src="assets/js/utils.js?v=2"></script>
    <script src="assets/js/app.js"></script>
    <script src="assets/data.js"></script>
    <script src="assets/js/patients.js"></script>
    <script src="assets/js/sgk.js"></script>
    <script src="assets/js/appointments.js"></script>
    <script src="assets/js/devices.js"></script>
    <script>
        // Initialize managers
        document.addEventListener('DOMContentLoaded', () => {
            if (!window.sgkManager) {
                window.sgkManager = new SGKManager();
            }
            
            // Make PatientManager available as patientManager for consistency
            if (window.PatientManager && !window.patientManager) {
                window.patientManager = window.PatientManager;
                console.log('PatientManager reference created successfully');
            }
        });
    </script>
    <script src="assets/js/document-manager.js"></script>
    <script src="assets/js/sgk-document-pipeline.js"></script>
    <script src="assets/js/global-search.js"></script>
    <script src="assets/js/sms-gateway.js"></script>
    <script src="assets/js/email-manager.js"></script>
    <script src="assets/js/data-export-import.js"></script>
    <script src="assets/js/patient-details.js"></script>
    <script src="assets/js/patient-details-modals.js"></script>
    <script src="assets/js/patient-details-tab-loader.js"></script>
    <script src="assets/js/timeline-tab.js"></script>
    <script src="assets/js/sales-tab.js"></script>
    <script src="assets/js/widget-loader.js"></script>

    <script type="application/javascript">
        // @ts-nocheck
        /* eslint-disable */
        /* global Utils, patientDetailsManager */
        // Global variables
        let currentPatientId = getPatientIdFromURL();
        let patientProfile, tabNavigation, statsCards;

        // Get patient ID from URL parameters
        function getPatientIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('patient') || urlParams.get('id') || 'p1';
        }

        // Get tab parameter from URL
        function getTabFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('tab') || null;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Ensure sample data is properly set up
            setupSampleData();
            
            // Set default dates for date inputs
            const today = new Date().toISOString().split('T')[0];
            const documentDateInput = document.getElementById('documentDate');
            const applicationDateInput = document.getElementById('applicationDate');
            if (documentDateInput) documentDateInput.value = today;
            if (applicationDateInput) applicationDateInput.value = today;
            
            await initializeWidgets();
            await loadPatientList();
            loadPatientData();
            setupPatientSearch();
            adjustLayoutForSidebars();
            
            // Initialize SGK Pipeline
            if (typeof SGKDocumentPipeline !== 'undefined') {
                window.sgkPipeline = new SGKDocumentPipeline();
                console.log('‚úÖ SGK Document Pipeline initialized');
            }
            
            // Initialize document manager
            if (typeof DocumentManager !== 'undefined') {
                window.documentManager = new DocumentManager();
                console.log('‚úÖ Document Manager initialized');
            }
            
            // Add window resize listener to recalculate patient list width
            window.addEventListener('resize', function() {
                updateLayoutMargins();
            });
        });

        // Function to set up sample data properly
        function setupSampleData() {
            console.log('üîÑ Setting up sample data for patient details...');
            
            // Initialize sampleData object if it doesn't exist
            if (!window.sampleData) {
                window.sampleData = {};
                console.log('üìù Created new sampleData object');
            }
            
            // Check if global variables exist from data.js
            if (typeof samplePatients !== 'undefined' && Array.isArray(samplePatients)) {
                window.sampleData.patients = samplePatients;
                console.log(`‚úÖ Sample patients loaded: ${samplePatients.length} patients`);
            } else {
                console.warn('‚ö†Ô∏è samplePatients not found, using fallback data');
                window.sampleData.patients = [];
            }
            
            if (typeof sampleAppointments !== 'undefined' && Array.isArray(sampleAppointments)) {
                window.sampleData.appointments = sampleAppointments;
                console.log(`‚úÖ Sample appointments loaded: ${sampleAppointments.length} appointments`);
            } else {
                console.warn('‚ö†Ô∏è sampleAppointments not found');
                window.sampleData.appointments = [];
            }
            
            if (typeof sampleInventory !== 'undefined' && Array.isArray(sampleInventory)) {
                window.sampleData.inventory = sampleInventory;
                console.log(`‚úÖ Sample inventory loaded: ${sampleInventory.length} items`);
            } else {
                console.warn('‚ö†Ô∏è sampleInventory not found');
                window.sampleData.inventory = [];
            }
            
            if (typeof sampleCampaigns !== 'undefined' && Array.isArray(sampleCampaigns)) {
                window.sampleData.campaigns = sampleCampaigns;
                console.log(`‚úÖ Sample campaigns loaded: ${sampleCampaigns.length} campaigns`);
            } else {
                console.warn('‚ö†Ô∏è sampleCampaigns not found');
                window.sampleData.campaigns = [];
            }
            
            console.log('‚úÖ Sample data setup complete');
            console.log('üìä Final sampleData structure:', {
                patients: window.sampleData.patients?.length || 0,
                appointments: window.sampleData.appointments?.length || 0,
                inventory: window.sampleData.inventory?.length || 0,
                campaigns: window.sampleData.campaigns?.length || 0
            });
        }

        async function initializeWidgets() {
            console.log('üîÑ Initializing widgets...');
            
            try {
                // Use existing widget loader instance
                const loader = window.widgetLoader;
                
                if (!loader) {
                    console.error('‚ùå Widget loader not found!');
                    return;
                }
                
                // Initialize widgets for patient-details page
                await loader.initPageWidgets('patient-details');
                console.log('‚úÖ Page widgets initialized');
                
                // Load additional widgets needed for this page
                await loader.loadWidgets(['stats-card', 'patient-profile', 'tab-navigation']);
                console.log('‚úÖ Additional widgets loaded');
                
                // Render sidebar and header
                const sidebarContainer = document.getElementById('sidebar-container');
                if (sidebarContainer && typeof SidebarWidget !== 'undefined') {
                    const sidebar = new SidebarWidget('patients');
                    sidebarContainer.innerHTML = sidebar.render();
                    console.log('‚úÖ Sidebar rendered');
                } else {
                    console.warn('‚ö†Ô∏è Sidebar container not found or SidebarWidget not available');
                }

                // Initialize header
                const headerContainer = document.getElementById('header-container');
                if (headerContainer && typeof HeaderWidget !== 'undefined') {
                    const header = new HeaderWidget('Hasta Detaylarƒ±');
                    headerContainer.innerHTML = header.render();
                    console.log('‚úÖ Header rendered');
                } else {
                    console.warn('‚ö†Ô∏è Header container not found or HeaderWidget not available');
                }

                // Initialize patient profile
                if (typeof PatientProfileWidget !== 'undefined') {
                    patientProfile = PatientProfileWidget.createDefault('patient-profile-container');
                    window.patientProfile = patientProfile; // Make it globally accessible
                    patientProfile.render();
                    console.log('‚úÖ Patient profile initialized');
                } else {
                    console.error('‚ùå PatientProfileWidget not available');
                }

            // Initialize stats cards
            const statsContainer = document.getElementById('stats-container');
            if (statsContainer && typeof StatsCardWidget !== 'undefined') {
                const statsData = [
                    new StatsCardWidget({
                        title: 'Toplam Randevu',
                        value: '5',
                        color: 'blue',
                        icon: `<svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                        </svg>`
                    }),
                    new StatsCardWidget({
                        title: 'Cihaz Sayƒ±sƒ±',
                        value: '1',
                        color: 'green',
                        icon: `<svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                        </svg>`
                    }),
                    new StatsCardWidget({
                        title: 'Toplam Harcama',
                        value: '‚Ç∫15.000',
                        color: 'yellow',
                        icon: `<svg class="w-6 h-6 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"/>
                        </svg>`
                    }),
                    new StatsCardWidget({
                        title: 'M√º≈üteri S√ºresi',
                        value: '2 ay',
                        color: 'purple',
                        icon: `<svg class="w-6 h-6 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                        </svg>`
                    })
                ];
                
                const cardsHtml = statsData.map(card => card.render()).join('');
                statsContainer.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">${cardsHtml}</div>`;
            }

            // Initialize tab navigation
            const tabsContainer = document.getElementById('tabs-container');
            if (tabsContainer && typeof TabNavigationWidget !== 'undefined') {
                tabNavigation = TabNavigationWidget.createPatientDetailsTabs('tabs-container');
                tabNavigation.render();
                
                // Add tab change listener to load data when Sales tab is selected
                const originalSwitchTab = tabNavigation.switchTab.bind(tabNavigation);
                tabNavigation.switchTab = function(tabId) {
                    originalSwitchTab(tabId);
                    
                    // Load sales data when sales tab is activated
                    if (tabId === 'sales') {
                        setTimeout(() => {
                            loadSalesData();
                        }, 100);
                    }
                    
                    // Load E-re√ßete data when documents tab is activated
                    if (tabId === 'documents') {
                        setTimeout(() => {
                            loadDocumentsTabData();
                        }, 100);
                    }
                };
                
                // Check if a specific tab was requested in the URL
                const requestedTab = getTabFromURL();
                if (requestedTab) {
                    setTimeout(() => {
                        console.log(`üîó Switching to requested tab: ${requestedTab}`);
                        tabNavigation.switchTab(requestedTab);
                    }, 500); // Give time for the widget to fully initialize
                }
            }
            } catch (error) {
                console.error('‚ùå Error initializing widgets:', error);
            }
        }

        // Function to load a specific patient (can be called from external scripts)
        function loadPatient(patientId, tabId = null) {
            console.log(`üîó Loading patient: ${patientId}, tab: ${tabId}`);
            
            if (patientId && patientId !== currentPatientId) {
                currentPatientId = patientId;
                loadPatientData();
                
                // Update URL without reloading page
                const newUrl = new URL(window.location);
                newUrl.searchParams.set('patient', patientId);
                if (tabId) {
                    newUrl.searchParams.set('tab', tabId);
                }
                window.history.pushState({}, '', newUrl);
            }
            
            // Switch to requested tab if specified
            if (tabId && tabNavigation) {
                setTimeout(() => {
                    tabNavigation.switchTab(tabId);
                }, 200);
            }
        }

        // Function to load a specific patient (can be called from external scripts)
        function loadPatient(patientId, tabId = null) {
            console.log(`üîó Loading patient: ${patientId}, tab: ${tabId}`);
            
            if (patientId && patientId !== currentPatientId) {
                currentPatientId = patientId;
                loadPatientData();
                
                // Update URL without reloading page
                const newUrl = new URL(window.location);
                newUrl.searchParams.set('patient', patientId);
                if (tabId) {
                    newUrl.searchParams.set('tab', tabId);
                }
                window.history.pushState({}, '', newUrl);
            }
            
            // Switch to requested tab if specified
            if (tabId && tabNavigation) {
                setTimeout(() => {
                    tabNavigation.switchTab(tabId);
                }, 200);
            }
        }

        // Export loadPatient function for external use
        window.patientDetailsManager = {
            loadPatient: loadPatient,
            getCurrentPatientId: () => currentPatientId,
            patients: () => window.sampleData?.patients || [],
            savePatientToStorage: function() {
                if (!this.currentPatient) return;
                
                try {
                    // Save to localStorage
                    let patients = JSON.parse(localStorage.getItem('patients') || '[]');
                    const existingIndex = patients.findIndex(p => p.id === this.currentPatient.id);
                    
                    if (existingIndex >= 0) {
                        patients[existingIndex] = this.currentPatient;
                    } else {
                        patients.push(this.currentPatient);
                    }
                    
                    localStorage.setItem('patients', JSON.stringify(patients));
                    
                    // Also update sample data if available
                    if (window.sampleData && window.sampleData.patients) {
                        const sampleIndex = window.sampleData.patients.findIndex(p => p.id === this.currentPatient.id);
                        if (sampleIndex >= 0) {
                            window.sampleData.patients[sampleIndex] = this.currentPatient;
                        }
                    }
                    
                    console.log('‚úÖ Patient data saved to storage');
                } catch (error) {
                    console.error('‚ùå Error saving patient to storage:', error);
                }
            }
        };

        function loadPatientData() {
            console.log('üîÑ Loading patient data for ID:', currentPatientId);
            
            // Load patient data from sample data or use default
            let patientData = null;
            
            // Try to find patient in sample data
            if (window.sampleData && window.sampleData.patients) {
                console.log(`üìä Found ${window.sampleData.patients.length} patients in sample data`);
                patientData = window.sampleData.patients.find(p => p.id === currentPatientId);
                if (patientData) {
                    console.log('‚úÖ Found patient in sample data:', patientData.name);
                }
            }
            
            // Try to find in global patient database if not found
            if (!patientData && window.patientDatabase && Array.isArray(window.patientDatabase)) {
                console.log(`üìä Checking global patient database: ${window.patientDatabase.length} patients`);
                patientData = window.patientDatabase.find(p => p.id === currentPatientId);
                if (patientData) {
                    console.log('‚úÖ Found patient in global database:', patientData.name);
                }
            }
            
            // Try to find in localStorage patients
            if (!patientData) {
                try {
                    const localPatients = JSON.parse(localStorage.getItem('patients') || '[]');
                    console.log(`üìä Checking localStorage: ${localPatients.length} patients`);
                    patientData = localPatients.find(p => p.id === currentPatientId);
                    if (patientData) {
                        console.log('‚úÖ Found patient in localStorage:', patientData.name || `${patientData.firstName} ${patientData.lastName}`);
                    }
                } catch (error) {
                    console.warn('Error checking localStorage patients:', error);
                }
            }
            
            if (!patientData) {
                console.log('‚ö†Ô∏è Patient not found in any data source, using default');
            }
            
            // Use default data if patient not found
            if (!patientData) {
                patientData = {
                    id: currentPatientId,
                    name: 'Bilinmeyen Hasta',
                    firstName: 'Bilinmeyen',
                    lastName: 'Hasta',
                    tcNumber: 'Bilinmiyor',
                    tc: 'Bilinmiyor',
                    phone: 'Bilinmiyor',
                    email: 'Bilinmiyor',
                    birthDate: '1980-01-01',
                    address: 'Bilinmiyor',
                    status: 'Aktif',
                    segment: 'Deneme',
                    sgkStatus: 'SGK Onaylƒ±',
                    lastVisit: '15 Ocak 2024',
                    notes: 'Sol kulak i≈üitme kaybƒ±, deneme cihazƒ± kullanƒ±yor',
                    eReceiptNo: ''
                };
            }

            // Ensure data consistency - synchronize all name and TC fields
            if (patientData.firstName && patientData.lastName) {
                patientData.name = `${patientData.firstName} ${patientData.lastName}`;
            } else if (patientData.name) {
                const nameParts = patientData.name.split(' ');
                if (nameParts.length > 1) {
                    patientData.firstName = nameParts[0];
                    patientData.lastName = nameParts.slice(1).join(' ');
                } else {
                    patientData.firstName = patientData.name;
                    patientData.lastName = '';
                }
            }

            // Synchronize TC fields
            if (patientData.tcNumber) {
                patientData.tc = patientData.tcNumber;
            } else if (patientData.tc) {
                patientData.tcNumber = patientData.tc;
            }

            // Calculate age if birthDate exists
            if (patientData.birthDate) {
                patientData.age = Utils.calculateAge(patientData.birthDate);
            }

            // Store patient data in global manager for document naming
            if (!window.patientDetailsManager) {
                window.patientDetailsManager = {};
            }
            window.patientDetailsManager.currentPatient = patientData;
            console.log('‚úÖ Patient data stored in global manager:', patientData.name);

            // Recreate patient profile with actual data
            if (patientProfile) {
                // Debug i√ßin konsola yazdƒ±r
                console.log('loadPatientData - patientData:', patientData);
                
                patientProfile = new PatientProfileWidget('patient-profile-container', patientData);
                window.patientProfile = patientProfile; // Make it globally accessible
                patientProfile.render();
            }
            
            // Load tab-specific data
            loadPersonalInfo(patientData);
            loadAppointments();
            loadDevices();
            loadNotes();
            loadQuickNotes(); // Load notes for the Genel tab
            loadSGKInfo();
            loadTimeline();
        }

        function loadPatientData() {
            console.log('üîÑ Loading patient data for ID:', currentPatientId);
            
            // Load patient data from sample data or use default
            let patientData = null;
            
            // Try to find patient in sample data
            if (window.sampleData && window.sampleData.patients) {
                console.log(`üìä Found ${window.sampleData.patients.length} patients in sample data`);
                patientData = window.sampleData.patients.find(p => p.id === currentPatientId);
                if (patientData) {
                    console.log('‚úÖ Found patient in sample data:', patientData.name);
                }
            }
            
            // Try to find in global patient database if not found
            if (!patientData && window.patientDatabase && Array.isArray(window.patientDatabase)) {
                console.log(`üìä Checking global patient database: ${window.patientDatabase.length} patients`);
                patientData = window.patientDatabase.find(p => p.id === currentPatientId);
                if (patientData) {
                    console.log('‚úÖ Found patient in global database:', patientData.name);
                }
            }
            
            // Try to find in localStorage patients
            if (!patientData) {
                try {
                    const localPatients = JSON.parse(localStorage.getItem('patients') || '[]');
                    console.log(`üìä Checking localStorage: ${localPatients.length} patients`);
                    patientData = localPatients.find(p => p.id === currentPatientId);
                    if (patientData) {
                        console.log('‚úÖ Found patient in localStorage:', patientData.name || `${patientData.firstName} ${patientData.lastName}`);
                    }
                } catch (error) {
                    console.warn('Error checking localStorage patients:', error);
                }
            }
            
            if (!patientData) {
                console.log('‚ö†Ô∏è Patient not found in any data source, using default');
            }
            
            // Use default data if patient not found
            if (!patientData) {
                patientData = {
                    id: currentPatientId,
                    name: 'Bilinmeyen Hasta',
                    firstName: 'Bilinmeyen',
                    lastName: 'Hasta',
                    tcNumber: 'Bilinmiyor',
                    tc: 'Bilinmiyor',
                    phone: 'Bilinmiyor',
                    email: 'Bilinmiyor',
                    birthDate: '1980-01-01',
                    address: 'Bilinmiyor',
                    status: 'Aktif',
                    segment: 'Deneme',
                    sgkStatus: 'SGK Onaylƒ±',
                    lastVisit: '15 Ocak 2024',
                    notes: 'Sol kulak i≈üitme kaybƒ±, deneme cihazƒ± kullanƒ±yor',
                    eReceiptNo: ''
                };
            }

            // Ensure data consistency - synchronize all name and TC fields
            if (patientData.firstName && patientData.lastName) {
                patientData.name = `${patientData.firstName} ${patientData.lastName}`;
            } else if (patientData.name) {
                const nameParts = patientData.name.split(' ');
                if (nameParts.length > 1) {
                    patientData.firstName = nameParts[0];
                    patientData.lastName = nameParts.slice(1).join(' ');
                } else {
                    patientData.firstName = patientData.name;
                    patientData.lastName = '';
                }
            }

            // Synchronize TC fields
            if (patientData.tcNumber) {
                patientData.tc = patientData.tcNumber;
            } else if (patientData.tc) {
                patientData.tcNumber = patientData.tc;
            }

            // Calculate age if birthDate exists
            if (patientData.birthDate) {
                patientData.age = Utils.calculateAge(patientData.birthDate);
            }

            // Store patient data in global manager for document naming
            if (!window.patientDetailsManager) {
                window.patientDetailsManager = {};
            }
            window.patientDetailsManager.currentPatient = patientData;
            console.log('‚úÖ Patient data stored in global manager:', patientData.name);

            // Recreate patient profile with actual data
            if (patientProfile) {
                // Debug i√ßin konsola yazdƒ±r
                console.log('loadPatientData - patientData:', patientData);
                
                patientProfile = new PatientProfileWidget('patient-profile-container', patientData);
                window.patientProfile = patientProfile; // Make it globally accessible
                patientProfile.render();
            }
            
            // Load tab-specific data
            loadPersonalInfo(patientData);
            loadAppointments();
            loadDevices();
            loadNotes();
            loadQuickNotes(); // Load notes for the Genel tab
            loadSGKInfo();
            loadTimeline();
        }

        function loadPersonalInfo(patientData) {
            const personalInfoContainer = document.getElementById('personalInfo');
            if (personalInfoContainer) {
                // TC ve ya≈ü bilgilerini uyumlu hale getir ve senkronize et
                const tcNumber = patientData.tc || patientData.tcNumber || '';
                // Her iki alanƒ± da g√ºncelle
                patientData.tc = tcNumber;
                patientData.tcNumber = tcNumber;
                
                const age = patientData.age || (patientData.birthDate ? Utils.calculateAge(patientData.birthDate) : '');
                const phone = patientData.phone || '';
                
                // Ya≈ü bilgisini de g√ºncelle
                if (patientData.birthDate && !patientData.age) {
                    patientData.age = age;
                }
                
                // Debug i√ßin konsola yazdƒ±r
                console.log('loadPersonalInfo:', {
                    name: patientData.name,
                    tc: patientData.tc,
                    tcNumber: patientData.tcNumber,
                    phone: patientData.phone,
                    age: age
                });
                
                personalInfoContainer.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Ad Soyad:</span>
                            <span class="font-medium">${patientData.name}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">TC Kimlik:</span>
                            <span class="font-medium">${tcNumber}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Telefon:</span>
                            <span class="font-medium">${phone}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">E-posta:</span>
                            <span class="font-medium">${patientData.email}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Doƒüum Tarihi:</span>
                            <span class="font-medium">${patientData.birthDate}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Ya≈ü:</span>
                            <span class="font-medium">${age}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Adres:</span>
                            <span class="font-medium">${patientData.address}</span>
                        </div>
                    </div>
                `;
                
                // PatientProfileWidget'ƒ± da g√ºncelle eƒüer varsa
                if (window.patientProfile && window.patientProfile.updatePatientData) {
                    window.patientProfile.updatePatientData({
                        name: patientData.name,
                        tc: tcNumber,
                        tcNumber: tcNumber,
                        phone: phone,
                        birthDate: patientData.birthDate,
                        email: patientData.email,
                        address: patientData.address,
                        status: patientData.status,
                        segment: patientData.segment,
                        sgkStatus: patientData.sgkStatus,
                        lastVisit: patientData.lastVisit,
                        age: age
                    });
                }
            }
        }

        // TC Kimlik No doƒürulama fonksiyonu
        // All validation and modal-related functions have been moved to patient-details-modals.js
        // All validation and modal-related functions have been moved to patient-details-modals.js

        // All validation and modal-related functions have been moved to patient-details-modals.js

        // All validation and modal-related functions have been moved to patient-details-modals.js

        // All validation and modal-related functions have been moved to patient-details-modals.js

        // All validation and modal-related functions have been moved to patient-details-modals.js

        // Function to calculate total amount based on quantity, unit price, and tax
        // All validation and modal-related functions have been moved to patient-details-modals.js

        // All validation and modal-related functions have been moved to patient-details-modals.js
        
        // Helper function to get device options for a patient
        function getDeviceOptionsForPatient(patientId) {
            if (!window.patientDetailsManager || !window.patientDetailsManager.devices) {
                return '';
            }
            
            const patientDevices = window.patientDetailsManager.devices.filter(device => device.patientId === patientId);
            
            if (patientDevices.length === 0) {
                return '<option value="" disabled>Bu hasta i√ßin cihaz bulunamadƒ±</option>';
            }
            
            return patientDevices.map(device => {
                const manufacturer = device.manufacturer.charAt(0).toUpperCase() + device.manufacturer.slice(1);
                const direction = device.direction === 'left' ? 'Sol' : device.direction === 'right' ? 'Saƒü' : 'Bilateral';
                return `<option value="${device.id}">${manufacturer} - ${device.model} (${direction})</option>`;
            }).join('');
        }

        function uploadDocument() {
            // Get the current patient data
            const patient = window.patientDetailsManager?.currentPatient || {};
            
            // Create modal content
            const modalContent = `
                <div class="space-y-4">
                    <div>
                        <label for="documentTitle" class="block text-sm font-medium text-gray-700">Belge Ba≈ülƒ±ƒüƒ±</label>
                        <input type="text" id="documentTitle" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Belge ba≈ülƒ±ƒüƒ±..." />
                    </div>
                    <div>
                        <label for="documentType" class="block text-sm font-medium text-gray-700">Belge Tipi</label>
                        <select id="documentType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                            <option value="sgk_report">SGK Raporu</option>
                            <option value="hearing_test">ƒ∞≈üitme Testi</option>
                            <option value="prescription">Re√ßete</option>
                            <option value="invoice">Fatura</option>
                            <option value="id_card">Kimlik Belgesi</option>
                            <option value="other">Diƒüer</option>
                        </select>
                    </div>
                    <div>
                        <label for="documentDate" class="block text-sm font-medium text-gray-700">Belge Tarihi</label>
                        <input type="date" id="documentDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Belge Dosyasƒ±</label>
                        <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                            <div class="space-y-1 text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <div class="flex text-sm text-gray-600">
                                    <label for="documentFile" class="relative cursor-pointer bg-white rounded-md font-medium text-primary hover:text-primary-dark focus-within:outline-none">
                                        <span>Dosya se√ßin</span>
                                        <input id="documentFile" name="documentFile" type="file" class="sr-only" />
                                    </label>
                                    <p class="pl-1">veya s√ºr√ºkleyip bƒ±rakƒ±n</p>
                                </div>
                                <p class="text-xs text-gray-500">PNG, JPG, PDF (max. 10MB)</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="documentNotes" class="block text-sm font-medium text-gray-700">Notlar</label>
                        <textarea id="documentNotes" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Belge ile ilgili notlar..."></textarea>
                    </div>
                </div>
            `;
            
            // Show modal
            Utils.showModal({
                title: 'Belge Y√ºkle',
                content: modalContent,
                primaryButton: {
                    text: 'Y√ºkle',
                    onClick: () => {
                        // Get form values
                        const title = document.getElementById('documentTitle').value;
                        const type = document.getElementById('documentType').value;
                        const date = document.getElementById('documentDate').value;
                        const notes = document.getElementById('documentNotes').value;
                        const fileInput = document.getElementById('documentFile');
                        
                        if (!title || !type || !date) {
                            Utils.showToast('L√ºtfen t√ºm gerekli alanlarƒ± doldurun', 'error');
                            return;
                        }
                        
                        if (!fileInput.files || fileInput.files.length === 0) {
                            Utils.showToast('L√ºtfen bir dosya se√ßin', 'error');
                            return;
                        }
                        
                        const file = fileInput.files[0];
                        if (file.size > 10 * 1024 * 1024) { // 10MB
                            Utils.showToast('Dosya boyutu 10MB\'dan b√ºy√ºk olamaz', 'error');
                            return;
                        }
                        
                        // In a real application, we would upload the file to a server here
                        // For this demo, we'll simulate a successful upload
                        
                        // Create new document
                        const newDocument = {
                            id: 'doc_' + Date.now(),
                            patientId: patient.id,
                            title: title,
                            type: type,
                            date: date,
                            notes: notes,
                            fileName: file.name,
                            fileSize: file.size,
                            fileType: file.type,
                            uploadDate: new Date().toISOString(),
                            url: '#' // In a real app, this would be the URL to the uploaded file
                        };
                        
                        // Add document to patient
                        if (window.patientDetailsManager) {
                            // Initialize documents array if it doesn't exist
                            if (!window.patientDetailsManager.documents) {
                                window.patientDetailsManager.documents = [];
                            }
                            
                            // Add new document
                            window.patientDetailsManager.documents.push(newDocument);
                            window.patientDetailsManager.savePatientToStorage();
                            
                            // Refresh documents display if available
                            if (typeof loadDocuments === 'function') {
                                loadDocuments();
                            }
                            
                            // Update timeline
                            if (typeof loadTimeline === 'function') {
                                loadTimeline();
                            }
                            
                            Utils.showToast('Belge ba≈üarƒ±yla y√ºklendi', 'success');
                        } else {
                            Utils.showToast('Belge y√ºklenemedi', 'error');
                        }
                    }
                },
                secondaryButton: {
                    text: 'ƒ∞ptal',
                    onClick: () => {}
                }
            });
            
            // Add event listener for file input
            setTimeout(() => {
                const fileInput = document.getElementById('documentFile');
                if (fileInput) {
                    fileInput.addEventListener('change', function() {
                        if (this.files && this.files.length > 0) {
                            const fileName = this.files[0].name;
                            const fileSize = (this.files[0].size / 1024).toFixed(2) + ' KB';
                            const fileInfo = document.createElement('p');
                            fileInfo.className = 'text-xs text-gray-700 mt-2';
                            fileInfo.textContent = `Se√ßilen dosya: ${fileName} (${fileSize})`;
                            
                            // Remove previous file info if exists
                            const previousFileInfo = this.parentElement.parentElement.parentElement.querySelector('.text-gray-700');
                            if (previousFileInfo) {
                                previousFileInfo.remove();
                            }
                            
                            this.parentElement.parentElement.parentElement.appendChild(fileInfo);
                        }
                    });
                }
            }, 100);
        }

        // All validation and modal-related functions have been moved to patient-details-modals.js

        function loadAppointments() {
            const appointmentsContainer = document.getElementById('appointments-content');
            if (!appointmentsContainer) {
                console.warn('Appointments container not found');
                return;
            }
            
            try {
                // Get patient appointments
                const patient = window.patientDetailsManager?.currentPatient || {};
                const patientId = patient.id || currentPatientId;
                
                // Get appointments from sample data or localStorage
                let appointments = [];
                
                // Try to get from global sample data first
                if (window.sampleData && window.sampleData.appointments) {
                    appointments = window.sampleData.appointments.filter(apt => apt.patientId === patientId);
                }
                
                // Also check patient's own appointments array
                if (patient.appointments && Array.isArray(patient.appointments)) {
                    appointments = [...appointments, ...patient.appointments];
                }
                
                // Remove duplicates based on id
                appointments = appointments.filter((apt, index, self) => 
                    index === self.findIndex(a => a.id === apt.id)
                );
                
                if (appointments.length === 0) {
                    appointmentsContainer.innerHTML = `
                        <div class="text-center py-12">
                            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">Hen√ºz randevu bulunmuyor</h3>
                            <p class="text-gray-600 mb-4">Bu hasta i√ßin kayƒ±tlƒ± randevu bulunmamaktadƒ±r.</p>
                            <button onclick="addAppointment('${patientId}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                                Yeni Randevu Ekle
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // Sort appointments by date (newest first)
                appointments.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Create appointments table
                const appointmentsHTML = `
                    <div class="mb-4 flex justify-between items-center">
                        <h4 class="text-lg font-semibold text-gray-900">Randevu Ge√ßmi≈üi</h4>
                        <button onclick="addAppointment('${patientId}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            Yeni Randevu
                        </button>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tarih</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Saat</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">T√ºr</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Durum</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notlar</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ƒ∞≈ülemler</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${appointments.map(appointment => {
                                    const date = new Date(appointment.date);
                                    const formattedDate = date.toLocaleDateString('tr-TR');
                                    const formattedTime = appointment.time || date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                                    
                                    const getStatusBadge = (status) => {
                                        switch (status) {
                                            case 'completed':
                                                return '<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Tamamlandƒ±</span>';
                                            case 'cancelled':
                                                return '<span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">ƒ∞ptal</span>';
                                            case 'no-show':
                                                return '<span class="px-2 py-1 text-xs font-medium bg-orange-100 text-orange-800 rounded-full">Gelmedi</span>';
                                            case 'scheduled':
                                            default:
                                                return '<span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">Planlandƒ±</span>';
                                        }
                                    };
                                    
                                    return `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formattedDate}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formattedTime}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${appointment.type || 'Genel Muayene'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">${getStatusBadge(appointment.status)}</td>
                                            <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">${appointment.notes || '-'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                <button onclick="editAppointment('${appointment.id}')" class="text-blue-600 hover:text-blue-900 mr-2">D√ºzenle</button>
                                                <button onclick="cancelAppointment('${appointment.id}')" class="text-red-600 hover:text-red-900">ƒ∞ptal</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                appointmentsContainer.innerHTML = appointmentsHTML;
                console.log('‚úÖ Appointments loaded successfully:', appointments.length);
                
            } catch (error) {
                console.error('‚ùå Error loading appointments:', error);
                appointmentsContainer.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <p class="mb-2">Randevular y√ºklenirken bir hata olu≈ütu.</p>
                        <button onclick="loadAppointments()" class="text-blue-600 hover:text-blue-800 font-medium">Tekrar Dene</button>
                    </div>
                `;
            }
        }

        function loadDevices() {
            const devicesContainer = document.getElementById('devices-content');
            if (!devicesContainer) {
                console.warn('Devices container not found');
                return;
            }
            
            try {
                // Get patient device information
                const patient = window.patientDetailsManager?.currentPatient || {};
                const patientId = patient.id || currentPatientId;
                
                // Get devices from multiple sources
                let devices = [];
                
                // Check patient's own devices array
                if (patient.devices && Array.isArray(patient.devices)) {
                    devices = [...patient.devices];
                }
                
                // Also check global device assignments
                if (window.patientDetailsManager?.devices) {
                    const assignedDevices = window.patientDetailsManager.devices.filter(device => device.patientId === patientId);
                    devices = [...devices, ...assignedDevices];
                }
                
                // Remove duplicates based on id
                devices = devices.filter((device, index, self) => 
                    index === self.findIndex(d => d.id === device.id)
                );
                
                // Get device trials
                let deviceTrials = [];
                if (patient.deviceTrials && Array.isArray(patient.deviceTrials)) {
                    deviceTrials = patient.deviceTrials;
                }
                
                const devicesHTML = `
                    <div class="space-y-6">
                        <!-- Current Devices Section -->
                        <div class="bg-white rounded-lg border border-gray-200 p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-lg font-semibold text-gray-900">Mevcut Cihazlar</h4>
                                <button onclick="assignDevice('${patientId}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                    </svg>
                                    Cihaz Ata
                                </button>
                            </div>
                            
                            ${devices.length === 0 ? `
                                <div class="text-center py-8">
                                    <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                    </svg>
                                    <h3 class="text-lg font-medium text-gray-900 mb-2">Hen√ºz cihaz atanmamƒ±≈ü</h3>
                                    <p class="text-gray-600">Bu hastaya hen√ºz bir i≈üitme cihazƒ± atanmamƒ±≈ütƒ±r.</p>
                                </div>
                            ` : `
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    ${devices.map(device => {
                                        const assignmentDate = device.assignmentDate ? new Date(device.assignmentDate).toLocaleDateString('tr-TR') : 'Bilinmiyor';
                                        const warrantyEnd = device.warrantyEndDate ? new Date(device.warrantyEndDate).toLocaleDateString('tr-TR') : 'Bilinmiyor';
                                        const direction = device.direction === 'left' ? 'Sol Kulak' : device.direction === 'right' ? 'Saƒü Kulak' : 'Bilateral';
                                        
                                        return `
                                            <div class="border border-gray-200 rounded-lg p-4">
                                                <div class="flex justify-between items-start mb-3">
                                                    <h5 class="font-medium text-gray-900">${device.manufacturer || device.brand} ${device.model}</h5>
                                                    <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Aktif</span>
                                                </div>
                                                <div class="space-y-2 text-sm text-gray-600">
                                                    <div class="flex justify-between">
                                                        <span>Konum:</span>
                                                        <span class="font-medium text-gray-900">${direction}</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span>Seri No:</span>
                                                        <span class="font-medium text-gray-900">${device.serialNumber || 'Belirtilmemi≈ü'}</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span>Atanma Tarihi:</span>
                                                        <span class="font-medium text-gray-900">${assignmentDate}</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span>Garanti Biti≈ü:</span>
                                                        <span class="font-medium text-gray-900">${warrantyEnd}</span>
                                                    </div>
                                                </div>
                                                <div class="mt-3 flex space-x-2">
                                                    <button onclick="editDevice('${device.id}')" class="text-blue-600 hover:text-blue-900 text-sm font-medium">D√ºzenle</button>
                                                    <button onclick="deviceMaintenance('${device.id}')" class="text-green-600 hover:text-green-900 text-sm font-medium">Bakƒ±m</button>
                                                    <button onclick="removeDevice('${device.id}')" class="text-red-600 hover:text-red-900 text-sm font-medium">Kaldƒ±r</button>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `}
                        </div>
                        
                        <!-- Device Trials Section -->
                        <div class="bg-white rounded-lg border border-gray-200 p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-lg font-semibold text-gray-900">Cihaz Denemeleri</h4>
                                <button onclick="startDeviceTrial('${patientId}')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                    </svg>
                                    Yeni Deneme
                                </button>
                            </div>
                            
                            ${deviceTrials.length === 0 ? `
                                <div class="text-center py-6">
                                    <p class="text-gray-500">Hen√ºz cihaz denemesi yapƒ±lmamƒ±≈ü.</p>
                                </div>
                            ` : `
                                <div class="space-y-3">
                                    ${deviceTrials.map(trial => {
                                        const startDate = trial.startDate ? new Date(trial.startDate).toLocaleDateString('tr-TR') : 'Bilinmiyor';
                                        const endDate = trial.endDate ? new Date(trial.endDate).toLocaleDateString('tr-TR') : 'Devam ediyor';
                                        const duration = trial.startDate && trial.endDate ? 
                                            Math.ceil((new Date(trial.endDate) - new Date(trial.startDate)) / (1000 * 60 * 60 * 24)) + ' g√ºn' : 
                                            'Devam ediyor';
                                        
                                        const getStatusBadge = (status) => {
                                            switch (status) {
                                                case 'completed':
                                                    return '<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Tamamlandƒ±</span>';
                                                case 'cancelled':
                                                    return '<span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">ƒ∞ptal</span>';
                                                case 'active':
                                                default:
                                                    return '<span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">Aktif</span>';
                                            }
                                        };
                                        
                                        return `
                                            <div class="border border-gray-200 rounded-lg p-4">
                                                <div class="flex justify-between items-start mb-2">
                                                    <h6 class="font-medium text-gray-900">${trial.deviceName || 'Cihaz Denemesi'}</h6>
                                                    ${getStatusBadge(trial.status)}
                                                </div>
                                                <div class="grid grid-cols-3 gap-4 text-sm text-gray-600">
                                                    <div>
                                                        <span class="block text-gray-500">Ba≈ülangƒ±√ß:</span>
                                                        <span class="font-medium text-gray-900">${startDate}</span>
                                                    </div>
                                                    <div>
                                                        <span class="block text-gray-500">Biti≈ü:</span>
                                                        <span class="font-medium text-gray-900">${endDate}</span>
                                                    </div>
                                                    <div>
                                                        <span class="block text-gray-500">S√ºre:</span>
                                                        <span class="font-medium text-gray-900">${duration}</span>
                                                    </div>
                                                </div>
                                                ${trial.notes ? `
                                                    <div class="mt-2">
                                                        <span class="block text-gray-500 text-sm">Notlar:</span>
                                                        <p class="text-sm text-gray-700">${trial.notes}</p>
                                                    </div>
                                                ` : ''}
                                                <div class="mt-3 flex space-x-2">
                                                    <button onclick="editDeviceTrial('${trial.id}')" class="text-blue-600 hover:text-blue-900 text-sm font-medium">D√ºzenle</button>
                                                    ${trial.status === 'active' ? 
                                                        `<button onclick="completeDeviceTrial('${trial.id}')" class="text-green-600 hover:text-green-900 text-sm font-medium">Tamamla</button>` : 
                                                        ''}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;
                
                devicesContainer.innerHTML = devicesHTML;
                console.log('‚úÖ Devices loaded successfully:', devices.length, 'devices,', deviceTrials.length, 'trials');
                
            } catch (error) {
                console.error('‚ùå Error loading devices:', error);
                devicesContainer.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <p class="mb-2">Cihaz bilgileri y√ºklenirken bir hata olu≈ütu.</p>
                        <button onclick="loadDevices()" class="text-blue-600 hover:text-blue-800 font-medium">Tekrar Dene</button>
                    </div>
                `;
            }
        }

        function loadNotes() {
            loadQuickNotes(); // Load notes in the quick notes section
        }

        function loadQuickNotes() {
            const quickNotesContainer = document.getElementById('quickNotes');
            if (!quickNotesContainer) {
                console.warn('Quick notes container not found');
                return;
            }
            
            try {
                // Get patient notes with proper error handling
                const patient = window.patientDetailsManager?.currentPatient || {};
                let notes = [];
                
                // Safely get notes array
                if (patient.notes && Array.isArray(patient.notes)) {
                    notes = patient.notes;
                } else if (patient.notes && typeof patient.notes === 'string') {
                    // Handle legacy single note format
                    notes = [{
                        id: 'legacy_note_' + Date.now(),
                        title: 'Hasta Notu',
                        content: patient.notes,
                        type: 'general',
                        date: new Date().toISOString(),
                        createdBy: 'Sistem'
                    }];
                }
                
                if (notes.length === 0) {
                    quickNotesContainer.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <p>Hen√ºz not eklenmemi≈ü</p>
                            <p class="text-sm">Yeni not eklemek i√ßin yukarƒ±daki butonu kullanƒ±n</p>
                        </div>
                    `;
                    return;
                }
                
                // Sort notes by date (newest first) with error handling
                const sortedNotes = notes.sort((a, b) => {
                    try {
                        const dateA = new Date(a.date || a.createdAt || Date.now());
                        const dateB = new Date(b.date || b.createdAt || Date.now());
                        return dateB - dateA;
                    } catch (error) {
                        console.warn('Error sorting notes by date:', error);
                        return 0;
                    }
                });
                
                // Take only the latest 5 notes for quick view
                const recentNotes = sortedNotes.slice(0, 5);
                
                const notesHTML = recentNotes.map(note => {
                    try {
                        // Safe date handling
                        let formattedDate = 'Tarih belirtilmemi≈ü';
                        let formattedTime = '';
                        
                        if (note.date || note.createdAt) {
                            const noteDate = new Date(note.date || note.createdAt);
                            if (!isNaN(noteDate.getTime())) {
                                formattedDate = noteDate.toLocaleDateString('tr-TR', { 
                                    day: '2-digit', 
                                    month: 'short',
                                    year: 'numeric'
                                });
                                formattedTime = noteDate.toLocaleTimeString('tr-TR', { 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                });
                            }
                        }
                        
                        // Get note type color with fallback
                        const getTypeColor = (type) => {
                            const colors = {
                                'call': 'bg-blue-100 text-blue-800',
                                'visit': 'bg-green-100 text-green-800',
                                'trial': 'bg-purple-100 text-purple-800',
                                'follow-up': 'bg-yellow-100 text-yellow-800',
                                'general': 'bg-gray-100 text-gray-800'
                            };
                            return colors[type] || colors['general'];
                        };
                        
                        const getTypeName = (type) => {
                            const names = {
                                'call': 'Telefon',
                                'visit': 'Ziyaret',
                                'trial': 'Deneme',
                                'follow-up': 'Kontrol',
                                'general': 'Genel'
                            };
                            return names[type] || 'Genel';
                        };
                        
                        // Safe content extraction
                        const title = note.title || note.subject || 'Not';
                        const content = note.content || note.text || note.message || 'ƒ∞√ßerik belirtilmemi≈ü';
                        const createdBy = note.createdBy || note.author || 'Sistem';
                        const noteType = note.type || 'general';
                        
                        return `
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-medium text-gray-900 text-sm line-clamp-1">${title}</h4>
                                    <div class="flex flex-col items-end">
                                        <span class="text-xs text-gray-500">${formattedDate}</span>
                                        ${formattedTime ? `<span class="text-xs text-gray-500">${formattedTime}</span>` : ''}
                                    </div>
                                </div>
                                <p class="text-sm text-gray-700 mb-2 line-clamp-2">${content}</p>
                                <div class="flex justify-between items-center">
                                    <span class="px-2 py-1 text-xs font-medium rounded-full ${getTypeColor(noteType)}">
                                        ${getTypeName(noteType)}
                                    </span>
                                    <span class="text-xs text-gray-500">${createdBy}</span>
                                </div>
                            </div>
                        `;
                    } catch (error) {
                        console.warn('Error rendering note:', error, note);
                        return `
                            <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                                <p class="text-sm text-red-600">Bu not g√∂r√ºnt√ºlenirken bir hata olu≈ütu.</p>
                            </div>
                        `;
                    }
                }).join('');
                
                quickNotesContainer.innerHTML = `
                    ${notesHTML}
                    ${notes.length > 5 ? `
                        <div class="text-center pt-3">
                            <button onclick="tabNavigation.switchTab('timeline')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                T√ºm notlarƒ± g√∂ster (${notes.length - 5} daha)
                            </button>
                        </div>
                    ` : ''}
                `;
                
                console.log('‚úÖ Quick notes loaded successfully:', recentNotes.length, 'of', notes.length, 'total notes');
                
            } catch (error) {
                console.error('‚ùå Error loading quick notes:', error);
                quickNotesContainer.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <p class="mb-2">Notlar y√ºklenirken bir hata olu≈ütu.</p>
                        <button onclick="loadQuickNotes()" class="text-blue-600 hover:text-blue-800 font-medium">Tekrar Dene</button>
                    </div>
                `;
            }
        }

        function loadSGKInfo() {
            const sgkInfo = document.getElementById('sgkInfo');
            if (!sgkInfo) {
                console.warn('SGK info container not found');
                return;
            }
            
            try {
                // Get patient SGK information
                const patient = window.patientDetailsManager?.currentPatient || {};
                const patientId = patient.id || currentPatientId;
                
                // Get SGK data from SGK manager or patient data
                let sgkData = {};
                if (window.sgkManager) {
                    sgkData = window.sgkManager.getPatientSGKInfo(patientId);
                } else if (patient.sgkInfo) {
                    sgkData = patient.sgkInfo;
                }
                
                // Default SGK values if no data exists
                const sgkStatus = sgkData.status || patient.sgkStatus || 'pending';
                const reportDate = sgkData.reportDate || sgkData.lastReportDate || '05 Ocak 2024';
                const reportNo = sgkData.reportNo || `SGK-2024-${patientId?.slice(-6) || '001234'}`;
                const validityPeriod = sgkData.validityPeriod || '2 Yƒ±l';
                const contributionAmount = sgkData.contributionAmount || 1500;
                const sgkCoverage = sgkData.sgkCoverage || 8500;
                const totalAmount = contributionAmount + sgkCoverage;
                
                // Get status display info
                const getStatusInfo = (status) => {
                    switch (status) {
                        case 'approved':
                        case 'active':
                            return { text: 'Onaylƒ±', class: 'status-badge status-active', color: 'green' };
                        case 'pending':
                            return { text: 'Beklemede', class: 'status-badge status-pending', color: 'yellow' };
                        case 'expired':
                            return { text: 'S√ºresi Dolmu≈ü', class: 'status-badge status-expired', color: 'red' };
                        case 'rejected':
                            return { text: 'Reddedildi', class: 'status-badge status-rejected', color: 'red' };
                        default:
                            return { text: 'Bilinmiyor', class: 'status-badge status-pending', color: 'gray' };
                    }
                };
                
                const statusInfo = getStatusInfo(sgkStatus);
                
                sgkInfo.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- SGK Status Information -->
                        <div class="space-y-4">
                            <h5 class="font-medium text-gray-900">SGK Durum Bilgileri</h5>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">SGK Durumu:</span>
                                    <span class="${statusInfo.class}">${statusInfo.text}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Rapor Tarihi:</span>
                                    <span class="font-medium">${reportDate}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Rapor No:</span>
                                    <span class="font-medium">${reportNo}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Ge√ßerlilik:</span>
                                    <span class="font-medium">${validityPeriod}</span>
                                </div>
                                ${sgkData.validityDate ? `
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Ge√ßerlilik Tarihi:</span>
                                        <span class="font-medium">${new Date(sgkData.validityDate).toLocaleDateString('tr-TR')}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- Financial Information -->
                        <div class="space-y-4">
                            <h5 class="font-medium text-gray-900">Mali Bilgiler</h5>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Katkƒ± Payƒ±:</span>
                                    <span class="font-medium">‚Ç∫${contributionAmount.toLocaleString('tr-TR')}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">SGK Kar≈üƒ±lama:</span>
                                    <span class="font-medium">‚Ç∫${sgkCoverage.toLocaleString('tr-TR')}</span>
                                </div>
                                <div class="flex justify-between border-t pt-2">
                                    <span class="text-gray-600 font-medium">Toplam Tutar:</span>
                                    <span class="font-bold text-lg">‚Ç∫${totalAmount.toLocaleString('tr-TR')}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Saved E-Prescriptions Section -->
                    ${patient.ereceiptHistory && patient.ereceiptHistory.length > 0 ? `
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <h5 class="font-medium text-gray-900 mb-4">Kaydedilen E-Re√ßeteler</h5>
                            <div class="space-y-4">
                                ${patient.ereceiptHistory.map(receipt => `
                                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                        <div class="flex justify-between items-start mb-3">
                                            <div>
                                                <h6 class="font-medium text-blue-900">E-Re√ßete #${receipt.number}</h6>
                                                <p class="text-sm text-blue-700">${receipt.doctorName}</p>
                                                <p class="text-sm text-blue-600">${new Date(receipt.date).toLocaleDateString('tr-TR')}</p>
                                            </div>
                                            <span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded">Kaydedildi</span>
                                        </div>
                                        <div class="space-y-2">
                                            <h7 class="text-sm font-medium text-gray-700">Malzemeler:</h7>
                                            ${receipt.materials.map(material => `
                                                <div class="flex justify-between items-center bg-white p-3 rounded border">
                                                    <div class="flex-1">
                                                        <p class="text-sm font-medium text-gray-900">${material.name}</p>
                                                        <p class="text-xs text-gray-600">Kod: ${material.code}</p>
                                                        <p class="text-xs text-gray-600">Ba≈üvuru Tarihi: ${new Date(material.applicationDate).toLocaleDateString('tr-TR')}</p>
                                                    </div>
                                                    <div class="flex items-center space-x-2">
                                                        ${material.deliveryDate ? `
                                                            <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">Teslim Edildi</span>
                                                            <span class="text-xs text-gray-600">${new Date(material.deliveryDate).toLocaleDateString('tr-TR')}</span>
                                                        ` : `
                                                            <button onclick="deliverMaterial('${receipt.id}', '${material.code}')" 
                                                                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs transition-colors">
                                                                Teslim Et
                                                            </button>
                                                        `}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                        <div class="mt-3 pt-3 border-t border-blue-200 flex space-x-2">
                                            <button onclick="printEPrescription('${receipt.id}')" 
                                                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs transition-colors">
                                                üñ®Ô∏è Yazdƒ±r
                                            </button>
                                            <button onclick="exportEPrescription('${receipt.id}')" 
                                                    class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs transition-colors">
                                                üì§ Dƒ±≈üa Aktar
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Device Rights Information -->
                    ${sgkData.deviceRights ? `
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <h5 class="font-medium text-gray-900 mb-4">Cihaz Haklarƒ±</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <h6 class="font-medium text-gray-800 mb-2">Saƒü Kulak</h6>
                                    <div class="text-sm space-y-1">
                                        <div class="flex justify-between">
                                            <span>Cihaz Hakkƒ±:</span>
                                            <span class="${sgkData.deviceRights.right?.eligible ? 'text-green-600' : 'text-red-600'}">${sgkData.deviceRights.right?.eligible ? 'Var' : 'Yok'}</span>
                                        </div>
                                        ${sgkData.deviceRights.right?.lastDeviceDate ? `
                                            <div class="flex justify-between">
                                                <span>Son Cihaz:</span>
                                                <span>${new Date(sgkData.deviceRights.right.lastDeviceDate).toLocaleDateString('tr-TR')}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <h6 class="font-medium text-gray-800 mb-2">Sol Kulak</h6>
                                    <div class="text-sm space-y-1">
                                        <div class="flex justify-between">
                                            <span>Cihaz Hakkƒ±:</span>
                                            <span class="${sgkData.deviceRights.left?.eligible ? 'text-green-600' : 'text-red-600'}">${sgkData.deviceRights.left?.eligible ? 'Var' : 'Yok'}</span>
                                        </div>
                                        ${sgkData.deviceRights.left?.lastDeviceDate ? `
                                            <div class="flex justify-between">
                                                <span>Son Cihaz:</span>
                                                <span>${new Date(sgkData.deviceRights.left.lastDeviceDate).toLocaleDateString('tr-TR')}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Action Buttons -->
                    <div class="mt-6 pt-6 border-t border-gray-200 flex space-x-3">
                        <button onclick="updateSGKInfo('${patientId}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                            SGK Bilgilerini G√ºncelle
                        </button>
                        <button onclick="downloadSGKReport('${patientId}')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                            Rapor ƒ∞ndir
                        </button>
                        ${sgkStatus === 'pending' ? `
                            <button onclick="checkSGKStatus('${patientId}')" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                                Durum Sorgula
                            </button>
                        ` : ''}
                    </div>
                `;
                
                console.log('‚úÖ SGK info loaded successfully for patient:', patientId);
                
            } catch (error) {
                console.error('‚ùå Error loading SGK info:', error);
                sgkInfo.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <p class="mb-2">SGK bilgileri y√ºklenirken bir hata olu≈ütu.</p>
                        <button onclick="loadSGKInfo()" class="text-blue-600 hover:text-blue-800 font-medium">Tekrar Dene</button>
                    </div>
                `;
            }
        }

        function loadTimeline() {
            // Get timeline tab content element
            const timelineTabContent = document.getElementById('timelineTabContent');
            if (!timelineTabContent) {
                console.warn('Timeline tab content container not found');
                return;
            }
            
            try {
                // Get patient data with safe access
                const patient = window.patientDetailsManager?.currentPatient || {};
                
                // Collect all events with timestamps
                const events = [];
                
                // Add registration event with error handling
                if (patient.registrationDate) {
                    try {
                        events.push({
                            type: 'registration',
                            date: new Date(patient.registrationDate),
                            title: 'Hasta Kaydƒ±',
                            description: `${patient.firstName || patient.name || 'Hasta'} ${patient.lastName || ''} sisteme kaydedildi.`.trim(),
                            icon: 'user-plus'
                        });
                    } catch (error) {
                        console.warn('Error adding registration event:', error);
                    }
                }
                
                // Add notes with safe iteration
                if (Array.isArray(patient.notes)) {
                    patient.notes.forEach(note => {
                        try {
                            if (note.date || note.createdAt) {
                                events.push({
                                    type: 'note',
                                    date: new Date(note.date || note.createdAt),
                                    title: note.title || 'Not Eklendi',
                                    description: note.content || note.text || 'ƒ∞√ßerik belirtilmemi≈ü',
                                    icon: 'clipboard',
                                    noteType: note.type
                                });
                            }
                        } catch (error) {
                            console.warn('Error adding note event:', error, note);
                        }
                    });
                }
                
                // Add appointments with safe data access
                const appointments = window.patientDetailsManager?.appointments || [];
                appointments.forEach(appointment => {
                    try {
                        if (appointment.date) {
                            events.push({
                                type: 'appointment',
                                date: new Date(appointment.date),
                                title: `Randevu: ${appointment.type || 'Genel'}`,
                                description: appointment.notes || 'Randevu detayƒ± belirtilmemi≈ü.',
                                icon: 'calendar',
                                status: appointment.status || 'scheduled'
                            });
                        }
                    } catch (error) {
                        console.warn('Error adding appointment event:', error, appointment);
                    }
                });
                
                // Add device trials with validation
                const deviceTrials = window.patientDetailsManager?.deviceTrials || patient.deviceTrials || [];
                if (Array.isArray(deviceTrials)) {
                    deviceTrials.forEach(trial => {
                        try {
                            if (trial.startDate) {
                                events.push({
                                    type: 'device_trial',
                                    date: new Date(trial.startDate),
                                    title: 'Cihaz Denemesi Ba≈üladƒ±',
                                    description: `${trial.deviceName || 'Cihaz'} denemesi ba≈üladƒ±.`,
                                    icon: 'headphones',
                                    trialId: trial.id
                                });
                            }
                            
                            if (trial.endDate) {
                                events.push({
                                    type: 'device_trial_end',
                                    date: new Date(trial.endDate),
                                    title: 'Cihaz Denemesi Tamamlandƒ±',
                                    description: `${trial.deviceName || 'Cihaz'} denemesi tamamlandƒ±. ${trial.result || ''}`,
                                    icon: 'check-circle',
                                    trialId: trial.id
                                });
                            }
                        } catch (error) {
                            console.warn('Error adding device trial event:', error, trial);
                        }
                    });
                }
                
                // Add device assignments with validation
                if (Array.isArray(patient.devices)) {
                    patient.devices.forEach(device => {
                        try {
                            if (device.assignmentDate) {
                                events.push({
                                    type: 'device_assignment',
                                    date: new Date(device.assignmentDate),
                                    title: 'Cihaz Atandƒ±',
                                    description: `${device.manufacturer || device.brand || 'Cihaz'} ${device.model || ''} ${device.direction || ''} cihazƒ± atandƒ±.`.trim(),
                                    icon: 'headphones',
                                    deviceId: device.id
                                });
                            }
                        } catch (error) {
                            console.warn('Error adding device assignment event:', error, device);
                        }
                    });
                }
                
                // Add payments with validation
                const payments = window.patientDetailsManager?.payments || [];
                if (Array.isArray(payments)) {
                    payments.forEach(payment => {
                        try {
                            if (payment.date) {
                                events.push({
                                    type: 'payment',
                                    date: new Date(payment.date),
                                    title: '√ñdeme Alƒ±ndƒ±',
                                    description: `${payment.amount || 0} TL √∂deme ${payment.method || 'nakit'} olarak alƒ±ndƒ±. ${payment.description || ''}`.trim(),
                                    icon: 'credit-card',
                                    paymentId: payment.id
                                });
                            }
                        } catch (error) {
                            console.warn('Error adding payment event:', error, payment);
                        }
                    });
                }
                
                // Add documents with validation
                const documents = window.patientDetailsManager?.documents || patient.documents || [];
                if (Array.isArray(documents)) {
                    documents.forEach(doc => {
                        try {
                            if (doc.date || doc.uploadDate) {
                                events.push({
                                    type: 'document',
                                    date: new Date(doc.date || doc.uploadDate),
                                    title: `Belge Y√ºklendi: ${doc.title || 'Belge'}`,
                                    description: `${doc.type || 'Belge'} y√ºklendi. ${doc.notes || ''}`.trim(),
                                    icon: 'file',
                                    documentId: doc.id
                                });
                            }
                        } catch (error) {
                            console.warn('Error adding document event:', error, doc);
                        }
                    });
                }
                
                // Add SMS history with validation
                if (Array.isArray(patient.smsHistory)) {
                    patient.smsHistory.forEach(sms => {
                        try {
                            if (sms.date) {
                                events.push({
                                    type: 'sms',
                                    date: new Date(sms.date),
                                    title: 'SMS G√∂nderildi',
                                    description: sms.message || 'SMS i√ßeriƒüi belirtilmemi≈ü',
                                    icon: 'message-square',
                                    smsId: sms.id
                                });
                            }
                        } catch (error) {
                            console.warn('Error adding SMS event:', error, sms);
                        }
                    });
                }
                
                // Add SGK updates with validation
                if (window.patientDetailsManager?.sgkInfo?.updatedAt) {
                    try {
                        events.push({
                            type: 'sgk_update',
                            date: new Date(window.patientDetailsManager.sgkInfo.updatedAt),
                            title: 'SGK Bilgileri G√ºncellendi',
                            description: `SGK bilgileri g√ºncellendi. Durum: ${getSGKStatusText(window.patientDetailsManager.sgkInfo.status)}`,
                            icon: 'shield',
                        });
                    } catch (error) {
                        console.warn('Error adding SGK update event:', error);
                    }
                }
                
                // Sort events by date (newest first) with error handling
                events.sort((a, b) => {
                    try {
                        return b.date - a.date;
                    } catch (error) {
                        console.warn('Error sorting timeline events:', error);
                        return 0;
                    }
                });
                
                // Helper function to format date safely
                const formatDate = (date) => {
                    try {
                        return date.toLocaleDateString('tr-TR', { 
                            day: '2-digit', 
                            month: 'long', 
                            year: 'numeric' 
                        });
                    } catch (error) {
                        console.warn('Error formatting date:', error, date);
                        return 'Ge√ßersiz tarih';
                    }
                };
                
                // Helper function to format time safely
                const formatTime = (date) => {
                    try {
                        return date.toLocaleTimeString('tr-TR', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                    } catch (error) {
                        console.warn('Error formatting time:', error, date);
                        return '';
                    }
                };
                
                // Helper function to get SGK status text
                function getSGKStatusText(status) {
                    const statusMap = {
                        'active': 'Aktif',
                        'pending': 'Beklemede',
                        'expired': 'S√ºresi Dolmu≈ü',
                        'not_eligible': 'Uygun Deƒüil'
                    };
                    return statusMap[status] || 'Belirtilmemi≈ü';
                }
                
                // Helper function to get icon class
                function getIconClass(iconName) {
                    const iconMap = {
                        'user-plus': 'M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z',
                        'clipboard': 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z',
                        'calendar': 'M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z',
                        'headphones': 'M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z',
                        'check-circle': 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z',
                        'credit-card': 'M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z',
                        'file': 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z',
                        'message-square': 'M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z',
                        'shield': 'M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z'
                    };
                    
                    return iconMap[iconName] || iconMap['file'];
                }
                
                // Helper function to get color class based on event type
                function getColorClass(eventType) {
                    const colorMap = {
                        'registration': 'bg-blue-500',
                        'note': 'bg-yellow-500',
                        'appointment': 'bg-green-500',
                        'device_trial': 'bg-purple-500',
                        'device_trial_end': 'bg-purple-700',
                        'device_assignment': 'bg-indigo-500',
                        'payment': 'bg-green-600',
                        'document': 'bg-gray-500',
                        'sms': 'bg-blue-400',
                        'sgk_update': 'bg-red-500'
                    };
                    
                    return colorMap[eventType] || 'bg-gray-400';
                }
                
                // Generate timeline HTML
                let timelineHTML = '';
                
                if (events.length === 0) {
                    timelineHTML = `
                        <div class="p-4 text-center">
                            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p class="text-gray-500 mb-2">Hen√ºz kayƒ±tlƒ± bir etkinlik bulunmamaktadƒ±r.</p>
                            <p class="text-sm text-gray-400">Hasta ile ilgili etkinlikler burada g√∂r√ºnt√ºlenecektir.</p>
                        </div>
                    `;
                } else {
                    let currentDate = null;
                    
                    timelineHTML = `<div class="p-4">`;
                    
                    events.forEach((event, index) => {
                        try {
                            const eventDate = formatDate(event.date);
                            
                            // Add date header if this is a new date
                            if (currentDate !== eventDate) {
                                currentDate = eventDate;
                                timelineHTML += `
                                    ${index > 0 ? '</div>' : ''}
                                    <div class="mb-4">
                                        <h3 class="text-lg font-medium text-gray-900 sticky top-0 bg-gray-100 p-2 rounded">${eventDate}</h3>
                                `;
                            }
                            
                            // Add event
                            timelineHTML += `
                                <div class="flex items-start mb-4">
                                    <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center ${getColorClass(event.type)} text-white mr-3">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${getIconClass(event.icon)}"/>
                                        </svg>
                                    </div>
                                    <div class="flex-grow">
                                        <div class="flex items-center">
                                            <h4 class="text-md font-medium text-gray-900">${event.title}</h4>
                                            <span class="ml-auto text-sm text-gray-500">${formatTime(event.date)}</span>
                                        </div>
                                        <p class="text-sm text-gray-600 mt-1">${event.description}</p>
                                    </div>
                                </div>
                            `;
                        } catch (error) {
                            console.warn('Error rendering timeline event:', error, event);
                        }
                    });
                    
                    timelineHTML += `</div></div>`;
                }
                
                timelineTabContent.innerHTML = `
                    <div class="p-4">
                        <h2 class="text-xl font-semibold mb-4">Zaman √áizelgesi</h2>
                        <div class="bg-white shadow rounded-lg overflow-hidden">
                            ${timelineHTML}
                        </div>
                    </div>
                `;
                
                console.log('‚úÖ Timeline loaded successfully with', events.length, 'events');
                
            } catch (error) {
                console.error('‚ùå Error loading timeline:', error);
                timelineTabContent.innerHTML = `
                    <div class="p-4 text-center">
                        <div class="text-red-500 mb-4">
                            <svg class="w-16 h-16 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                            </svg>
                            <p class="mb-2">Zaman √ßizelgesi y√ºklenirken bir hata olu≈ütu.</p>
                            <button onclick="loadTimeline()" class="text-blue-600 hover:text-blue-800 font-medium">Tekrar Dene</button>
                        </div>
                    </div>
                `;
            }
        }

        // Patient List Functions
        async function loadPatientList() {
            try {
                // Load patients from localStorage and sample data
                let allPatients = [];
                
                // Load from localStorage
                const storedPatients = JSON.parse(localStorage.getItem('patients') || '[]');
                allPatients = [...storedPatients];
                
                // Load from global sample data if available
                if (window.sampleData && window.sampleData.patients) {
                    window.sampleData.patients.forEach(patient => {
                        if (!allPatients.find(p => p.id === patient.id)) {
                            allPatients.push(patient);
                        }
                    });
                }
                
                // Add default patients if none exist
                if (allPatients.length === 0) {
                    allPatients = [
                        {
                            id: 'p1',
                            firstName: 'Ahmet',
                            lastName: 'Yƒ±lmaz',
                            name: 'Ahmet Yƒ±lmaz',
                            phone: '0532 123 4567',
                            status: 'active',
                            conversionStep: 'device_trial'
                        },
                        {
                            id: 'p2',
                            firstName: 'Ay≈üe',
                            lastName: 'Kaya',
                            name: 'Ay≈üe Kaya',
                            phone: '0533 234 5678',
                            status: 'active',
                            conversionStep: 'purchased'
                        },
                        {
                            id: 'p3',
                            firstName: 'Mehmet',
                            lastName: 'Demir',
                            name: 'Mehmet Demir',
                            phone: '0534 345 6789',
                            status: 'pending',
                            conversionStep: 'hearing_test_done'
                        }
                    ];
                }
                
                renderPatientList(allPatients);
                window.allPatients = allPatients; // Store globally for search
                
            } catch (error) {
                console.error('Error loading patient list:', error);
            }
        }

        function renderPatientList(patients) {
            const container = document.getElementById('patientListContainer');
            if (!container) return;
            
            const currentPatientId = getPatientIdFromURL();
            
            const patientsHTML = patients.map(patient => {
                const isActive = patient.id === currentPatientId;
                const initials = getPatientInitials(patient);
                const statusClass = getStatusClass(patient.status);
                
                return `
                    <a href="patient-details-backup.html?id=${patient.id}" class="patient-list-item ${isActive ? 'active' : ''}" data-patient-id="${patient.id}">
                        <div class="patient-avatar">${initials}</div>
                        <div class="patient-info">
                            <div class="patient-name">${patient.name || `${patient.firstName} ${patient.lastName}`}</div>
                            <div class="patient-phone">${patient.phone || 'Telefon belirtilmemi≈ü'}</div>
                        </div>
                        <div class="patient-status ${statusClass}" title="${getStatusText(patient.status)}"></div>
                    </a>
                `;
            }).join('');
            
            container.innerHTML = patientsHTML;
        }

        function getPatientInitials(patient) {
            const name = patient.name || `${patient.firstName || ''} ${patient.lastName || ''}`;
            const parts = name.trim().split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            }
            return (parts[0] || 'H')[0].toUpperCase();
        }

        function getStatusClass(status) {
            switch (status) {
                case 'active': return 'active';
                case 'inactive': return 'inactive';
                case 'pending': return 'pending';
                default: return 'pending';
            }
        }

        function getStatusText(status) {
            switch (status) {
                case 'active': return 'Aktif';
                case 'inactive': return 'Pasif';
                case 'pending': return 'Beklemede';
                default: return 'Bilinmiyor';
            }
        }

        function setupPatientSearch() {
            const searchInput = document.getElementById('patientSearchInput');
            if (!searchInput) return;
            
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (!window.allPatients) return;
                
                const filteredPatients = window.allPatients.filter(patient => {
                    const name = (patient.name || `${patient.firstName} ${patient.lastName}`).toLowerCase();
                    const phone = (patient.phone || '').toLowerCase();
                    
                    return name.includes(query) || phone.includes(query);
                });
                
                renderPatientList(filteredPatients);
            });
        }

        // Patient List Toggle Function
        window.togglePatientList = function() {
            const patientSidebar = document.getElementById('patient-list-sidebar');
            
            if (patientSidebar) {
                patientSidebar.classList.toggle('collapsed');
                
                // Save state to localStorage
                const isCollapsed = patientSidebar.classList.contains('collapsed');
                localStorage.setItem('patientListCollapsed', isCollapsed);
                
                console.log('üîÑ Patient list toggled:', isCollapsed ? 'collapsed' : 'expanded');
                
                // Update layout immediately
                updateLayoutMargins();
                
                // Force a second update after transition completes
                setTimeout(() => {
                    updateLayoutMargins();
                    console.log('‚úÖ Patient list toggle layout update complete');
                }, 350); // Slightly longer than CSS transition
            }
        };

        // Adjust layout based on sidebar states
        function adjustLayoutForSidebars() {
            const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            const patientListCollapsed = localStorage.getItem('patientListCollapsed') === 'true';
            
            const sidebar = document.querySelector('.sidebar-nav');
            const patientSidebar = document.getElementById('patient-list-sidebar');
            const mainContent = document.querySelector('.patient-details-content');
            
            console.log('üîÑ Adjusting initial layout:', { sidebarCollapsed, patientListCollapsed });
            
            if (sidebarCollapsed && sidebar) {
                sidebar.classList.add('collapsed');
            }
            
            if (patientListCollapsed && patientSidebar) {
                patientSidebar.classList.add('collapsed');
            }
            
            // Ensure elements exist before applying layout
            if (sidebar && patientSidebar && mainContent) {
                // Apply layout adjustments immediately and again after DOM is fully ready
                updateLayoutMargins();
                setTimeout(() => {
                    updateLayoutMargins();
                    console.log('‚úÖ Initial layout adjustment complete');
                }, 100);
            } else {
                console.warn('‚ö†Ô∏è Some layout elements not found during initialization:', { 
                    sidebar: !!sidebar, 
                    patientSidebar: !!patientSidebar, 
                    mainContent: !!mainContent 
                });
                // Retry after a longer delay if elements are missing
                setTimeout(() => adjustLayoutForSidebars(), 500);
            }
        }

        function updateLayoutMargins() {
            const sidebar = document.querySelector('.sidebar-nav');
            const patientSidebar = document.getElementById('patient-list-sidebar');
            const mainContent = document.querySelector('.patient-details-content');
            const toggleButton = document.getElementById('patient-list-toggle-collapsed');
            
            if (!sidebar || !patientSidebar || !mainContent) {
                console.log('Missing elements for layout update');
                return;
            }
            
            const sidebarCollapsed = sidebar.classList.contains('collapsed');
            const patientListCollapsed = patientSidebar.classList.contains('collapsed');
            
            console.log('Layout update:', { sidebarCollapsed, patientListCollapsed });
            
            // Clear all existing classes first
            patientSidebar.classList.remove('main-sidebar-collapsed');
            mainContent.classList.remove('main-sidebar-collapsed', 'patient-list-collapsed');
            
            // Apply classes to control layout via CSS
            if (sidebarCollapsed) {
                patientSidebar.classList.add('main-sidebar-collapsed');
                mainContent.classList.add('main-sidebar-collapsed');
            }
            
            if (patientListCollapsed) {
                mainContent.classList.add('patient-list-collapsed');
                // Show toggle button when patient list is collapsed
                if (toggleButton) {
                    toggleButton.style.display = 'block';
                    // Position it correctly based on main sidebar state
                    toggleButton.style.left = sidebarCollapsed ? '90px' : '250px';
                }
            } else {
                // Hide toggle button when patient list is open
                if (toggleButton) {
                    toggleButton.style.display = 'none';
                }
            }
            
            // Force a reflow to ensure the layout changes take effect immediately
            mainContent.offsetHeight;
            
            // Remove any inline styles that might override CSS
            patientSidebar.style.width = '';
            patientSidebar.style.left = '';
            mainContent.style.marginLeft = '';
            
            console.log('‚úÖ Layout updated - Classes applied:', {
                patientSidebarClasses: Array.from(patientSidebar.classList),
                mainContentClasses: Array.from(mainContent.classList)
            });
            
            console.log('CSS classes applied, toggle button visibility updated');
        }

        // Override the global sidebar toggle to adjust patient list position
        window.toggleSidebar = function() {
            const sidebar = document.querySelector('.sidebar-nav');
            
            if (sidebar) {
                sidebar.classList.toggle('collapsed');
                const isCollapsed = sidebar.classList.contains('collapsed');
                
                // Save state to localStorage
                localStorage.setItem('sidebarCollapsed', isCollapsed);
                
                updateLayoutMargins();
            }
        };

        // Load documents tab data
        function loadDocumentsTabData() {
            console.log('üìÑ Loading documents tab data...');
            
            try {
                // Populate E-re√ßete No field if patient has this data
                if (window.patientDetailsManager?.currentPatient) {
                    const patient = window.patientDetailsManager.currentPatient;
                    const eReceiptField = document.getElementById('eReceiptNo');
                    
                    if (eReceiptField && patient.eReceiptNo) {
                        eReceiptField.value = patient.eReceiptNo;
                        console.log('‚úÖ E-re√ßete No loaded:', patient.eReceiptNo);
                    }
                }
                
                // Load and display documents
                loadPatientDocuments();
                
            } catch (error) {
                console.error('‚ùå Error loading documents tab data:', error);
            }
        }
        
        function loadPatientDocuments() {
            const documentsListContainer = document.getElementById('documents-list');
            if (!documentsListContainer) {
                console.warn('Documents list container not found');
                return;
            }
            
            try {
                // Get patient documents
                const patient = window.patientDetailsManager?.currentPatient || {};
                const patientId = patient.id || currentPatientId;
                
                // Get documents from multiple sources
                let documents = [];
                
                // Check patient's own documents array
                if (patient.documents && Array.isArray(patient.documents)) {
                    documents = [...patient.documents];
                }
                
                // Also check global document manager
                if (window.patientDetailsManager?.documents) {
                    const patientDocs = window.patientDetailsManager.documents.filter(doc => doc.patientId === patientId);
                    documents = [...documents, ...patientDocs];
                }
                
                // Remove duplicates based on id
                documents = documents.filter((doc, index, self) => 
                    index === self.findIndex(d => d.id === doc.id)
                );
                
                if (documents.length === 0) {
                    documentsListContainer.innerHTML = `
                        <div class="text-center py-12">
                            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">Hen√ºz belge y√ºklenmemi≈ü</h3>
                            <p class="text-gray-600 mb-4">Bu hasta i√ßin hen√ºz belge y√ºklenmemi≈ütir.</p>
                            <button onclick="uploadDocument()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                                ƒ∞lk Belgeyi Y√ºkle
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // Sort documents by upload date (newest first)
                documents.sort((a, b) => new Date(b.uploadDate || b.date) - new Date(a.uploadDate || a.date));
                
                // Get document type info
                const getDocumentTypeInfo = (type) => {
                    const types = {
                        'sgk_report': { name: 'SGK Raporu', icon: 'clipboard-check', color: 'green' },
                        'hearing_test': { name: 'ƒ∞≈üitme Testi', icon: 'chart-bar', color: 'blue' },
                        'prescription': { name: 'Re√ßete', icon: 'document-text', color: 'purple' },
                        'invoice': { name: 'Fatura', icon: 'receipt-tax', color: 'yellow' },
                        'id_card': { name: 'Kimlik Belgesi', icon: 'identification', color: 'gray' },
                        'other': { name: 'Diƒüer', icon: 'document', color: 'gray' }
                    };
                    return types[type] || types['other'];
                };
                
                // Create documents grid
                const documentsHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${documents.map(doc => {
                            const typeInfo = getDocumentTypeInfo(doc.type);
                            const uploadDate = doc.uploadDate ? new Date(doc.uploadDate).toLocaleDateString('tr-TR') : 
                                              doc.date ? new Date(doc.date).toLocaleDateString('tr-TR') : 'Bilinmiyor';
                            const fileSize = doc.fileSize ? 
                                           (doc.fileSize > 1024 * 1024 ? 
                                            (doc.fileSize / (1024 * 1024)).toFixed(1) + ' MB' : 
                                            (doc.fileSize / 1024).toFixed(1) + ' KB') : 
                                           'Bilinmiyor';
                            
                            return `
                                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                    <div class="flex items-start justify-between mb-3">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 bg-${typeInfo.color}-100 rounded-lg flex items-center justify-center mr-3">
                                                <svg class="w-6 h-6 text-${typeInfo.color}-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                </svg>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <h4 class="font-medium text-gray-900 truncate">${doc.title}</h4>
                                                <p class="text-sm text-gray-500">${typeInfo.name}</p>
                                            </div>
                                        </div>
                                        <button onclick="toggleDocumentActions('${doc.id}')" class="text-gray-400 hover:text-gray-600">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
                                            </svg>
                                        </button>
                                    </div>
                                    
                                    <div class="text-sm text-gray-600 space-y-1 mb-3">
                                        <div class="flex justify-between">
                                            <span>Tarih:</span>
                                            <span>${uploadDate}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Boyut:</span>
                                            <span>${fileSize}</span>
                                        </div>
                                        ${doc.fileName ? `
                                            <div class="flex justify-between">
                                                <span>Dosya:</span>
                                                <span class="truncate ml-2">${doc.fileName}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    ${doc.notes ? `
                                        <div class="text-sm text-gray-700 mb-3">
                                            <span class="font-medium">Notlar:</span>
                                            <p class="mt-1">${doc.notes}</p>
                                        </div>
                                    ` : ''}
                                    
                                    <div class="flex space-x-2">
                                        <button onclick="viewDocument('${doc.id}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 px-3 rounded font-medium transition-colors">
                                            G√∂r√ºnt√ºle
                                        </button>
                                        <button onclick="downloadDocument('${doc.id}')" class="bg-gray-600 hover:bg-gray-700 text-white text-sm py-2 px-3 rounded font-medium transition-colors">
                                            ƒ∞ndir
                                        </button>
                                    </div>
                                    
                                    <!-- Action menu (hidden by default) -->
                                    <div id="actions-${doc.id}" class="hidden mt-3 pt-3 border-t border-gray-200">
                                        <div class="flex space-x-2 text-sm">
                                            <button onclick="editDocument('${doc.id}')" class="text-blue-600 hover:text-blue-900 font-medium">D√ºzenle</button>
                                            <button onclick="shareDocument('${doc.id}')" class="text-green-600 hover:text-green-900 font-medium">Payla≈ü</button>
                                            <button onclick="deleteDocument('${doc.id}')" class="text-red-600 hover:text-red-900 font-medium">Sil</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="mt-6 text-center">
                        <p class="text-sm text-gray-500 mb-3">Toplam ${documents.length} belge</p>
                        <button onclick="uploadDocument()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200">
                            Yeni Belge Ekle
                        </button>
                    </div>
                `;
                
                documentsListContainer.innerHTML = documentsHTML;
                console.log('‚úÖ Documents loaded successfully:', documents.length);
                
            } catch (error) {
                console.error('‚ùå Error loading patient documents:', error);
                documentsListContainer.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <p class="mb-2">Belgeler y√ºklenirken bir hata olu≈ütu.</p>
                        <button onclick="loadPatientDocuments()" class="text-blue-600 hover:text-blue-800 font-medium">Tekrar Dene</button>
                    </div>
                `;
            }
        }

        // E-receipt query function
        async function queryEReceipt(eReceiptNo) {
            const resultDiv = document.getElementById('eReceiptResult');
            resultDiv.innerHTML = `<div class="text-center p-4">Sorgulanƒ±yor...</div>`;

            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 1000));

                const mockResponse = {
                    success: true,
                    receiptNo: eReceiptNo,
                    receiptDate: new Date().toLocaleDateString('tr-TR'),
                    doctorName: 'Dr. Zeynep Kaya',
                    validUntil: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toLocaleDateString('tr-TR'),
                    materials: [
                        { id: 'ha_right', name: 'ƒ∞≈üitme cihazƒ± - saƒü kulak', kdv: '%20 KDV', available: true, selected: false },
                        { id: 'ha_left', name: 'ƒ∞≈üitme cihazƒ± - sol kulak', kdv: '%20 KDV', available: true, selected: false },
                    ]
                };

                if (mockResponse.success) {
                    // Build the HTML safely
                    let materialsHtml = mockResponse.materials.map(material => `
                        <div class="flex items-center justify-between p-3 bg-white rounded border ${!material.available ? 'opacity-50' : ''}">
                            <div class="flex items-center">
                                <input 
                                    type="checkbox" 
                                    id="material_${material.id}"
                                    ${!material.available ? 'disabled' : ''}
                                    class="mr-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                    onchange="toggleMaterial('${material.id}', this.checked)"
                                >
                                <div>
                                    <div class="font-medium text-gray-900">${material.name}</div>
                                    <div class="text-sm text-gray-500">${material.kdv}</div>
                                </div>
                            </div>
                            ${!material.available ? '<span class="text-red-500 text-xs">Mevcut Deƒüil</span>' : ''}
                        </div>
                    `).join('');

                    resultDiv.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h5 class="text-green-800 font-medium mb-4">E-re√ßete Bulundu</h5>
                            <div class="mb-4 p-3 bg-white rounded border text-sm space-y-2">
                                <div><span class="font-medium">E-re√ßete Tarihi:</span> ${mockResponse.receiptDate}</div>
                                <div><span class="font-medium">Doktor:</span> ${mockResponse.doctorName}</div>
                                <div><span class="font-medium">Ge√ßerlilik:</span> ${mockResponse.validUntil}</div>
                            </div>
                            <div class="mb-4">
                                <h6 class="font-medium text-gray-800 mb-3">Re√ßete Kapsamƒ±ndaki Malzemeler:</h6>
                                <div class="space-y-2" id="materialsList">${materialsHtml}</div>
                            </div>
                            <div class="flex justify-end">
                                <button onclick="saveEReceipt('${eReceiptNo}')" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg">
                                    E-re√ßete Kaydet
                                </button>
                            </div>
                        </div>
                    `;
                    window.currentEReceiptData = mockResponse;
                } else {
                    resultDiv.innerHTML = '<div class="text-red-500 p-4">E-re√ßete bulunamadƒ± veya ge√ßersiz.</div>';
                }
            } catch (error) {
                console.error('E-re√ßete sorgulama hatasƒ±:', error);
                resultDiv.innerHTML = '<div class="text-red-500 p-4">Sorgu sƒ±rasƒ±nda bir hata olu≈ütu.</div>';
            }
        }

        // Patient List Functions
        async function loadPatientList() {
            try {
                // Load patients from localStorage and sample data
                let allPatients = [];
                
                // Load from localStorage
                const storedPatients = JSON.parse(localStorage.getItem('patients') || '[]');
                allPatients = [...storedPatients];
                
                // Load from global sample data if available
                if (window.sampleData && window.sampleData.patients) {
                    window.sampleData.patients.forEach(patient => {
                        if (!allPatients.find(p => p.id === patient.id)) {
                            allPatients.push(patient);
                        }
                    });
                }
                
                // Add default patients if none exist
                if (allPatients.length === 0) {
                    allPatients = [
                        {
                            id: 'p1',
                            firstName: 'Ahmet',
                            lastName: 'Yƒ±lmaz',
                            name: 'Ahmet Yƒ±lmaz',
                            phone: '0532 123 4567',
                            status: 'active',
                            conversionStep: 'device_trial'
                        },
                        {
                            id: 'p2',
                            firstName: 'Ay≈üe',
                            lastName: 'Kaya',
                            name: 'Ay≈üe Kaya',
                            phone: '0533 234 5678',
                            status: 'active',
                            conversionStep: 'purchased'
                        },
                        {
                            id: 'p3',
                            firstName: 'Mehmet',
                            lastName: 'Demir',
                            name: 'Mehmet Demir',
                            phone: '0534 345 6789',
                            status: 'pending',
                            conversionStep: 'hearing_test_done'
                        }
                    ];
                }
                
                renderPatientList(allPatients);
                window.allPatients = allPatients; // Store globally for search
                
            } catch (error) {
                console.error('Error loading patient list:', error);
            }
        }

        function renderPatientList(patients) {
            const container = document.getElementById('patientListContainer');
            if (!container) return;
            
            const currentPatientId = getPatientIdFromURL();
            
            const patientsHTML = patients.map(patient => {
                const isActive = patient.id === currentPatientId;
                const initials = getPatientInitials(patient);
                const statusClass = getStatusClass(patient.status);
                
                return `
                    <a href="patient-details.html?id=${patient.id}" class="patient-list-item ${isActive ? 'active' : ''}" data-patient-id="${patient.id}">
                        <div class="patient-avatar">${initials}</div>
                        <div class="patient-info">
                            <div class="patient-name">${patient.name || `${patient.firstName} ${patient.lastName}`}</div>
                            <div class="patient-phone">${patient.phone || 'Telefon belirtilmemi≈ü'}</div>
                        </div>
                        <div class="patient-status ${statusClass}" title="${getStatusText(patient.status)}"></div>
                    </a>
                `;
            }).join('');
            
            container.innerHTML = patientsHTML;
        }

        function getPatientInitials(patient) {
            const name = patient.name || `${patient.firstName || ''} ${patient.lastName || ''}`;
            const parts = name.trim().split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            }
            return (parts[0] || 'H')[0].toUpperCase();
        }

        function getStatusClass(status) {
            switch (status) {
                case 'active': return 'active';
                case 'inactive': return 'inactive';
                case 'pending': return 'pending';
                default: return 'pending';
            }
        }

        function getStatusText(status) {
            switch (status) {
                case 'active': return 'Aktif';
                case 'inactive': return 'Pasif';
                case 'pending': return 'Beklemede';
                default: return 'Bilinmiyor';
            }
        }

        function setupPatientSearch() {
            const searchInput = document.getElementById('patientSearchInput');
            if (!searchInput) return;
            
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (!window.allPatients) return;
                
                const filteredPatients = window.allPatients.filter(patient => {
                    const name = (patient.name || `${patient.firstName} ${patient.lastName}`).toLowerCase();
                    const phone = (patient.phone || '').toLowerCase();
                    
                    return name.includes(query) || phone.includes(query);
                });
                
                renderPatientList(filteredPatients);
            });
        }

        // Patient List Toggle Function
        window.togglePatientList = function() {
            const patientSidebar = document.getElementById('patient-list-sidebar');
            
            if (patientSidebar) {
                patientSidebar.classList.toggle('collapsed');
                
                // Save state to localStorage
                const isCollapsed = patientSidebar.classList.contains('collapsed');
                localStorage.setItem('patientListCollapsed', isCollapsed);
                
                console.log('üîÑ Patient list toggled:', isCollapsed ? 'collapsed' : 'expanded');
                
                // Update layout immediately
                updateLayoutMargins();
                
                // Force a second update after transition completes
                setTimeout(() => {
                    updateLayoutMargins();
                    console.log('‚úÖ Patient list toggle layout update complete');
                }, 350); // Slightly longer than CSS transition
            }
        };

        function addNote() {
            // Get the current patient data
            const patient = window.patientDetailsManager?.currentPatient || {};
            
            // Create modal content
            const modalContent = `
                <div class="space-y-4">
                    <div>
                        <label for="noteTitle" class="block text-sm font-medium text-gray-700">Not Ba≈ülƒ±ƒüƒ±</label>
                        <input type="text" id="noteTitle" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="G√∂r√º≈üme, Kontrol, Deneme vb.">
                    </div>
                    <div>
                        <label for="noteContent" class="block text-sm font-medium text-gray-700">Not ƒ∞√ßeriƒüi</label>
                        <textarea id="noteContent" rows="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Hasta ile ilgili notlarƒ± buraya yazƒ±n..."></textarea>
                    </div>
                    <div>
                        <label for="noteType" class="block text-sm font-medium text-gray-700">Not Tipi</label>
                        <select id="noteType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                            <option value="call">Telefon G√∂r√º≈ümesi</option>
                            <option value="visit">Merkez Ziyareti</option>
                            <option value="trial">Cihaz Denemesi</option>
                            <option value="follow-up">Kontrol</option>
                            <option value="other">Diƒüer</option>
                        </select>
                    </div>
                </div>
            `;
            
            // Show modal
            Utils.showModal({
                title: 'Hasta Notu Ekle',
                content: modalContent,
                primaryButton: {
                    text: 'Kaydet',
                    onClick: () => {
                        // Get form values
                        const noteTitle = document.getElementById('noteTitle').value;
                        const noteContent = document.getElementById('noteContent').value;
                        const noteType = document.getElementById('noteType').value;
                        
                        if (!noteTitle || !noteContent) {
                            Utils.showToast('L√ºtfen ba≈ülƒ±k ve i√ßerik alanlarƒ±nƒ± doldurun', 'error');
                            return;
                        }
                        
                        // Create new note
                        const newNote = {
                            id: 'note_' + Date.now(),
                            title: noteTitle,
                            content: noteContent,
                            type: noteType,
                            date: new Date().toISOString(),
                            createdBy: 'Kullanƒ±cƒ±' // This would be the logged-in user in a real app
                        };
                        
                        // Add note to patient
                        if (window.patientDetailsManager) {
                            // Initialize notes array if it doesn't exist
                            if (!window.patientDetailsManager.currentPatient.notes) {
                                window.patientDetailsManager.currentPatient.notes = [];
                            }
                            
                            // Add new note
                            window.patientDetailsManager.currentPatient.notes.unshift(newNote);
                            window.patientDetailsManager.savePatientToStorage();
                            
                            // Refresh notes display
                            loadNotes();
                            loadQuickNotes();
                            
                            // Update timeline
                            if (typeof loadTimeline === 'function') {
                                loadTimeline();
                            }
                            
                            Utils.showToast('Not ba≈üarƒ±yla eklendi', 'success');
                        } else {
                            Utils.showToast('Not eklenemedi', 'error');
                        }
                    }
                },
                secondaryButton: {
                    text: 'ƒ∞ptal',
                    onClick: () => {}
                }
            });
        }

        function createSale() {
            // Get the current patient data
            const patient = window.patientDetailsManager?.currentPatient || {};
            
            // Create modal content
            const modalContent = `
                <div class="space-y-4">
                    <div>
                        <label for="saleDate" class="block text-sm font-medium text-gray-700">Satƒ±≈ü Tarihi</label>
                        <input type="date" id="saleDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div>
                        <label for="saleType" class="block text-sm font-medium text-gray-700">Satƒ±≈ü T√ºr√º</label>
                        <select id="saleType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" onchange="updateProductDropdown()">
                            <option value="">Satƒ±≈ü t√ºr√ºn√º se√ßin</option>
                            <option value="ƒ∞≈üitme Cihazƒ±">ƒ∞≈üitme Cihazƒ±</option>
                            <option value="Pil">Pil</option>
                            <option value="Aksesuar">Aksesuar</option>
                            <option value="Hizmet">Hizmet</option>
                            <option value="Bakƒ±m">Bakƒ±m Hizmeti</option>
                            <option value="Diƒüer">Diƒüer</option>
                        </select>
                    </div>
                    <div id="productSection" style="display: none;">
                        <label for="productSelect" class="block text-sm font-medium text-gray-700">√úr√ºn Se√ßimi</label>
                        <input type="text" id="productSelect" list="productOptions" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="√úr√ºn arayƒ±n veya se√ßin...">
                        <datalist id="productOptions">
                            <!-- Options will be populated by JavaScript -->
                        </datalist>
                    </div>
                    <div>
                        <label for="quantity" class="block text-sm font-medium text-gray-700">Adet</label>
                        <input type="number" id="quantity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="1" min="1" onchange="calculateTotal()">
                    </div>
                    <div>
                        <label for="unitPrice" class="block text-sm font-medium text-gray-700">Birim Fiyat (TL)</label>
                        <input type="number" id="unitPrice" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="0.00" step="0.01" onchange="calculateTotal()">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="taxAmount" class="block text-sm font-medium text-gray-700">KDV Tutarƒ± (TL)</label>
                            <input type="number" id="taxAmount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-50" placeholder="0.00" step="0.01" readonly>
                        </div>
                        <div>
                            <label for="taxRate" class="block text-sm font-medium text-gray-700">KDV Oranƒ± (%)</label>
                            <input type="number" id="taxRate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-50" placeholder="0" readonly>
                        </div>
                    </div>
                    <div>
                        <label for="saleAmount" class="block text-sm font-medium text-gray-700">Toplam Tutar (KDV Dahil)</label>
                        <input type="number" id="saleAmount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-50 font-semibold text-lg" placeholder="0.00" step="0.01" readonly>
                    </div>
                    <div>
                        <label for="paymentMethod" class="block text-sm font-medium text-gray-700">√ñdeme Y√∂ntemi</label>
                        <select id="paymentMethod" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                            <option value="cash">Nakit</option>
                            <option value="credit_card">Kredi Kartƒ±</option>
                            <option value="bank_transfer">Banka Havalesi</option>
                            <option value="installment">Taksit</option>
                            <option value="check">√áek</option>
                        </select>
                    </div>
                    <div>
                        <label for="saleDescription" class="block text-sm font-medium text-gray-700">Satƒ±≈ü A√ßƒ±klamasƒ±</label>
                        <textarea id="saleDescription" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Satƒ±≈ü detaylarƒ±..."></textarea>
                    </div>
                    <div>
                        <label for="warrantyPeriod" class="block text-sm font-medium text-gray-700">Garanti S√ºresi (Ay)</label>
                        <input type="number" id="warrantyPeriod" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="24" min="0">
                    </div>
                </div>
            `;
            
            // Show modal
            Utils.showModal({
                title: 'Satƒ±≈ü Olu≈ütur',
                content: modalContent,
                primaryButton: {
                    text: 'Satƒ±≈üƒ± Kaydet',
                    onClick: () => {
                        // Get form values
                        const saleDate = document.getElementById('saleDate').value;
                        const saleType = document.getElementById('saleType').value;
                        const selectedProduct = document.getElementById('productSelect').value;
                        const quantity = parseInt(document.getElementById('quantity').value);
                        const unitPrice = parseFloat(document.getElementById('unitPrice').value);
                        const taxRate = parseFloat(document.getElementById('taxRate').value);
                        const taxAmount = parseFloat(document.getElementById('taxAmount').value);
                        const saleAmount = parseFloat(document.getElementById('saleAmount').value);
                        const paymentMethod = document.getElementById('paymentMethod').value;
                        const saleDescription = document.getElementById('saleDescription').value;
                        const warrantyPeriod = document.getElementById('warrantyPeriod').value;
                        
                        if (!saleDate || !saleType || !quantity || !unitPrice) {
                            Utils.showToast('L√ºtfen t√ºm gerekli alanlarƒ± doldurun', 'error');
                            return;
                        }
                        
                        // Check if product selection is required and validate
                        if ((saleType === 'ƒ∞≈üitme Cihazƒ±' || saleType === 'Pil') && !selectedProduct) {
                            Utils.showToast('L√ºtfen √ºr√ºn se√ßimi yapƒ±n', 'error');
                            return;
                        }
                        
                        // Create new sale
                        const newSale = {
                            id: 'sale_' + Date.now(),
                            patientId: patient.id,
                            patientName: `${patient.firstName} ${patient.lastName}`,
                            date: saleDate,
                            type: saleType,
                            product: selectedProduct || null,
                            quantity: quantity,
                            unitPrice: unitPrice,
                            taxRate: taxRate,
                            taxAmount: taxAmount,
                            totalAmount: saleAmount,
                            baseAmount: saleAmount - taxAmount,
                            paymentMethod: paymentMethod,
                            description: saleDescription,
                            warrantyPeriod: parseInt(warrantyPeriod),
                            warrantyEndDate: calculateWarrantyEndDate(saleDate, warrantyPeriod),
                            status: 'completed',
                            createdAt: new Date().toISOString()
                        };
                        
                        // Add sale to patient
                        if (window.patientDetailsManager) {
                            // Initialize sales array if it doesn't exist
                            if (!window.patientDetailsManager.sales) {
                                window.patientDetailsManager.sales = [];
                            }
                            
                            // Add new sale
                            window.patientDetailsManager.sales.push(newSale);
                            
                            // Update patient conversion step to 'purchased'
                            window.patientDetailsManager.currentPatient.conversionStep = 'purchased';
                            window.patientDetailsManager.currentPatient.currentLabel = 'Satƒ±n Aldƒ±';
                            window.patientDetailsManager.savePatientToStorage();
                            
                            // Update timeline
                            if (typeof loadTimeline === 'function') {
                                loadTimeline();
                            }
                            
                            // Refresh sales tab if it's visible
                            if (typeof loadSalesData === 'function') {
                                loadSalesData();
                            }
                            
                            Utils.showToast('Satƒ±≈ü ba≈üarƒ±yla olu≈üturuldu', 'success');
                        } else {
                            Utils.showToast('Satƒ±≈ü olu≈üturulamadƒ±', 'error');
                        }
                    }
                },
                secondaryButton: {
                    text: 'ƒ∞ptal',
                    onClick: () => {}
                }
            });
        }
        
        // Helper function to calculate warranty end date
        function calculateWarrantyEndDate(saleDate, warrantyPeriodMonths) {
            if (!saleDate || !warrantyPeriodMonths) return null;
            
            const startDate = new Date(saleDate);
            const endDate = new Date(startDate);
            endDate.setMonth(endDate.getMonth() + parseInt(warrantyPeriodMonths));
            
            return endDate.toISOString().split('T')[0];
        }

        // Function to calculate total amount based on quantity, unit price, and tax
        function calculateTotal() {
            const saleType = document.getElementById('saleType').value;
            const quantity = parseFloat(document.getElementById('quantity').value) || 0;
            const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
            
            const taxRateField = document.getElementById('taxRate');
            const taxAmountField = document.getElementById('taxAmount');
            const totalAmountField = document.getElementById('saleAmount');
            
            let taxRate = 0;
            let taxAmount = 0;
            let totalAmount = 0;
            let baseAmount = 0;
            
            if (saleType === 'ƒ∞≈üitme Cihazƒ±') {
                // For hearing devices: 0% tax, price is as entered
                taxRate = 0;
                baseAmount = quantity * unitPrice;
                taxAmount = 0;
                totalAmount = baseAmount;
            } else {
                // For other products: 20% tax included in the entered price
                taxRate = 20;
                totalAmount = quantity * unitPrice;
                baseAmount = totalAmount / 1.2; // Remove 20% tax
                taxAmount = totalAmount - baseAmount;
            }
            
            // Update form fields
            taxRateField.value = taxRate.toFixed(0);
            taxAmountField.value = taxAmount.toFixed(2);
            totalAmountField.value = totalAmount.toFixed(2);
        }

        // Function to update product dropdown based on sale type
        function updateProductDropdown() {
            const saleType = document.getElementById('saleType').value;
            const productSection = document.getElementById('productSection');
            const productSelect = document.getElementById('productSelect');
            const productOptions = document.getElementById('productOptions');
            
            // Clear existing options and input
            productOptions.innerHTML = '';
            productSelect.value = '';
            
            // Recalculate totals when sale type changes
            calculateTotal();
            
            if (saleType === 'ƒ∞≈üitme Cihazƒ±') {
                productSection.style.display = 'block';
                
                // Update label for hearing devices
                productSection.querySelector('label').textContent = 'ƒ∞≈üitme Cihazƒ± Se√ßimi';
                productSelect.placeholder = 'ƒ∞≈üitme cihazƒ± arayƒ±n veya se√ßin...';
                
                // Add hearing device options
                const hearingDevices = [
                    'Phonak Aud√©o Paradise P90-312T',
                    'Phonak Aud√©o Paradise P70-312T',
                    'Phonak Aud√©o Paradise P50-312T',
                    'Phonak Aud√©o Paradise P30-312T',
                    'Phonak Aud√©o Life P90-312T',
                    'Phonak Aud√©o Life P70-312T',
                    'Phonak Aud√©o Fit P90-312T',
                    'Phonak Aud√©o Fit P70-312T',
                    'Phonak Na√≠da Paradise P90-UP',
                    'Phonak Na√≠da Paradise P70-UP',
                    'Phonak Sky Paradise P90-SP',
                    'Phonak Sky Paradise P70-SP',
                    'Oticon More 1',
                    'Oticon More 2',
                    'Oticon More 3',
                    'Oticon Real 1',
                    'Oticon Real 2',
                    'Oticon Real 3',
                    'Widex Moment 440',
                    'Widex Moment 330',
                    'Widex Moment 220',
                    'Widex Moment 110',
                    'Signia Pure Charge&Go AX 7',
                    'Signia Pure Charge&Go AX 5',
                    'Signia Pure Charge&Go AX 3',
                    'ReSound OMNIA 9',
                    'ReSound OMNIA 7',
                    'ReSound OMNIA 5'
                ];
                
                hearingDevices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device;
                    productOptions.appendChild(option);
                });
                
            } else if (saleType === 'Pil') {
                productSection.style.display = 'block';
                
                // Update label for batteries
                productSection.querySelector('label').textContent = 'Pil T√ºr√º Se√ßimi';
                productSelect.placeholder = 'Pil t√ºr√ºn√º se√ßin...';
                
                // Add battery options with the specified types
                const batteries = [
                    '10 - Sarƒ±',
                    '13 - Turuncu', 
                    '312 - Kahverengi',
                    '675 - Mavi',
                    'Koklear ƒ∞mplant Pili'
                ];
                
                batteries.forEach(battery => {
                    const option = document.createElement('option');
                    option.value = battery;
                    productOptions.appendChild(option);
                });
                
            } else {
                productSection.style.display = 'none';
            }
        }

        // Function to load and display sales data
        function loadSalesData() {
            const salesTableBody = document.getElementById('salesTableBody');
            const noSalesMessage = document.getElementById('noSalesMessage');
            const totalSalesAmount = document.getElementById('totalSalesAmount');
            const monthlySalesAmount = document.getElementById('monthlySalesAmount');
            const totalSalesCount = document.getElementById('totalSalesCount');
            
            if (!salesTableBody) return;
            
            // Get sales data for current patient
            const sales = window.patientDetailsManager?.sales?.filter(sale => 
                sale.patientId === currentPatientId
            ) || [];
            
            // Clear existing content
            salesTableBody.innerHTML = '';
            
            if (sales.length === 0) {
                if (noSalesMessage) noSalesMessage.style.display = 'block';
                if (salesTableBody.parentElement.parentElement) salesTableBody.parentElement.parentElement.style.display = 'none';
            } else {
                if (noSalesMessage) noSalesMessage.style.display = 'none';
                if (salesTableBody.parentElement.parentElement) salesTableBody.parentElement.parentElement.style.display = 'block';
                
                // Sort sales by date (newest first)
                sales.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Populate table
                sales.forEach(sale => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    
                    // Format date
                    const saleDate = new Date(sale.date).toLocaleDateString('tr-TR');
                    
                    // Status badge
                    const statusBadge = sale.status === 'completed' 
                        ? '<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Tamamlandƒ±</span>'
                        : '<span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">Beklemede</span>';
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${saleDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${sale.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.product || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${sale.quantity || 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">‚Ç∫${(sale.unitPrice || 0).toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">‚Ç∫${(sale.taxAmount || 0).toFixed(2)} (${sale.taxRate || 0}%)</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">‚Ç∫${(sale.totalAmount || sale.amount || 0).toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="viewSaleDetails('${sale.id}')" class="text-blue-600 hover:text-blue-900 mr-2">Detay</button>
                            <button onclick="printInvoice('${sale.id}')" class="text-green-600 hover:text-green-900">Fatura</button>
                        </td>
                    `;
                    
                    salesTableBody.appendChild(row);
                });
            }
            
            // Calculate totals
            const totalAmount = sales.reduce((sum, sale) => sum + (sale.totalAmount || sale.amount || 0), 0);
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyAmount = sales
                .filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
                })
                .reduce((sum, sale) => sum + (sale.totalAmount || sale.amount || 0), 0);
            
            // Update summary cards
            if (totalSalesAmount) totalSalesAmount.textContent = `‚Ç∫${totalAmount.toFixed(2)}`;
            if (monthlySalesAmount) monthlySalesAmount.textContent = `‚Ç∫${monthlyAmount.toFixed(2)}`;
            if (totalSalesCount) totalSalesCount.textContent = sales.length.toString();
        }
        
        // Helper functions for new appointment functionality
        function addAppointment(patientId) {
            const patient = window.patientDetailsManager?.currentPatient || {};
            
            const modalContent = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="appointmentDate" class="block text-sm font-medium text-gray-700">Randevu Tarihi</label>
                            <input type="date" id="appointmentDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div>
                            <label for="appointmentTime" class="block text-sm font-medium text-gray-700">Saat</label>
                            <input type="time" id="appointmentTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="10:00">
                        </div>
                    </div>
                    <div>
                        <label for="appointmentType" class="block text-sm font-medium text-gray-700">Randevu T√ºr√º</label>
                        <select id="appointmentType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                            <option value="Genel Muayene">Genel Muayene</option>
                            <option value="ƒ∞≈üitme Testi">ƒ∞≈üitme Testi</option>
                            <option value="Cihaz Denemesi">Cihaz Denemesi</option>
                            <option value="Kontrol">Kontrol</option>
                            <option value="Bakƒ±m">Bakƒ±m</option>
                            <option value="√ñd√º√ß Teslimi">√ñd√º√ß Teslimi</option>
                        </select>
                    </div>
                    <div>
                        <label for="appointmentNotes" class="block text-sm font-medium text-gray-700">Notlar</label>
                        <textarea id="appointmentNotes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Randevu ile ilgili notlar..."></textarea>
                    </div>
                </div>
            `;
            
            Utils.showModal({
                title: 'Yeni Randevu Ekle',
                content: modalContent,
                primaryButton: {
                    text: 'Randevu Olu≈ütur',
                    onClick: () => {
                        const date = document.getElementById('appointmentDate').value;
                        const time = document.getElementById('appointmentTime').value;
                        const type = document.getElementById('appointmentType').value;
                        const notes = document.getElementById('appointmentNotes').value;
                        
                        if (!date || !time || !type) {
                            Utils.showToast('L√ºtfen t√ºm gerekli alanlarƒ± doldurun', 'error');
                            return;
                        }
                        
                        const newAppointment = {
                            id: 'apt_' + Date.now(),
                            patientId: patientId,
                            date: date,
                            time: time,
                            type: type,
                            notes: notes,
                            status: 'scheduled',
                            createdAt: new Date().toISOString()
                        };
                        
                        // Initialize appointments array if it doesn't exist
                        if (!window.patientDetailsManager.appointments) {
                            window.patientDetailsManager.appointments = [];
                        }
                        
                        window.patientDetailsManager.appointments.push(newAppointment);
                        
                        // Also add to patient's appointments
                        if (!patient.appointments) {
                            patient.appointments = [];
                        }
                        patient.appointments.push(newAppointment);
                        
                        // Save to storage
                        window.patientDetailsManager.savePatientToStorage();
                        
                        // Refresh appointments display
                        loadAppointments();
                        
                        // Update timeline
                        if (typeof loadTimeline === 'function') {
                            loadTimeline();
                        }
                        
                        Utils.showToast('Randevu ba≈üarƒ±yla olu≈üturuldu', 'success');
                    }
                },
                secondaryButton: {
                    text: 'ƒ∞ptal',
                    onClick: () => {}
                }
            });
        }
        
        function editAppointment(appointmentId) {
            // Find the appointment
            const appointment = window.patientDetailsManager?.appointments?.find(apt => apt.id === appointmentId);
            if (!appointment) {
                Utils.showToast('Randevu bulunamadƒ±', 'error');
                return;
            }
            
            const modalContent = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="editAppointmentDate" class="block text-sm font-medium text-gray-700">Randevu Tarihi</label>
                            <input type="date" id="editAppointmentDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="${appointment.date}">
                        </div>
                        <div>
                            <label for="editAppointmentTime" class="block text-sm font-medium text-gray-700">Saat</label>
                            <input type="time" id="editAppointmentTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="${appointment.time}">
                        </div>
                    </div>
                    <div>
                        <label for="editAppointmentType" class="block text-sm font-medium text-gray-700">Randevu T√ºr√º</label>
                        <select id="editAppointmentType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                            <option value="Genel Muayene" ${appointment.type === 'Genel Muayene' ? 'selected' : ''}>Genel Muayene</option>
                            <option value="ƒ∞≈üitme Testi" ${appointment.type === 'ƒ∞≈üitme Testi' ? 'selected' : ''}>ƒ∞≈üitme Testi</option>
                            <option value="Cihaz Denemesi" ${appointment.type === 'Cihaz Denemesi' ? 'selected' : ''}>Cihaz Denemesi</option>
                            <option value="Kontrol" ${appointment.type === 'Kontrol' ? 'selected' : ''}>Kontrol</option>
                            <option value="Bakƒ±m" ${appointment.type === 'Bakƒ±m' ? 'selected' : ''}>Bakƒ±m</option>
                            <option value="√ñd√º√ß Teslimi" ${appointment.type === '√ñd√º√ß Teslimi' ? 'selected' : ''}>√ñd√º√ß Teslimi</option>
                        </select>
                    </div>
                    <div>
                        <label for="editAppointmentStatus" class="block text-sm font-medium text-gray-700">Durum</label>
                        <select id="editAppointmentStatus" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                            <option value="scheduled" ${appointment.status === 'scheduled' ? 'selected' : ''}>Planlandƒ±</option>
                            <option value="completed" ${appointment.status === 'completed' ? 'selected' : ''}>Tamamlandƒ±</option>
                            <option value="cancelled" ${appointment.status === 'cancelled' ? 'selected' : ''}>ƒ∞ptal</option>
                            <option value="no-show" ${appointment.status === 'no-show' ? 'selected' : ''}>Gelmedi</option>
                        </select>
                    </div>
                    <div>
                        <label for="editAppointmentNotes" class="block text-sm font-medium text-gray-700">Notlar</label>
                        <textarea id="editAppointmentNotes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Randevu ile ilgili notlar...">${appointment.notes || ''}</textarea>
                    </div>
                </div>
            `;
            
            Utils.showModal({
                title: 'Randevu D√ºzenle',
                content: modalContent,
                primaryButton: {
                    text: 'Kaydet',
                    onClick: () => {
                        const date = document.getElementById('editAppointmentDate').value;
                        const time = document.getElementById('editAppointmentTime').value;
                        const type = document.getElementById('editAppointmentType').value;
                        const status = document.getElementById('editAppointmentStatus').value;
                        const notes = document.getElementById('editAppointmentNotes').value;
                        
                        if (!date || !time || !type) {
                            Utils.showToast('L√ºtfen t√ºm gerekli alanlarƒ± doldurun', 'error');
                            return;
                        }
                        
                        // Update appointment
                        appointment.date = date;
                        appointment.time = time;
                        appointment.type = type;
                        appointment.status = status;
                        appointment.notes = notes;
                        appointment.updatedAt = new Date().toISOString();
                        
                        // Save to storage
                        window.patientDetailsManager.savePatientToStorage();
                        
                        // Refresh appointments display
                        loadAppointments();
                        
                        Utils.showToast('Randevu ba≈üarƒ±yla g√ºncellendi', 'success');
                    }
                },
                secondaryButton: {
                    text: 'ƒ∞ptal',
                    onClick: () => {}
                }
            });
        }
        
        function cancelAppointment(appointmentId) {
            if (!confirm('Bu randevuyu iptal etmek istediƒüinizden emin misiniz?')) {
                return;
            }
            
            const appointment = window.patientDetailsManager?.appointments?.find(apt => apt.id === appointmentId);
            if (appointment) {
                appointment.status = 'cancelled';
                appointment.updatedAt = new Date().toISOString();
                
                // Save to storage
                window.patientDetailsManager.savePatientToStorage();
                
                // Refresh appointments display
                loadAppointments();
                
                Utils.showToast('Randevu iptal edildi', 'success');
            }
        }
        
        // Helper functions for device functionality
        function assignDevice(patientId) {
            const patient = window.patientDetailsManager?.currentPatient || {};
            
            const modalContent = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="deviceBrand" class="block text-sm font-medium text-gray-700">Marka</label>
                            <select id="deviceBrand" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                                <option value="">Marka se√ßin</option>
                                <option value="Phonak">Phonak</option>
                                <option value="Oticon">Oticon</option>
                                <option value="ReSound">ReSound</option>
                                <option value="Widex">Widex</option>
                                <option value="Signia">Signia</option>
                            </select>
                        </div>
                        <div>
                            <label for="deviceModel" class="block text-sm font-medium text-gray-700">Model</label>
                            <input type="text" id="deviceModel" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Cihaz modeli">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="deviceDirection" class="block text-sm font-medium text-gray-700">Kulak</label>
                            <select id="deviceDirection" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                                <option value="right">Saƒü Kulak</option>
                                <option value="left">Sol Kulak</option>
                                <option value="bilateral">Her ƒ∞ki Kulak</option>
                            </select>
                        </div>
                        <div>
                            <label for="deviceSerial" class="block text-sm font-medium text-gray-700">Seri No</label>
                            <input type="text" id="deviceSerial" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Seri numarasƒ±">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="deviceAssignDate" class="block text-sm font-medium text-gray-700">Atanma Tarihi</label>
                            <input type="date" id="deviceAssignDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div>
                            <label for="deviceWarranty" class="block text-sm font-medium text-gray-700">Garanti (Ay)</label>
                            <input type="number" id="deviceWarranty" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="24" min="0" max="60">
                        </div>
                    </div>
                    <div>
                        <label for="deviceNotes" class="block text-sm font-medium text-gray-700">Notlar</label>
                        <textarea id="deviceNotes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Cihaz atama notlarƒ±..."></textarea>
                    </div>
                </div>
            `;
            
            Utils.showModal({
                title: 'Cihaz Ata',
                content: modalContent,
                primaryButton: {
                    text: 'Cihazƒ± Ata',
                    onClick: () => {
                        const brand = document.getElementById('deviceBrand').value;
                        const model = document.getElementById('deviceModel').value;
                        const direction = document.getElementById('deviceDirection').value;
                        const serialNumber = document.getElementById('deviceSerial').value;
                        const assignDate = document.getElementById('deviceAssignDate').value;
                        const warranty = document.getElementById('deviceWarranty').value;
                        const notes = document.getElementById('deviceNotes').value;
                        
                        if (!brand || !model || !direction || !assignDate) {
                            Utils.showToast('L√ºtfen t√ºm gerekli alanlarƒ± doldurun', 'error');
                            return;
                        }
                        
                        // Calculate warranty end date
                        const warrantyEndDate = new Date(assignDate);
                        warrantyEndDate.setMonth(warrantyEndDate.getMonth() + parseInt(warranty));
                        
                        const newDevice = {
                            id: 'device_' + Date.now(),
                            patientId: patientId,
                            manufacturer: brand,
                            brand: brand,
                            model: model,
                            direction: direction,
                            serialNumber: serialNumber,
                            assignmentDate: assignDate,
                            warrantyPeriod: parseInt(warranty),
                            warrantyEndDate: warrantyEndDate.toISOString().split('T')[0],
                            notes: notes,
                            status: 'active',
                            createdAt: new Date().toISOString()
                        };
                        
                        // Add to patient devices
                        if (!patient.devices) {
                            patient.devices = [];
                        }
                        patient.devices.push(newDevice);
                        
                        // Also add to global devices if manager exists
                        if (!window.patientDetailsManager.devices) {
                            window.patientDetailsManager.devices = [];
                        }
                        window.patientDetailsManager.devices.push(newDevice);
                        
                        // Save to storage
                        window.patientDetailsManager.savePatientToStorage();
                        
                        // Refresh devices display
                        loadDevices();
                        
                        // Update timeline
                        if (typeof loadTimeline === 'function') {
                            loadTimeline();
                        }
                        
                        Utils.showToast('Cihaz ba≈üarƒ±yla atandƒ±', 'success');
                    }
                },
                secondaryButton: {
                    text: 'ƒ∞ptal',
                    onClick: () => {}
                }
            });
        }
        
        function editDevice(deviceId) {
            Utils.showToast('Cihaz d√ºzenleme √∂zelliƒüi yakƒ±nda eklenecek', 'info');
        }
        
        function deviceMaintenance(deviceId) {
            Utils.showToast('Cihaz bakƒ±m √∂zelliƒüi yakƒ±nda eklenecek', 'info');
        }
        
        function removeDevice(deviceId) {
            if (!confirm('Bu cihazƒ± kaldƒ±rmak istediƒüinizden emin misiniz?')) {
                return;
            }
            
            const patient = window.patientDetailsManager?.currentPatient || {};
            
            // Remove from patient devices
            if (patient.devices) {
                patient.devices = patient.devices.filter(device => device.id !== deviceId);
            }
            
            // Remove from global devices
            if (window.patientDetailsManager.devices) {
                window.patientDetailsManager.devices = window.patientDetailsManager.devices.filter(device => device.id !== deviceId);
            }
            
            // Save to storage
            window.patientDetailsManager.savePatientToStorage();
            
            // Refresh devices display
            loadDevices();
            
            Utils.showToast('Cihaz kaldƒ±rƒ±ldƒ±', 'success');
        }
        
        function startDeviceTrial(patientId) {
            Utils.showToast('Cihaz denemesi √∂zelliƒüi yakƒ±nda eklenecek', 'info');
        }
        
        // Helper functions for document functionality
        function uploadSpecificDocument(documentType) {
            uploadDocument(documentType);
        }
        
        function toggleDocumentActions(documentId) {
            const actionsElement = document.getElementById(`actions-${documentId}`);
            if (actionsElement) {
                actionsElement.classList.toggle('hidden');
            }
        }
        
        function viewDocument(documentId) {
            Utils.showToast('Belge g√∂r√ºnt√ºleme √∂zelliƒüi yakƒ±nda eklenecek', 'info');
        }
        
        function downloadDocument(documentId) {
            Utils.showToast('Belge indirme √∂zelliƒüi yakƒ±nda eklenecek', 'info');
        }
        
        function editDocument(documentId) {
            Utils.showToast('Belge d√ºzenleme √∂zelliƒüi yakƒ±nda eklenecek', 'info');
        }
        
        function shareDocument(documentId) {
            Utils.showToast('Belge payla≈üma √∂zelliƒüi yakƒ±nda eklenecek', 'info');
        }
        
        function deleteDocument(documentId) {
            if (!confirm('Bu belgeyi silmek istediƒüinizden emin misiniz?')) {
                return;
            }
            
            const patient = window.patientDetailsManager?.currentPatient || {};
            
            // Remove from patient documents
            if (patient.documents) {
                patient.documents = patient.documents.filter(doc => doc.id !== documentId);
            }
            
            // Remove from global documents
            if (window.patientDetailsManager.documents) {
                window.patientDetailsManager.documents = window.patientDetailsManager.documents.filter(doc => doc.id !== documentId);
            }
            
            // Save to storage
            window.patientDetailsManager.savePatientToStorage();
            
            // Refresh documents display
            loadPatientDocuments();
            
            Utils.showToast('Belge silindi', 'success');
        }
        
        // Helper functions for SGK functionality
        function updateSGKInfo(patientId) {
            Utils.showToast('SGK bilgi g√ºncelleme √∂zelliƒüi yakƒ±nda eklenecek', 'info');
        }
        
        function downloadSGKReport(patientId) {
            Utils.showToast('SGK rapor indirme √∂zelliƒüi yakƒ±nda eklenecek', 'info');
        }
        
        function checkSGKStatus(patientId) {
            Utils.showToast('SGK durum sorgulama √∂zelliƒüi yakƒ±nda eklenecek', 'info');
        }
        
        // E-Prescription material delivery function
        function deliverMaterial(receiptId, materialCode) {
            const patient = window.patientDetailsManager?.currentPatient || {};
            const receipt = patient.ereceiptHistory?.find(r => r.id === receiptId);
            
            if (!receipt) {
                Utils.showToast('E-re√ßete bulunamadƒ±', 'error');
                return;
            }
            
            const material = receipt.materials.find(m => m.code === materialCode);
            if (!material) {
                Utils.showToast('Malzeme bulunamadƒ±', 'error');
                return;
            }
            
            // Show delivery confirmation modal
            const modalContent = `
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-medium text-blue-900">Malzeme Teslim Onayƒ±</h4>
                        <p class="text-sm text-blue-700 mt-1">E-Re√ßete #${receipt.number}</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="font-medium text-gray-900">${material.name}</p>
                        <p class="text-sm text-gray-600">Kod: ${material.code}</p>
                    </div>
                    <div>
                        <label for="deliveryDate" class="block text-sm font-medium text-gray-700">Teslim Tarihi</label>
                        <input type="date" id="deliveryDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" 
                               value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div>
                        <label for="deliveryNotes" class="block text-sm font-medium text-gray-700">Teslim Notlarƒ±</label>
                        <textarea id="deliveryNotes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" 
                                  placeholder="Teslim ile ilgili notlar..."></textarea>
                    </div>
                </div>
            `;
            
            Utils.showModal({
                title: 'Malzeme Teslim Et',
                content: modalContent,
                primaryButton: {
                    text: 'Teslim Et',
                    onClick: () => {
                        const deliveryDate = document.getElementById('deliveryDate').value;
                        const deliveryNotes = document.getElementById('deliveryNotes').value;
                        
                        if (!deliveryDate) {
                            Utils.showToast('Teslim tarihi gerekli', 'error');
                            return;
                        }
                        
                        // Update material with delivery information
                        material.deliveryDate = deliveryDate;
                        material.deliveryNotes = deliveryNotes;
                        material.deliveredBy = 'Sistem Kullanƒ±cƒ±sƒ±'; // This would be current user
                        
                        // Save to storage
                        window.patientDetailsManager.savePatientToStorage();
                        
                        // Add timeline event
                        if (typeof loadTimeline === 'function') {
                            loadTimeline();
                        }
                        
                        // Refresh SGK tab
                        loadSGKInfo();
                        
                        Utils.showToast(`${material.name} ba≈üarƒ±yla teslim edildi`, 'success');
                    }
                },
                secondaryButton: {
                    text: 'ƒ∞ptal',
                    onClick: () => {}
                }
            });
        }
        
        // Print e-prescription function
        function printEPrescription(receiptId) {
            const patient = window.patientDetailsManager?.currentPatient || {};
            const receipt = patient.ereceiptHistory?.find(r => r.id === receiptId);
            
            if (!receipt) {
                Utils.showToast('E-re√ßete bulunamadƒ±', 'error');
                return;
            }
            
            // Create printable content
            const printContent = `
                <div style="font-family: Arial, sans-serif; padding: 20px;">
                    <h1>E-Re√ßete Malzeme Listesi</h1>
                    <div style="margin: 20px 0;">
                        <p><strong>E-Re√ßete No:</strong> ${receipt.number}</p>
                        <p><strong>Hasta:</strong> ${patient.name}</p>
                        <p><strong>TC No:</strong> ${patient.tcNumber}</p>
                        <p><strong>Doktor:</strong> ${receipt.doctorName}</p>
                        <p><strong>Tarih:</strong> ${new Date(receipt.date).toLocaleDateString('tr-TR')}</p>
                    </div>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                        <thead>
                            <tr style="background-color: #f3f4f6;">
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Malzeme Adƒ±</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Kod</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Ba≈üvuru Tarihi</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Teslim Durumu</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${receipt.materials.map(material => `
                                <tr>
                                    <td style="border: 1px solid #ccc; padding: 8px;">${material.name}</td>
                                    <td style="border: 1px solid #ccc; padding: 8px;">${material.code}</td>
                                    <td style="border: 1px solid #ccc; padding: 8px;">${new Date(material.applicationDate).toLocaleDateString('tr-TR')}</td>
                                    <td style="border: 1px solid #ccc; padding: 8px;">${material.deliveryDate ? `Teslim: ${new Date(material.deliveryDate).toLocaleDateString('tr-TR')}` : 'Beklemede'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Open print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }
        
        // Export e-prescription function
        function exportEPrescription(receiptId) {
            const patient = window.patientDetailsManager?.currentPatient || {};
            const receipt = patient.ereceiptHistory?.find(r => r.id === receiptId);
            
            if (!receipt) {
                Utils.showToast('E-re√ßete bulunamadƒ±', 'error');
                return;
            }
            
            // Create export data
            const exportData = {
                receiptNumber: receipt.number,
                patientName: patient.name,
                patientTC: patient.tcNumber,
                doctorName: receipt.doctorName,
                date: receipt.date,
                materials: receipt.materials.map(material => ({
                    name: material.name,
                    code: material.code,
                    applicationDate: material.applicationDate,
                    deliveryDate: material.deliveryDate || null,
                    deliveryNotes: material.deliveryNotes || '',
                    deliveredBy: material.deliveredBy || null
                }))
            };
            
            // Convert to JSON and download
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = `e-recete-${receipt.number}-${patient.name.replace(/\s+/g, '-')}.json`;
            downloadLink.click();
            
            URL.revokeObjectURL(url);
            Utils.showToast('E-re√ßete dƒ±≈üa aktarƒ±ldƒ±', 'success');
        }
    </script>

    <style>
        .tab-button {
            padding: 1rem 0;
            border-bottom: 2px solid transparent;
            color: #6B7280;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .tab-button:hover {
             color: #374151;
         }
         
         .tab-button.active {
             color: #2563EB;
             border-bottom-color: #2563EB;
         }
    </style>
</body>
</html>