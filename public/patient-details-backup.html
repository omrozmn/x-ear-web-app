<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hasta Detaylarƒ± - X-Ear CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="assets/js/pdf-converter.js"></script>
    <script src="assets/js/spacy-backend-client.js"></script>
    <script src="assets/js/spacy-nlp-service.js"></script>
    <script src="assets/js/patient-matching-service.js"></script>
    <script src="assets/js/ocr-engine.js"></script>
    <script src="assets/js/ocr-integration.js"></script>
    <script src="assets/js/image-processor.js"></script>
    <link rel="stylesheet" href="assets/style.css?v=6">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563EB',
                        'light-gray': '#F9FAFB'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-light-gray">
    <!-- Sidebar Navigation -->
    <div id="sidebar-container"></div>

    <!-- Patient List Sidebar -->
    <div id="patient-list-sidebar" class="patient-list-sidebar">
        <div class="p-4 border-b border-gray-200">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-semibold text-gray-900">Hastalar</h3>
                <button onclick="togglePatientList()" class="p-1 rounded hover:bg-gray-100" title="Hasta listesini gizle/g√∂ster">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
            </div>
            <div class="relative">
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <input type="text" id="patientSearchInput" placeholder="Hasta ara..." 
                       class="w-full pl-10 pr-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
        </div>
        <div class="patient-list-container" id="patientListContainer">
            <!-- Patient list will be populated by JavaScript -->
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content patient-details-content">
        <!-- Patient List Toggle Button (when collapsed) -->
        <button id="patient-list-toggle-collapsed" onclick="togglePatientList()" 
                class="fixed left-4 top-20 z-20 p-2 bg-white rounded-lg shadow-lg border border-gray-200 hover:bg-gray-50 transition-all duration-200" 
                style="display: none;" title="Hasta listesini a√ß">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
        </button>

        <!-- Header -->
        <div id="header-container"></div>

        <!-- Patient Profile Section -->
        <div class="p-6">
            <div id="patient-profile-container"></div>

            <!-- Summary Cards -->
            <div id="stats-container"></div>

            <!-- Tabs -->
            <div id="tabs-container"></div>

            <!-- Tab Content -->
            <div id="tab-content" class="mt-6">
                <!-- Dynamic tab content will be loaded here -->
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="modals-container"></div>

    <!-- Widget Scripts -->
    <script src="assets/js/utils.js?v=2"></script>
    <script src="assets/js/app.js"></script>
    <script src="assets/data.js"></script>
    <script src="assets/js/patients.js"></script>
    <script src="assets/js/sgk.js"></script>
    <script src="assets/js/appointments.js"></script>
    <script src="assets/js/devices.js"></script>
    <script>
        // Initialize managers
        document.addEventListener('DOMContentLoaded', () => {
            if (!window.sgkManager) {
                window.sgkManager = new SGKManager();
            }
            
            // Make PatientManager available as patientManager for consistency
            if (window.PatientManager && !window.patientManager) {
                window.patientManager = window.PatientManager;
                console.log('PatientManager reference created successfully');
            }
        });
    </script>
    <script src="assets/js/document-manager.js"></script>
    <script src="assets/js/sgk-document-pipeline.js"></script>
    <script src="assets/js/global-search.js"></script>
    <script src="assets/js/sms-gateway.js"></script>
    <script src="assets/js/email-manager.js"></script>
    <script src="assets/js/data-export-import.js"></script>
    <script src="assets/js/patient-details-new.js"></script>
    <script src="assets/js/widget-loader.js"></script>
    <script src="assets/js/patient-details-tab-loader.js"></script>

    <script>
        // Global variables
        let currentPatientId = getPatientIdFromURL();
        let patientProfile, tabNavigation, statsCards;

        // Get patient ID from URL parameters
        function getPatientIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('patient') || urlParams.get('id') || 'p1';
        }

        // Get tab parameter from URL
        function getTabFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('tab') || null;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Ensure sample data is properly set up
            setupSampleData();
            
            await initializeWidgets();
            await loadPatientList();
            loadPatientData();
            setupPatientSearch();
            adjustLayoutForSidebars();
            
            // Initialize SGK Pipeline
            if (typeof SGKDocumentPipeline !== 'undefined') {
                window.sgkPipeline = new SGKDocumentPipeline();
                console.log('‚úÖ SGK Document Pipeline initialized');
            }
            
            // Initialize document manager
            if (typeof DocumentManager !== 'undefined') {
                window.documentManager = new DocumentManager();
                console.log('‚úÖ Document Manager initialized');
            }
            
            // Add window resize listener to recalculate patient list width
            window.addEventListener('resize', function() {
                updateLayoutMargins();
            });
        });

        // Function to set up sample data properly
        function setupSampleData() {
            console.log('üîÑ Setting up sample data for patient details...');
            
            // Initialize sampleData object if it doesn't exist
            if (!window.sampleData) {
                window.sampleData = {};
                console.log('üìù Created new sampleData object');
            }
            
            // Check if global variables exist from data.js
            if (typeof samplePatients !== 'undefined' && Array.isArray(samplePatients)) {
                window.sampleData.patients = samplePatients;
                console.log(`‚úÖ Sample patients loaded: ${samplePatients.length} patients`);
            } else {
                console.warn('‚ö†Ô∏è samplePatients not found, using fallback data');
                window.sampleData.patients = [];
            }
            
            if (typeof sampleAppointments !== 'undefined' && Array.isArray(sampleAppointments)) {
                window.sampleData.appointments = sampleAppointments;
                console.log(`‚úÖ Sample appointments loaded: ${sampleAppointments.length} appointments`);
            } else {
                console.warn('‚ö†Ô∏è sampleAppointments not found');
                window.sampleData.appointments = [];
            }
            
            if (typeof sampleInventory !== 'undefined' && Array.isArray(sampleInventory)) {
                window.sampleData.inventory = sampleInventory;
                console.log(`‚úÖ Sample inventory loaded: ${sampleInventory.length} items`);
            } else {
                console.warn('‚ö†Ô∏è sampleInventory not found');
                window.sampleData.inventory = [];
            }
            
            if (typeof sampleCampaigns !== 'undefined' && Array.isArray(sampleCampaigns)) {
                window.sampleData.campaigns = sampleCampaigns;
                console.log(`‚úÖ Sample campaigns loaded: ${sampleCampaigns.length} campaigns`);
            } else {
                console.warn('‚ö†Ô∏è sampleCampaigns not found');
                window.sampleData.campaigns = [];
            }
            
            console.log('‚úÖ Sample data setup complete');
            console.log('üìä Final sampleData structure:', {
                patients: window.sampleData.patients?.length || 0,
                appointments: window.sampleData.appointments?.length || 0,
                inventory: window.sampleData.inventory?.length || 0,
                campaigns: window.sampleData.campaigns?.length || 0
            });
        }

        async function initializeWidgets() {
            console.log('üîÑ Initializing widgets...');
            
            try {
                // Use existing widget loader instance
                const loader = window.widgetLoader;
                
                if (!loader) {
                    console.error('‚ùå Widget loader not found!');
                    return;
                }
                
                // Initialize widgets for patient-details page
                await loader.initPageWidgets('patient-details');
                console.log('‚úÖ Page widgets initialized');
                
                // Load additional widgets needed for this page
                await loader.loadWidgets(['stats-card', 'patient-profile', 'tab-navigation']);
                console.log('‚úÖ Additional widgets loaded');
                
                // Render sidebar and header
                const sidebarContainer = document.getElementById('sidebar-container');
                if (sidebarContainer && typeof SidebarWidget !== 'undefined') {
                    const sidebar = new SidebarWidget('patients');
                    sidebarContainer.innerHTML = sidebar.render();
                    console.log('‚úÖ Sidebar rendered');
                } else {
                    console.warn('‚ö†Ô∏è Sidebar container not found or SidebarWidget not available');
                }

                // Initialize header
                const headerContainer = document.getElementById('header-container');
                if (headerContainer && typeof HeaderWidget !== 'undefined') {
                    const header = new HeaderWidget('Hasta Detaylarƒ±');
                    headerContainer.innerHTML = header.render();
                    console.log('‚úÖ Header rendered');
                } else {
                    console.warn('‚ö†Ô∏è Header container not found or HeaderWidget not available');
                }

                // Initialize patient profile
                if (typeof PatientProfileWidget !== 'undefined') {
                    patientProfile = PatientProfileWidget.createDefault('patient-profile-container');
                    window.patientProfile = patientProfile; // Make it globally accessible
                    patientProfile.render();
                    console.log('‚úÖ Patient profile initialized');
                } else {
                    console.error('‚ùå PatientProfileWidget not available');
                }

            // Initialize stats cards
            const statsContainer = document.getElementById('stats-container');
            if (statsContainer && typeof StatsCardWidget !== 'undefined') {
                const statsData = [
                    new StatsCardWidget({
                        title: 'Toplam Randevu',
                        value: '5',
                        color: 'blue',
                        icon: `<svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                        </svg>`
                    }),
                    new StatsCardWidget({
                        title: 'Cihaz Sayƒ±sƒ±',
                        value: '1',
                        color: 'green',
                        icon: `<svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                        </svg>`
                    }),
                    new StatsCardWidget({
                        title: 'Toplam Harcama',
                        value: '‚Ç∫15.000',
                        color: 'yellow',
                        icon: `<svg class="w-6 h-6 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"/>
                        </svg>`
                    }),
                    new StatsCardWidget({
                        title: 'M√º≈üteri S√ºresi',
                        value: '2 ay',
                        color: 'purple',
                        icon: `<svg class="w-6 h-6 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                        </svg>`
                    })
                ];
                
                const cardsHtml = statsData.map(card => card.render()).join('');
                statsContainer.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">${cardsHtml}</div>`;
            }

            // Initialize tab navigation
            const tabsContainer = document.getElementById('tabs-container');
            if (tabsContainer && typeof TabNavigationWidget !== 'undefined') {
                tabNavigation = TabNavigationWidget.createPatientDetailsTabs('tabs-container');
                tabNavigation.render();
                
                // Add tab change listener to load data when Sales tab is selected
                const originalSwitchTab = tabNavigation.switchTab.bind(tabNavigation);
                tabNavigation.switchTab = function(tabId) {
                    originalSwitchTab(tabId);
                    
                    // Load sales data when sales tab is activated
                    if (tabId === 'sales') {
                        setTimeout(() => {
                            loadSalesData();
                        }, 100);
                    }
                    
                    // Load E-re√ßete data when documents tab is activated
                    if (tabId === 'documents') {
                        setTimeout(() => {
                            loadDocumentsTabData();
                        }, 100);
                    }
                };
                
                // Check if a specific tab was requested in the URL
                const requestedTab = getTabFromURL();
                if (requestedTab) {
                    setTimeout(() => {
                        console.log(`üîó Switching to requested tab: ${requestedTab}`);
                        tabNavigation.switchTab(requestedTab);
                    }, 500); // Give time for the widget to fully initialize
                }
            }
            } catch (error) {
                console.error('‚ùå Error initializing widgets:', error);
            }
        }

        // Function to load a specific patient (can be called from external scripts)
        function loadPatient(patientId, tabId = null) {
            console.log(`üîó Loading patient: ${patientId}, tab: ${tabId}`);
            
            if (patientId && patientId !== currentPatientId) {
                currentPatientId = patientId;
                loadPatientData();
                
                // Update URL without reloading page
                const newUrl = new URL(window.location);
                newUrl.searchParams.set('patient', patientId);
                if (tabId) {
                    newUrl.searchParams.set('tab', tabId);
                }
                window.history.pushState({}, '', newUrl);
            }
            
            // Switch to requested tab if specified
            if (tabId && tabNavigation) {
                setTimeout(() => {
                    tabNavigation.switchTab(tabId);
                }, 200);
            }
        }

        // Export loadPatient function for external use
        window.patientDetailsManager = {
            loadPatient: loadPatient,
            getCurrentPatientId: () => currentPatientId,
            patients: () => window.sampleData?.patients || []
        };

        function loadPatientData() {
            console.log('üîÑ Loading patient data for ID:', currentPatientId);
            
            // Load patient data from sample data or use default
            let patientData = null;
            
            // Try to find patient in sample data
            if (window.sampleData && window.sampleData.patients) {
                console.log(`üìä Found ${window.sampleData.patients.length} patients in sample data`);
                patientData = window.sampleData.patients.find(p => p.id === currentPatientId);
                if (patientData) {
                    console.log('‚úÖ Found patient in sample data:', patientData.name);
                }
            }
            
            // Try to find in global patient database if not found
            if (!patientData && window.patientDatabase && Array.isArray(window.patientDatabase)) {
                console.log(`üìä Checking global patient database: ${window.patientDatabase.length} patients`);
                patientData = window.patientDatabase.find(p => p.id === currentPatientId);
                if (patientData) {
                    console.log('‚úÖ Found patient in global database:', patientData.name);
                }
            }
            
            // Try to find in localStorage patients
            if (!patientData) {
                try {
                    const localPatients = JSON.parse(localStorage.getItem('patients') || '[]');
                    console.log(`üìä Checking localStorage: ${localPatients.length} patients`);
                    patientData = localPatients.find(p => p.id === currentPatientId);
                    if (patientData) {
                        console.log('‚úÖ Found patient in localStorage:', patientData.name || `${patientData.firstName} ${patientData.lastName}`);
                    }
                } catch (error) {
                    console.warn('Error checking localStorage patients:', error);
                }
            }
            
            if (!patientData) {
                console.log('‚ö†Ô∏è Patient not found in any data source, using default');
            }
            
            // Use default data if patient not found
            if (!patientData) {
                patientData = {
                    id: currentPatientId,
                    name: 'Bilinmeyen Hasta',
                    firstName: 'Bilinmeyen',
                    lastName: 'Hasta',
                    tcNumber: 'Bilinmiyor',
                    tc: 'Bilinmiyor',
                    phone: 'Bilinmiyor',
                    email: 'Bilinmiyor',
                    birthDate: '1980-01-01',
                    address: 'Bilinmiyor',
                    status: 'Aktif',
                    segment: 'Deneme',
                    sgkStatus: 'SGK Onaylƒ±',
                    lastVisit: '15 Ocak 2024',
                    notes: 'Sol kulak i≈üitme kaybƒ±, deneme cihazƒ± kullanƒ±yor',
                    eReceiptNo: ''
                };
            }

            // Ensure data consistency - synchronize all name and TC fields
            if (patientData.firstName && patientData.lastName) {
                patientData.name = `${patientData.firstName} ${patientData.lastName}`;
            } else if (patientData.name) {
                const nameParts = patientData.name.split(' ');
                if (nameParts.length > 1) {
                    patientData.firstName = nameParts[0];
                    patientData.lastName = nameParts.slice(1).join(' ');
                } else {
                    patientData.firstName = patientData.name;
                    patientData.lastName = '';
                }
            }

            // Synchronize TC fields
            if (patientData.tcNumber) {
                patientData.tc = patientData.tcNumber;
            } else if (patientData.tc) {
                patientData.tcNumber = patientData.tc;
            }

            // Calculate age if birthDate exists
            if (patientData.birthDate) {
                patientData.age = Utils.calculateAge(patientData.birthDate);
            }

            // Store patient data in global manager for document naming
            if (!window.patientDetailsManager) {
                window.patientDetailsManager = {};
            }
            window.patientDetailsManager.currentPatient = patientData;
            console.log('‚úÖ Patient data stored in global manager:', patientData.name);

            // Recreate patient profile with actual data
            if (patientProfile) {
                // Debug i√ßin konsola yazdƒ±r
                console.log('loadPatientData - patientData:', patientData);
                
                patientProfile = new PatientProfileWidget('patient-profile-container', patientData);
                window.patientProfile = patientProfile; // Make it globally accessible
                patientProfile.render();
                
                // Add label update button after profile is rendered
                setTimeout(() => {
                    if (typeof addLabelUpdateButton === 'function') {
                        addLabelUpdateButton();
                    }
                }, 100);
            }
            
            // Load tab-specific data
            loadPersonalInfo(patientData);
            loadAppointments();
            loadDevices();
            loadNotes();
            loadSGKInfo();
            loadTimeline();
        }

        function loadPersonalInfo(patientData) {
            const personalInfoContainer = document.getElementById('personalInfo');
            if (personalInfoContainer) {
                // TC ve ya≈ü bilgilerini uyumlu hale getir ve senkronize et
                const tcNumber = patientData.tc || patientData.tcNumber || '';
                // Her iki alanƒ± da g√ºncelle
                patientData.tc = tcNumber;
                patientData.tcNumber = tcNumber;
                
                const age = patientData.age || (patientData.birthDate ? Utils.calculateAge(patientData.birthDate) : '');
                const phone = patientData.phone || '';
                
                // Ya≈ü bilgisini de g√ºncelle
                if (patientData.birthDate && !patientData.age) {
                    patientData.age = age;
                }
                
                // Debug i√ßin konsola yazdƒ±r
                console.log('loadPersonalInfo:', {
                    name: patientData.name,
                    tc: patientData.tc,
                    tcNumber: patientData.tcNumber,
                    phone: patientData.phone,
                    age: age
                });
                
                personalInfoContainer.innerHTML = `
                    <div class="flex justify-between">
                        <span class="text-gray-600">Ad Soyad:</span>
                        <span class="font-medium">${patientData.name}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">TC Kimlik:</span>
                        <span class="font-medium">${tcNumber}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Telefon:</span>
                        <span class="font-medium">${phone}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">E-posta:</span>
                        <span class="font-medium">${patientData.email}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Doƒüum Tarihi:</span>
                        <span class="font-medium">${patientData.birthDate}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Ya≈ü:</span>
                        <span class="font-medium">${age}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Adres:</span>
                        <span class="font-medium">${patientData.address}</span>
                    </div>
                `;
                
                // PatientProfileWidget'ƒ± da g√ºncelle eƒüer varsa
                if (window.patientProfile && window.patientProfile.updatePatientData) {
                    window.patientProfile.updatePatientData({
                        name: patientData.name,
                        tc: tcNumber,
                        tcNumber: tcNumber,
                        phone: phone,
                        birthDate: patientData.birthDate,
                        email: patientData.email,
                        address: patientData.address,
                        status: patientData.status,
                        segment: patientData.segment,
                        sgkStatus: patientData.sgkStatus,
                        lastVisit: patientData.lastVisit,
                        age: age
                    });
                }
            }
        }

        // TC Kimlik No doƒürulama fonksiyonu
        function validateTcNumber(input) {
            const tcNumber = input.value.trim();
            const errorElement = document.getElementById('tcNumberEditError');
            
            if (tcNumber && !Utils.validateTCKN(tcNumber)) {
                input.classList.add('border-red-500');
                errorElement.classList.remove('hidden');
                return false;
            } else {
                input.classList.remove('border-red-500');
                errorElement.classList.add('hidden');
                return true;
            }
        }
        
        // Telefon numarasƒ± doƒürulama fonksiyonu
        function validatePhoneNumber(input) {
            const phone = input.value.trim();
            const errorElement = document.getElementById('phoneEditError');
            
            if (phone && !Utils.validatePhone(phone)) {
                input.classList.add('border-red-500');
                errorElement.classList.remove('hidden');
                return false;
            } else {
                input.classList.remove('border-red-500');
                errorElement.classList.add('hidden');
                return true;
            }
        }

        // Placeholder functions for patient actions
        window.editPatient = function() {
            // Get the current patient data
            const patient = window.patientDetailsManager?.currentPatient || {};
            
            // Ad ve soyad alanlarƒ±nƒ± ayƒ±r
            let firstName = patient.firstName || '';
            let lastName = patient.lastName || '';
            
            // Eƒüer firstName ve lastName yoksa ama name varsa, name'i par√ßala
            if ((!firstName || !lastName) && patient.name) {
                const nameParts = patient.name.split(' ');
                if (nameParts.length > 1) {
                    firstName = nameParts[0];
                    lastName = nameParts.slice(1).join(' ');
                } else {
                    firstName = patient.name;
                }
            }
            
            // Create modal content
            const modalContent = `
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="firstName" class="block text-sm font-medium text-gray-700">Ad</label>
                            <input type="text" id="firstName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="${firstName}">
                        </div>
                        <div>
                            <label for="lastName" class="block text-sm font-medium text-gray-700">Soyad</label>
                            <input type="text" id="lastName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="${lastName}">
                        </div>
                    </div>
                    <div>
                        <label for="tcNumber" class="block text-sm font-medium text-gray-700">TC Kimlik No</label>
                        <input type="text" id="tcNumber" maxlength="11" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="${patient.tcNumber || ''}" onblur="validateTcNumber(this)">
                        <p id="tcNumberEditError" class="text-xs text-red-500 mt-1 hidden">Ge√ßersiz TC Kimlik Numarasƒ±!</p>
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700">Telefon</label>
                        <input type="text" id="phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="${patient.phone || ''}" onblur="validatePhoneNumber(this)">
                        <p id="phoneEditError" class="text-xs text-red-500 mt-1 hidden">Ge√ßersiz telefon numarasƒ±! √ñrnek: (90)5553332211</p>
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">E-posta</label>
                        <input type="email" id="email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="${patient.email || ''}">
                    </div>
                    <div>
                        <label for="erecepteNo" class="block text-sm font-medium text-gray-700">E-re√ßete No</label>
                        <div class="flex gap-2">
                            <input type="text" id="erecepteNo" placeholder="E-re√ßete numarasƒ±nƒ± girin" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="${patient.erecepteNo || ''}">
                            <button type="button" onclick="queryErecepte()" class="mt-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-200">
                                Sorgula
                            </button>
                        </div>
                        <p id="erecepteStatus" class="text-xs mt-1 hidden"></p>
                    </div>
                    <div>
                        <label for="birthDate" class="block text-sm font-medium text-gray-700">Doƒüum Tarihi</label>
                        <input type="date" id="birthDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="${patient.birthDate ? new Date(patient.birthDate).toISOString().split('T')[0] : ''}">
                    </div>
                    <div>
                        <label for="address" class="block text-sm font-medium text-gray-700">Adres</label>
                        <textarea id="address" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">${patient.address || ''}</textarea>
                    </div>
                    <div>
                        <label for="acquisitionType" class="block text-sm font-medium text-gray-700">Kazanƒ±m T√ºr√º</label>
                        <select id="acquisitionType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                            <option value="tabela" ${patient.acquisitionType === 'tabela' ? 'selected' : ''}>Tabela</option>
                            <option value="sosyal_medya" ${patient.acquisitionType === 'sosyal_medya' ? 'selected' : ''}>Sosyal Medya</option>
                            <option value="tanitim" ${patient.acquisitionType === 'tanitim' ? 'selected' : ''}>Tanƒ±tƒ±m</option>
                            <option value="referans" ${patient.acquisitionType === 'referans' ? 'selected' : ''}>Referans</option>
                            <option value="diger" ${patient.acquisitionType === 'diger' ? 'selected' : ''}>Diƒüer</option>
                        </select>
                    </div>
                    <div>
                        <label for="conversionStep" class="block text-sm font-medium text-gray-700">D√∂n√º≈ü√ºm Adƒ±mƒ±</label>
                        <select id="conversionStep" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                            <option value="lead" ${patient.conversionStep === 'lead' ? 'selected' : ''}>Potansiyel M√º≈üteri</option>
                            <option value="contacted" ${patient.conversionStep === 'contacted' ? 'selected' : ''}>ƒ∞leti≈üim Kuruldu</option>
                            <option value="appointment_scheduled" ${patient.conversionStep === 'appointment_scheduled' ? 'selected' : ''}>Randevu Verildi</option>
                            <option value="visited" ${patient.conversionStep === 'visited' ? 'selected' : ''}>Merkez Ziyareti</option>
                            <option value="hearing_test_done" ${patient.conversionStep === 'hearing_test_done' ? 'selected' : ''}>ƒ∞≈üitme Testi Yapƒ±ldƒ±</option>
                            <option value="device_trial" ${patient.conversionStep === 'device_trial' ? 'selected' : ''}>Cihaz Denemesi</option>
                            <option value="proposal_given" ${patient.conversionStep === 'proposal_given' ? 'selected' : ''}>Teklif Verildi</option>
                            <option value="negotiation" ${patient.conversionStep === 'negotiation' ? 'selected' : ''}>Pazarlƒ±k</option>
                            <option value="purchased" ${patient.conversionStep === 'purchased' ? 'selected' : ''}>Satƒ±n Aldƒ±</option>
                            <option value="follow_up" ${patient.conversionStep === 'follow_up' ? 'selected' : ''}>Takip</option>
                            <option value="lost" ${patient.conversionStep === 'lost' ? 'selected' : ''}>Kaybedildi</option>
                        </select>
                    </div>
                </div>
            `;
            
            // Show modal
            Utils.showModal({
                title: 'Hasta Bilgilerini D√ºzenle',
                content: modalContent,
                primaryButton: {
                    text: 'Kaydet',
                    onClick: () => {
                        // Get form values
                        const tcNumber = document.getElementById('tcNumber').value;
                        
                        // TC Kimlik No doƒürulama
                        if (tcNumber && !Utils.validateTCKN(tcNumber)) {
                            Utils.showToast('Ge√ßersiz TC Kimlik Numarasƒ±! L√ºtfen kontrol ediniz.', 'error');
                            return false;
                        }
                        
                        // Telefon numarasƒ± doƒürulama
                        const phone = document.getElementById('phone').value;
                        if (phone && !Utils.validatePhone(phone)) {
                            Utils.showToast('Ge√ßersiz telefon numarasƒ±! L√ºtfen kontrol ediniz.', 'error');
                            return false;
                        }
                        
                        const updatedPatient = {
                            ...patient,
                            firstName: document.getElementById('firstName').value,
                            lastName: document.getElementById('lastName').value,
                            tcNumber: tcNumber,
                            tc: tcNumber, // TC alanƒ±nƒ± da g√ºncelle
                            phone: document.getElementById('phone').value,
                            email: document.getElementById('email').value,
                            birthDate: document.getElementById('birthDate').value,
                            address: document.getElementById('address').value,
                            acquisitionType: document.getElementById('acquisitionType').value,
                            conversionStep: document.getElementById('conversionStep').value,
                            name: document.getElementById('firstName').value + ' ' + document.getElementById('lastName').value,
                            eReceiptNo: document.getElementById('eReceiptNo') ? document.getElementById('eReceiptNo').value : ''
                        };
                        
                        // Update patient data
                        if (window.patientDetailsManager) {
                            // Calculate age if needed
                            if (updatedPatient.birthDate && !updatedPatient.age) {
                                updatedPatient.age = Utils.calculateAge(updatedPatient.birthDate);
                            }
                            
                            window.patientDetailsManager.currentPatient = updatedPatient;
                            window.patientDetailsManager.savePatientToStorage();
                            
                            // Update all patient displays using our central function
                            updateAllPatientDisplays(updatedPatient);
                            
                            // Render other components that might need updating
                            if (window.patientDetailsManager.renderPatientProfile) {
                                window.patientDetailsManager.renderPatientProfile();
                            }
                            if (window.patientDetailsManager.renderGeneralTab) {
                                window.patientDetailsManager.renderGeneralTab();
                            }
                            
                            Utils.showToast('Hasta bilgileri g√ºncellendi', 'success');
                        } else {
                            Utils.showToast('Hasta bilgileri g√ºncellenemedi', 'error');
                        }
                    }
                },
                secondaryButton: {
                    text: 'ƒ∞ptal',
                    onClick: () => {}
                }
            });
        }

        function addAppointment(patientId) {
            // Get the current patient data
            const patient = window.patientDetailsManager?.currentPatient || {};
            
            // Create modal content
            const modalContent = `
                <div class="space-y-4">
                    <div>
                        <label for="appointmentDate" class="block text-sm font-medium text-gray-700">Randevu Tarihi</label>
                        <input type="date" id="appointmentDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div>
                        <label for="appointmentTime" class="block text-sm font-medium text-gray-700">Randevu Saati</label>
                        <input type="time" id="appointmentTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="09:00">
                    </div>
                    <div>
                        <label for="appointmentType" class="block text-sm font-medium text-gray-700">Randevu Tipi</label>
                        <select id="appointmentType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                            <option value="initial">ƒ∞lk G√∂r√º≈üme</option>
                            <option value="follow-up">Kontrol</option>
                            <option value="device-trial">Cihaz Denemesi</option>
                            <option value="device-fitting">Cihaz Ayarƒ±</option>
                            <option value="other">Diƒüer</option>
                        </select>
                    </div>
                    <div>
                        <label for="appointmentNotes" class="block text-sm font-medium text-gray-700">Randevu Notlarƒ±</label>
                        <textarea id="appointmentNotes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Randevu ile ilgili notlar..."></textarea>
                    </div>
                </div>
            `;
            
            // Show modal
            Utils.showModal({
                title: 'Yeni Randevu Ekle',
                content: modalContent,
                primaryButton: {
                    text: 'Kaydet',
                    onClick: () => {
                        // Get form values
                        const appointmentDate = document.getElementById('appointmentDate').value;
                        const appointmentTime = document.getElementById('appointmentTime').value;
                        const appointmentType = document.getElementById('appointmentType').value;
                        const appointmentNotes = document.getElementById('appointmentNotes').value;
                        
                        if (!appointmentDate || !appointmentTime) {
                            Utils.showToast('L√ºtfen tarih ve saat alanlarƒ±nƒ± doldurun', 'error');
                            return;
                        }
                        
                        // Create new appointment
                        const newAppointment = {
                            id: 'app_' + Date.now(),
                            patientId: patientId || patient.id,
                            patientName: patient.name || patient.firstName + ' ' + patient.lastName,
                            date: appointmentDate,
                            time: appointmentTime,
                            type: appointmentType,
                            notes: appointmentNotes,
                            status: 'scheduled',
                            createdAt: new Date().toISOString()
                        };
                        
                        // Save appointment to multiple data stores for consistency
                        saveAppointmentToAllStores(newAppointment);
                        
                        // Add appointment to patient
                        if (window.patientDetailsManager) {
                            // Initialize appointments array if it doesn't exist
                            if (!window.patientDetailsManager.appointments) {
                                window.patientDetailsManager.appointments = [];
                            }
                            
                            // Add new appointment
                            window.patientDetailsManager.appointments.push(newAppointment);
                            
                            // Update patient label if needed
                            if (patient.currentLabel !== 'Kontrol Hastasƒ±') {
                                window.patientDetailsManager.currentPatient.currentLabel = 'Randevu Verildi';
                                window.patientDetailsManager.savePatientToStorage();
                                window.patientDetailsManager.renderPatientProfile();
                                window.patientDetailsManager.renderGeneralTab();
                            }
                            
                            // Refresh appointments display
                            loadAppointments();
                            
                            Utils.showToast('Randevu ba≈üarƒ±yla eklendi', 'success');
                        } else {
                            Utils.showToast('Randevu eklenemedi', 'error');
                        }
                    }
                },
                secondaryButton: {
                    text: 'ƒ∞ptal',
                    onClick: () => {}
                }
            });
        }

        // Helper function to save appointment to all data stores
        function saveAppointmentToAllStores(appointment) {
            try {
                // 1. Save to localStorage appointments
                let storedAppointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                storedAppointments.push(appointment);
                localStorage.setItem('appointments', JSON.stringify(storedAppointments));
                
                // 2. Save to global sample data if available
                if (window.sampleData && window.sampleData.appointments) {
                    window.sampleData.appointments.push(appointment);
                }
                
                // 3. Add to any global appointments array if it exists
                if (typeof window.appointments !== 'undefined') {
                    window.appointments.push(appointment);
                }
                
                console.log('Appointment saved to all stores:', appointment);
            } catch (error) {
                console.error('Error saving appointment to stores:', error);
            }
        }

        function sendSMS() {
            // Get the current patient data
            const patient = window.patientDetailsManager?.currentPatient || {};
            
            // Check if patient has a phone number
            if (!patient.phone) {
                Utils.showToast('Hastanƒ±n telefon numarasƒ± bulunamadƒ±', 'error');
                return;
            }
            
            // Create modal content
            const modalContent = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Alƒ±cƒ±</label>
                        <div class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 py-2 px-3">
                            ${patient.firstName} ${patient.lastName} (${formatPhoneNumber(patient.phone)})
                        </div>
                    </div>
                    <div>
                        <label for="smsTemplate" class="block text-sm font-medium text-gray-700">≈ûablon</label>
                        <select id="smsTemplate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                            <option value="">≈ûablon se√ßin...</option>
                            <option value="appointment_reminder">Randevu Hatƒ±rlatma</option>
                            <option value="appointment_confirmation">Randevu Onayƒ±</option>
                            <option value="birthday">Doƒüum G√ºn√º Kutlama</option>
                            <option value="follow_up">Kontrol Hatƒ±rlatma</option>
                            <option value="custom">√ñzel Mesaj</option>
                        </select>
                    </div>
                    <div>
                        <label for="smsMessage" class="block text-sm font-medium text-gray-700">Mesaj</label>
                        <textarea id="smsMessage" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Mesaj metni..."></textarea>
                        <p class="mt-1 text-sm text-gray-500">Karakter sayƒ±sƒ±: <span id="charCount">0</span>/160</p>
                    </div>
                </div>
            `;
            
            // Show modal
            Utils.showModal({
                title: 'SMS G√∂nder',
                content: modalContent,
                primaryButton: {
                    text: 'G√∂nder',
                    onClick: () => {
                        // Get form values
                        const message = document.getElementById('smsMessage').value;
                        
                        if (!message) {
                            Utils.showToast('L√ºtfen bir mesaj girin', 'error');
                            return;
                        }
                        
                        // In a real application, we would send the SMS through an API here
                        // For this demo, we'll simulate a successful send
                        
                        // Create new SMS record
                        const newSMS = {
                            id: 'sms_' + Date.now(),
                            patientId: patient.id,
                            patientName: `${patient.firstName} ${patient.lastName}`,
                            phoneNumber: patient.phone,
                            message: message,
                            sentAt: new Date().toISOString(),
                            status: 'sent'
                        };
                        
                        // Add SMS to patient
                        if (window.patientDetailsManager) {
                            // Initialize SMS array if it doesn't exist
                            if (!window.patientDetailsManager.smsHistory) {
                                window.patientDetailsManager.smsHistory = [];
                            }
                            
                            // Add new SMS
                            window.patientDetailsManager.smsHistory.push(newSMS);
                            window.patientDetailsManager.savePatientToStorage();
                            
                            // Update timeline
                            if (typeof loadTimeline === 'function') {
                                loadTimeline();
                            }
                            
                            Utils.showToast('SMS ba≈üarƒ±yla g√∂nderildi', 'success');
                        } else {
                            Utils.showToast('SMS g√∂nderilemedi', 'error');
                        }
                    }
                },
                secondaryButton: {
                    text: 'ƒ∞ptal',
                    onClick: () => {}
                }
            });
            
            // Add event listeners
            setTimeout(() => {
                const smsTemplate = document.getElementById('smsTemplate');
                const smsMessage = document.getElementById('smsMessage');
                const charCount = document.getElementById('charCount');
                
                if (smsTemplate && smsMessage && charCount) {
                    // Template selection
                    smsTemplate.addEventListener('change', function() {
                        const template = this.value;
                        let messageText = '';
                        
                        switch (template) {
                            case 'appointment_reminder':
                                messageText = `Sayƒ±n ${patient.firstName} ${patient.lastName}, yarƒ±nki randevunuzu hatƒ±rlatƒ±rƒ±z. Randevu saatiniz: 14:00. ƒ∞≈üitme Merkezi`;
                                break;
                            case 'appointment_confirmation':
                                messageText = `Sayƒ±n ${patient.firstName} ${patient.lastName}, randevunuz onaylanmƒ±≈ütƒ±r. Tarih: ${new Date().toLocaleDateString('tr-TR')}, Saat: 14:00. ƒ∞≈üitme Merkezi`;
                                break;
                            case 'birthday':
                                messageText = `Sayƒ±n ${patient.firstName} ${patient.lastName}, doƒüum g√ºn√ºn√ºz√º kutlar, saƒülƒ±klƒ± ve mutlu bir yƒ±l dileriz. ƒ∞≈üitme Merkezi`;
                                break;
                            case 'follow_up':
                                messageText = `Sayƒ±n ${patient.firstName} ${patient.lastName}, kontrol zamanƒ±nƒ±z gelmi≈ütir. L√ºtfen randevu almak i√ßin bizi arayƒ±nƒ±z. ƒ∞≈üitme Merkezi`;
                                break;
                            default:
                                messageText = '';
                        }
                        
                        smsMessage.value = messageText;
                        charCount.textContent = messageText.length;
                    });
                    
                    // Character count
                    smsMessage.addEventListener('input', function() {
                        charCount.textContent = this.value.length;
                        if (this.value.length > 160) {
                            charCount.classList.add('text-red-500');
                        } else {
                            charCount.classList.remove('text-red-500');
                        }
                    });
                }
            }, 100);
        }
        
        // Helper function to format phone number
        function formatPhoneNumber(phoneNumber) {
            // Remove non-numeric characters
            const cleaned = ('' + phoneNumber).replace(/\D/g, '');
            
            // Check if the input is valid
            const match = cleaned.match(/^(\d{3})(\d{3})(\d{4})$/);
            if (match) {
                return '(' + match[1] + ') ' + match[2] + '-' + match[3];
            }
            
            return phoneNumber;
        }

        function addDevice() {
            // Get the current patient data
            const patient = window.patientDetailsManager?.currentPatient || {};
            
            // Check required fields
            if (!patient.tcNo || !patient.phone || !patient.address) {
                let missingFields = [];
                if (!patient.tcNo) missingFields.push('TC Kimlik No');
                if (!patient.phone) missingFields.push('Telefon');
                if (!patient.address) missingFields.push('Adres');
                
                Utils.showToast(`Cihaz eklemek i√ßin eksik bilgiler: ${missingFields.join(', ')}`, 'error');
                return;
            }
            
            // Check SGK information
            const sgkInfo = window.patientDetailsManager?.sgkInfo || {};
            if (!sgkInfo.deviceRightDate || !sgkInfo.batteryRightDate) {
                Utils.showModal({
                    title: 'SGK Bilgileri Eksik',
                    content: `<div class="p-4">
                        <p class="mb-4">Cihaz eklemek i√ßin SGK bilgileri gereklidir. SGK bilgilerini g√ºncellemek ister misiniz?</p>
                    </div>`,
                    primaryButton: {
                        text: 'SGK Bilgilerini G√ºncelle',
                        onClick: () => updateSGK()
                    },
                    secondaryButton: {
                        text: 'ƒ∞ptal',
                        onClick: () => {}
                    }
                });
                return;
            }
            
            // Create modal content for device selection
            const modalContent = `
                <div class="space-y-4">
                    <div>
                        <label for="deviceManufacturer" class="block text-sm font-medium text-gray-700">√úretici</label>
                        <select id="deviceManufacturer" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                            <option value="">Se√ßiniz...</option>
                            <option value="phonak">Phonak</option>
                            <option value="oticon">Oticon</option>
                            <option value="starkey">Starkey</option>
                            <option value="signia">Signia</option>
                            <option value="resound">ReSound</option>
                            <option value="widex">Widex</option>
                        </select>
                    </div>
                    <div>
                        <label for="deviceModel" class="block text-sm font-medium text-gray-700">Model</label>
                        <select id="deviceModel" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" disabled>
                            <option value="">√ñnce √ºretici se√ßiniz...</option>
                        </select>
                    </div>
                    <div>
                        <label for="deviceDirection" class="block text-sm font-medium text-gray-700">Y√∂n</label>
                        <select id="deviceDirection" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                            <option value="left">Sol</option>
                            <option value="right">Saƒü</option>
                            <option value="bilateral">Bilateral</option>
                        </select>
                    </div>
                    <div>
                        <label for="devicePrice" class="block text-sm font-medium text-gray-700">Fiyat (TL)</label>
                        <input type="number" id="devicePrice" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="0.00">
                    </div>
                    <div>
                        <label for="deviceCount" class="block text-sm font-medium text-gray-700">Adet</label>
                        <input type="number" id="deviceCount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="1" min="1">
                    </div>
                    <div>
                        <label for="deviceNotes" class="block text-sm font-medium text-gray-700">Notlar</label>
                        <textarea id="deviceNotes" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Cihaz ile ilgili notlar..."></textarea>
                    </div>
                </div>
            `;
            
            // Show modal
            Utils.showModal({
                title: 'Cihaz Ekle',
                content: modalContent,
                primaryButton: {
                    text: 'Kaydet',
                    onClick: () => {
                        // Get form values
                        const manufacturer = document.getElementById('deviceManufacturer').value;
                        const model = document.getElementById('deviceModel').value;
                        const direction = document.getElementById('deviceDirection').value;
                        const price = document.getElementById('devicePrice').value;
                        const count = document.getElementById('deviceCount').value;
                        const notes = document.getElementById('deviceNotes').value;
                        
                        if (!manufacturer || !model || !price) {
                            Utils.showToast('L√ºtfen t√ºm gerekli alanlarƒ± doldurun', 'error');
                            return;
                        }
                        
                        // Create new device
                        const newDevice = {
                            id: 'dev_' + Date.now(),
                            patientId: patient.id,
                            manufacturer: manufacturer,
                            model: model,
                            direction: direction,
                            price: parseFloat(price),
                            count: parseInt(count),
                            notes: notes,
                            assignedDate: new Date().toISOString(),
                            status: 'assigned'
                        };
                        
                        // Add device to patient
                        if (window.patientDetailsManager) {
                            // Initialize devices array if it doesn't exist
                            if (!window.patientDetailsManager.devices) {
                                window.patientDetailsManager.devices = [];
                            }
                            
                            // Add new device
                            window.patientDetailsManager.devices.push(newDevice);
                            
                            // Update patient label to Kontrol Hastasƒ±
                            window.patientDetailsManager.currentPatient.currentLabel = 'Kontrol Hastasƒ±';
                            window.patientDetailsManager.savePatientToStorage();
                            window.patientDetailsManager.renderPatientProfile();
                            window.patientDetailsManager.renderGeneralTab();
                            
                            // Refresh devices display
                            loadDevices();
                            
                            Utils.showToast('Cihaz ba≈üarƒ±yla eklendi', 'success');
                        } else {
                            Utils.showToast('Cihaz eklenemedi', 'error');
                        }
                    }
                },
                secondaryButton: {
                    text: 'ƒ∞ptal',
                    onClick: () => {}
                }
            });
            
            // Add event listener for manufacturer selection
            setTimeout(() => {
                const manufacturerSelect = document.getElementById('deviceManufacturer');
                const modelSelect = document.getElementById('deviceModel');
                
                if (manufacturerSelect && modelSelect) {
                    manufacturerSelect.addEventListener('change', function() {
                        const manufacturer = this.value;
                        modelSelect.disabled = !manufacturer;
                        modelSelect.innerHTML = '';
                        
                        if (!manufacturer) {
                            modelSelect.innerHTML = '<option value="">√ñnce √ºretici se√ßiniz...</option>';
                            return;
                        }
                        
                        // Populate models based on manufacturer
                        const models = getModelsByManufacturer(manufacturer);
                        models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model.id;
                            option.textContent = model.name;
                            modelSelect.appendChild(option);
                        });
                    });
                }
            }, 100);
        }
        
        // Helper function to get models by manufacturer
        function getModelsByManufacturer(manufacturer) {
            const modelsByManufacturer = {
                'phonak': [
                    { id: 'phonak_audeo_p', name: 'Aud√©o Paradise' },
                    { id: 'phonak_audeo_m', name: 'Aud√©o Marvel' },
                    { id: 'phonak_naida_p', name: 'Na√≠da Paradise' },
                    { id: 'phonak_bolero_m', name: 'Bolero Marvel' }
                ],
                'oticon': [
                    { id: 'oticon_more', name: 'More' },
                    { id: 'oticon_opn_s', name: 'Opn S' },
                    { id: 'oticon_xceed', name: 'Xceed' },
                    { id: 'oticon_ruby', name: 'Ruby' }
                ],
                'starkey': [
                    { id: 'starkey_livio_ai', name: 'Livio AI' },
                    { id: 'starkey_livio_edge', name: 'Livio Edge AI' },
                    { id: 'starkey_picasso', name: 'Picasso' }
                ],
                'signia': [
                    { id: 'signia_pure_charge_go', name: 'Pure Charge&Go X' },
                    { id: 'signia_styletto', name: 'Styletto X' },
                    { id: 'signia_silk', name: 'Silk X' }
                ],
                'resound': [
                    { id: 'resound_one', name: 'ONE' },
                    { id: 'resound_linx_quattro', name: 'LiNX Quattro' },
                    { id: 'resound_enzo_q', name: 'ENZO Q' }
                ],
                'widex': [
                    { id: 'widex_moment', name: 'MOMENT' },
                    { id: 'widex_evoke', name: 'EVOKE' },
                    { id: 'widex_unique', name: 'UNIQUE' }
                ]
            };
            
            return modelsByManufacturer[manufacturer] || [];
        }

        function addHearingTest() {
            Utils.showToast('ƒ∞≈üitme testi ekleme √∂zelliƒüi yakƒ±nda eklenecek', 'info');
        }

        function addDeviceTrial() {
            Utils.showToast('Cihaz denemesi ekleme √∂zelliƒüi yakƒ±nda eklenecek', 'info');
        }

        function createSale() {
            // Get the current patient data
            const patient = window.patientDetailsManager?.currentPatient || {};
            
            // Create modal content
            const modalContent = `
                <div class="space-y-4">
                    <div>
                        <label for="saleDate" class="block text-sm font-medium text-gray-700">Satƒ±≈ü Tarihi</label>
                        <input type="date" id="saleDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div>
                        <label for="saleType" class="block text-sm font-medium text-gray-700">Satƒ±≈ü T√ºr√º</label>
                        <select id="saleType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" onchange="updateProductDropdown()">
                            <option value="">Satƒ±≈ü t√ºr√ºn√º se√ßin</option>
                            <option value="ƒ∞≈üitme Cihazƒ±">ƒ∞≈üitme Cihazƒ±</option>
                            <option value="Pil">Pil</option>
                            <option value="Aksesuar">Aksesuar</option>
                            <option value="Hizmet">Hizmet</option>
                            <option value="Bakƒ±m">Bakƒ±m Hizmeti</option>
                            <option value="Diƒüer">Diƒüer</option>
                        </select>
                    </div>
                    <div id="productSection" style="display: none;">
                        <label for="productSelect" class="block text-sm font-medium text-gray-700">√úr√ºn Se√ßimi</label>
                        <input type="text" id="productSelect" list="productOptions" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="√úr√ºn arayƒ±n veya se√ßin...">
                        <datalist id="productOptions">
                            <!-- Options will be populated by JavaScript -->
                        </datalist>
                    </div>
                    <div>
                        <label for="quantity" class="block text-sm font-medium text-gray-700">Adet</label>
                        <input type="number" id="quantity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="1" min="1" onchange="calculateTotal()">
                    </div>
                    <div>
                        <label for="unitPrice" class="block text-sm font-medium text-gray-700">Birim Fiyat (TL)</label>
                        <input type="number" id="unitPrice" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="0.00" step="0.01" onchange="calculateTotal()">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="taxAmount" class="block text-sm font-medium text-gray-700">KDV Tutarƒ± (TL)</label>
                            <input type="number" id="taxAmount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-50" placeholder="0.00" step="0.01" readonly>
                        </div>
                        <div>
                            <label for="taxRate" class="block text-sm font-medium text-gray-700">KDV Oranƒ± (%)</label>
                            <input type="number" id="taxRate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-50" placeholder="0" readonly>
                        </div>
                    </div>
                    <div>
                        <label for="saleAmount" class="block text-sm font-medium text-gray-700">Toplam Tutar (KDV Dahil)</label>
                        <input type="number" id="saleAmount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-50 font-semibold text-lg" placeholder="0.00" step="0.01" readonly>
                    </div>
                    <div>
                        <label for="paymentMethod" class="block text-sm font-medium text-gray-700">√ñdeme Y√∂ntemi</label>
                        <select id="paymentMethod" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                            <option value="cash">Nakit</option>
                            <option value="credit_card">Kredi Kartƒ±</option>
                            <option value="bank_transfer">Banka Havalesi</option>
                            <option value="installment">Taksit</option>
                            <option value="check">√áek</option>
                        </select>
                    </div>
                    <div>
                        <label for="saleDescription" class="block text-sm font-medium text-gray-700">Satƒ±≈ü A√ßƒ±klamasƒ±</label>
                        <textarea id="saleDescription" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Satƒ±≈ü detaylarƒ±..."></textarea>
                    </div>
                    <div>
                        <label for="warrantyPeriod" class="block text-sm font-medium text-gray-700">Garanti S√ºresi (Ay)</label>
                        <input type="number" id="warrantyPeriod" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="24" min="0">
                    </div>
                </div>
            `;
            
            // Show modal
            Utils.showModal({
                title: 'Satƒ±≈ü Olu≈ütur',
                content: modalContent,
                primaryButton: {
                    text: 'Satƒ±≈üƒ± Kaydet',
                    onClick: () => {
                        // Get form values
                        const saleDate = document.getElementById('saleDate').value;
                        const saleType = document.getElementById('saleType').value;
                        const selectedProduct = document.getElementById('productSelect').value;
                        const quantity = parseInt(document.getElementById('quantity').value);
                        const unitPrice = parseFloat(document.getElementById('unitPrice').value);
                        const taxRate = parseFloat(document.getElementById('taxRate').value);
                        const taxAmount = parseFloat(document.getElementById('taxAmount').value);
                        const saleAmount = parseFloat(document.getElementById('saleAmount').value);
                        const paymentMethod = document.getElementById('paymentMethod').value;
                        const saleDescription = document.getElementById('saleDescription').value;
                        const warrantyPeriod = document.getElementById('warrantyPeriod').value;
                        
                        if (!saleDate || !saleType || !quantity || !unitPrice) {
                            Utils.showToast('L√ºtfen t√ºm gerekli alanlarƒ± doldurun', 'error');
                            return;
                        }
                        
                        // Check if product selection is required and validate
                        if ((saleType === 'ƒ∞≈üitme Cihazƒ±' || saleType === 'Pil') && !selectedProduct) {
                            Utils.showToast('L√ºtfen √ºr√ºn se√ßimi yapƒ±n', 'error');
                            return;
                        }
                        
                        // Create new sale
                        const newSale = {
                            id: 'sale_' + Date.now(),
                            patientId: patient.id,
                            patientName: `${patient.firstName} ${patient.lastName}`,
                            date: saleDate,
                            type: saleType,
                            product: selectedProduct || null,
                            quantity: quantity,
                            unitPrice: unitPrice,
                            taxRate: taxRate,
                            taxAmount: taxAmount,
                            totalAmount: saleAmount,
                            baseAmount: saleAmount - taxAmount,
                            paymentMethod: paymentMethod,
                            description: saleDescription,
                            warrantyPeriod: parseInt(warrantyPeriod),
                            warrantyEndDate: calculateWarrantyEndDate(saleDate, warrantyPeriod),
                            status: 'completed',
                            createdAt: new Date().toISOString()
                        };
                        
                        // Add sale to patient
                        if (window.patientDetailsManager) {
                            // Initialize sales array if it doesn't exist
                            if (!window.patientDetailsManager.sales) {
                                window.patientDetailsManager.sales = [];
                            }
                            
                            // Add new sale
                            window.patientDetailsManager.sales.push(newSale);
                            
                            // Update patient conversion step to 'purchased'
                            window.patientDetailsManager.currentPatient.conversionStep = 'purchased';
                            window.patientDetailsManager.currentPatient.currentLabel = 'Satƒ±n Aldƒ±';
                            window.patientDetailsManager.savePatientToStorage();
                            
                            // Update patient profile and general tab
                            window.patientDetailsManager.renderPatientProfile();
                            window.patientDetailsManager.renderGeneralTab();
                            
                            // Update timeline
                            if (typeof loadTimeline === 'function') {
                                loadTimeline();
                            }
                            
                            // Refresh sales tab if it's visible
                            if (typeof loadSalesData === 'function') {
                                loadSalesData();
                            }
                            
                            Utils.showToast('Satƒ±≈ü ba≈üarƒ±yla olu≈üturuldu', 'success');
                        } else {
                            Utils.showToast('Satƒ±≈ü olu≈üturulamadƒ±', 'error');
                        }
                    }
                },
                secondaryButton: {
                    text: 'ƒ∞ptal',
                    onClick: () => {}
                }
            });
        }
        
        // Helper function to calculate warranty end date
        function calculateWarrantyEndDate(saleDate, warrantyPeriodMonths) {
            if (!saleDate || !warrantyPeriodMonths) return null;
            
            const startDate = new Date(saleDate);
            const endDate = new Date(startDate);
            endDate.setMonth(endDate.getMonth() + parseInt(warrantyPeriodMonths));
            
            return endDate.toISOString().split('T')[0];
        }

        // Function to calculate total amount based on quantity, unit price, and tax
        function calculateTotal() {
            const saleType = document.getElementById('saleType').value;
            const quantity = parseFloat(document.getElementById('quantity').value) || 0;
            const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
            
            const taxRateField = document.getElementById('taxRate');
            const taxAmountField = document.getElementById('taxAmount');
            const totalAmountField = document.getElementById('saleAmount');
            
            let taxRate = 0;
            let taxAmount = 0;
            let totalAmount = 0;
            let baseAmount = 0;
            
            if (saleType === 'ƒ∞≈üitme Cihazƒ±') {
                // For hearing devices: 0% tax, price is as entered
                taxRate = 0;
                baseAmount = quantity * unitPrice;
                taxAmount = 0;
                totalAmount = baseAmount;
            } else {
                // For other products: 20% tax included in the entered price
                taxRate = 20;
                totalAmount = quantity * unitPrice;
                baseAmount = totalAmount / 1.2; // Remove 20% tax
                taxAmount = totalAmount - baseAmount;
            }
            
            // Update form fields
            taxRateField.value = taxRate.toFixed(0);
            taxAmountField.value = taxAmount.toFixed(2);
            totalAmountField.value = totalAmount.toFixed(2);
        }

        // Function to update product dropdown based on sale type
        function updateProductDropdown() {
            const saleType = document.getElementById('saleType').value;
            const productSection = document.getElementById('productSection');
            const productSelect = document.getElementById('productSelect');
            const productOptions = document.getElementById('productOptions');
            
            // Clear existing options and input
            productOptions.innerHTML = '';
            productSelect.value = '';
            
            // Recalculate totals when sale type changes
            calculateTotal();
            
            if (saleType === 'ƒ∞≈üitme Cihazƒ±') {
                productSection.style.display = 'block';
                
                // Update label for hearing devices
                productSection.querySelector('label').textContent = 'ƒ∞≈üitme Cihazƒ± Se√ßimi';
                productSelect.placeholder = 'ƒ∞≈üitme cihazƒ± arayƒ±n veya se√ßin...';
                
                // Add hearing device options
                const hearingDevices = [
                    'Phonak Aud√©o Paradise P90-312T',
                    'Phonak Aud√©o Paradise P70-312T',
                    'Phonak Aud√©o Paradise P50-312T',
                    'Phonak Aud√©o Paradise P30-312T',
                    'Phonak Aud√©o Life P90-312T',
                    'Phonak Aud√©o Life P70-312T',
                    'Phonak Aud√©o Fit P90-312T',
                    'Phonak Aud√©o Fit P70-312T',
                    'Phonak Na√≠da Paradise P90-UP',
                    'Phonak Na√≠da Paradise P70-UP',
                    'Phonak Sky Paradise P90-SP',
                    'Phonak Sky Paradise P70-SP',
                    'Oticon More 1',
                    'Oticon More 2',
                    'Oticon More 3',
                    'Oticon Real 1',
                    'Oticon Real 2',
                    'Oticon Real 3',
                    'Widex Moment 440',
                    'Widex Moment 330',
                    'Widex Moment 220',
                    'Widex Moment 110',
                    'Signia Pure Charge&Go AX 7',
                    'Signia Pure Charge&Go AX 5',
                    'Signia Pure Charge&Go AX 3',
                    'ReSound OMNIA 9',
                    'ReSound OMNIA 7',
                    'ReSound OMNIA 5'
                ];
                
                hearingDevices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device;
                    productOptions.appendChild(option);
                });
                
            } else if (saleType === 'Pil') {
                productSection.style.display = 'block';
                
                // Update label for batteries
                productSection.querySelector('label').textContent = 'Pil T√ºr√º Se√ßimi';
                productSelect.placeholder = 'Pil t√ºr√ºn√º se√ßin...';
                
                // Add battery options with the specified types
                const batteries = [
                    '10 - Sarƒ±',
                    '13 - Turuncu', 
                    '312 - Kahverengi',
                    '675 - Mavi',
                    'Koklear ƒ∞mplant Pili'
                ];
                
                batteries.forEach(battery => {
                    const option = document.createElement('option');
                    option.value = battery;
                    productOptions.appendChild(option);
                });
                
            } else {
                productSection.style.display = 'none';
            }
        }

        // Function to load and display sales data
        function loadSalesData() {
            const salesTableBody = document.getElementById('salesTableBody');
            const noSalesMessage = document.getElementById('noSalesMessage');
            const totalSalesAmount = document.getElementById('totalSalesAmount');
            const monthlySalesAmount = document.getElementById('monthlySalesAmount');
            const totalSalesCount = document.getElementById('totalSalesCount');
            
            if (!salesTableBody) return;
            
            // Get sales data for current patient
            const sales = window.patientDetailsManager?.sales?.filter(sale => 
                sale.patientId === currentPatientId
            ) || [];
            
            // Clear existing content
            salesTableBody.innerHTML = '';
            
            if (sales.length === 0) {
                noSalesMessage.style.display = 'block';
                salesTableBody.parentElement.parentElement.style.display = 'none';
            } else {
                noSalesMessage.style.display = 'none';
                salesTableBody.parentElement.parentElement.style.display = 'block';
                
                // Sort sales by date (newest first)
                sales.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Populate table
                sales.forEach(sale => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    
                    // Format date
                    const saleDate = new Date(sale.date).toLocaleDateString('tr-TR');
                    
                    // Status badge
                    const statusBadge = sale.status === 'completed' 
                        ? '<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Tamamlandƒ±</span>'
                        : '<span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">Beklemede</span>';
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${saleDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${sale.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.product || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${sale.quantity || 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">‚Ç∫${(sale.unitPrice || 0).toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">‚Ç∫${(sale.taxAmount || 0).toFixed(2)} (${sale.taxRate || 0}%)</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">‚Ç∫${(sale.totalAmount || sale.amount || 0).toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="viewSaleDetails('${sale.id}')" class="text-blue-600 hover:text-blue-900 mr-2">Detay</button>
                            <button onclick="printInvoice('${sale.id}')" class="text-green-600 hover:text-green-900">Fatura</button>
                        </td>
                    `;
                    
                    salesTableBody.appendChild(row);
                });
            }
            
            // Calculate totals
            const totalAmount = sales.reduce((sum, sale) => sum + (sale.totalAmount || sale.amount || 0), 0);
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyAmount = sales
                .filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
                })
                .reduce((sum, sale) => sum + (sale.totalAmount || sale.amount || 0), 0);
            
            // Update summary cards
            if (totalSalesAmount) totalSalesAmount.textContent = `‚Ç∫${totalAmount.toFixed(2)}`;
            if (monthlySalesAmount) monthlySalesAmount.textContent = `‚Ç∫${monthlyAmount.toFixed(2)}`;
            if (totalSalesCount) totalSalesCount.textContent = sales.length.toString();
        }

        // Function to view sale details
        function viewSaleDetails(saleId) {
            const sale = window.patientDetailsManager?.sales?.find(s => s.id === saleId);
            if (!sale) return;
            
            const modalContent = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Satƒ±≈ü Tarihi</label>
                            <p class="mt-1 text-sm text-gray-900">${new Date(sale.date).toLocaleDateString('tr-TR')}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Satƒ±≈ü T√ºr√º</label>
                            <p class="mt-1 text-sm text-gray-900">${sale.type}</p>
                        </div>
                    </div>
                    ${sale.product ? `
                    <div>
                        <label class="block text-sm font-medium text-gray-700">√úr√ºn</label>
                        <p class="mt-1 text-sm text-gray-900">${sale.product}</p>
                    </div>
                    ` : ''}
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Adet</label>
                            <p class="mt-1 text-sm text-gray-900">${sale.quantity || 1}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Birim Fiyat</label>
                            <p class="mt-1 text-sm text-gray-900">‚Ç∫${(sale.unitPrice || 0).toFixed(2)}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">KDV</label>
                            <p class="mt-1 text-sm text-gray-900">‚Ç∫${(sale.taxAmount || 0).toFixed(2)} (%${sale.taxRate || 0})</p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Toplam Tutar</label>
                        <p class="mt-1 text-lg font-semibold text-gray-900">‚Ç∫${(sale.totalAmount || sale.amount || 0).toFixed(2)}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">√ñdeme Y√∂ntemi</label>
                            <p class="mt-1 text-sm text-gray-900">${sale.paymentMethod}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Garanti S√ºresi</label>
                            <p class="mt-1 text-sm text-gray-900">${sale.warrantyPeriod || 0} ay</p>
                        </div>
                    </div>
                    ${sale.description ? `
                    <div>
                        <label class="block text-sm font-medium text-gray-700">A√ßƒ±klama</label>
                        <p class="mt-1 text-sm text-gray-900">${sale.description}</p>
                    </div>
                    ` : ''}
                </div>
            `;
            
            Utils.showModal({
                title: 'Satƒ±≈ü Detaylarƒ±',
                content: modalContent,
                primaryButton: {
                    text: 'Kapat',
                    onClick: () => {}
                }
            });
        }

        // Function to print invoice
        function printInvoice(saleId) {
            Utils.showToast('Fatura yazdƒ±rma √∂zelliƒüi yakƒ±nda eklenecek', 'info');
        }

        function addReturn() {
            Utils.showToast('ƒ∞ade/deƒüi≈üim ekleme √∂zelliƒüi yakƒ±nda eklenecek', 'info');
        }

        function addPayment() {
            // Get the current patient data
            const patient = window.patientDetailsManager?.currentPatient || {};
            
            // Create modal content
            const modalContent = `
                <div class="space-y-4">
                    <div>
                        <label for="paymentAmount" class="block text-sm font-medium text-gray-700">√ñdeme Tutarƒ± (TL)</label>
                        <input type="number" id="paymentAmount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="0.00">
                    </div>
                    <div>
                        <label for="paymentDate" class="block text-sm font-medium text-gray-700">√ñdeme Tarihi</label>
                        <input type="date" id="paymentDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div>
                        <label for="paymentMethod" class="block text-sm font-medium text-gray-700">√ñdeme Y√∂ntemi</label>
                        <select id="paymentMethod" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                            <option value="cash">Nakit</option>
                            <option value="credit_card">Kredi Kartƒ±</option>
                            <option value="bank_transfer">Banka Havalesi</option>
                            <option value="check">√áek</option>
                            <option value="other">Diƒüer</option>
                        </select>
                    </div>
                    <div>
                        <label for="paymentDescription" class="block text-sm font-medium text-gray-700">A√ßƒ±klama</label>
                        <textarea id="paymentDescription" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="√ñdeme ile ilgili a√ßƒ±klama..."></textarea>
                    </div>
                    <div>
                        <label for="relatedDevice" class="block text-sm font-medium text-gray-700">ƒ∞li≈ükili Cihaz (Opsiyonel)</label>
                        <select id="relatedDevice" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                            <option value="">Se√ßiniz...</option>
                            ${getDeviceOptionsForPatient(patient.id)}
                        </select>
                    </div>
                </div>
            `;
            
            // Show modal
            Utils.showModal({
                title: '√ñdeme Ekle',
                content: modalContent,
                primaryButton: {
                    text: 'Kaydet',
                    onClick: () => {
                        // Get form values
                        const amount = document.getElementById('paymentAmount').value;
                        const date = document.getElementById('paymentDate').value;
                        const method = document.getElementById('paymentMethod').value;
                        const description = document.getElementById('paymentDescription').value;
                        const relatedDevice = document.getElementById('relatedDevice').value;
                        
                        if (!amount || !date || !method) {
                            Utils.showToast('L√ºtfen t√ºm gerekli alanlarƒ± doldurun', 'error');
                            return;
                        }
                        
                        // Create new payment
                        const newPayment = {
                            id: 'pay_' + Date.now(),
                            patientId: patient.id,
                            amount: parseFloat(amount),
                            date: date,
                            method: method,
                            description: description,
                            relatedDeviceId: relatedDevice || null,
                            createdAt: new Date().toISOString()
                        };
                        
                        // Add payment to patient
                        if (window.patientDetailsManager) {
                            // Initialize payments array if it doesn't exist
                            if (!window.patientDetailsManager.payments) {
                                window.patientDetailsManager.payments = [];
                            }
                            
                            // Add new payment
                            window.patientDetailsManager.payments.push(newPayment);
                            window.patientDetailsManager.savePatientToStorage();
                            
                            // Refresh payments display if available
                            if (typeof loadPayments === 'function') {
                                loadPayments();
                            }
                            
                            Utils.showToast('√ñdeme ba≈üarƒ±yla eklendi', 'success');
                        } else {
                            Utils.showToast('√ñdeme eklenemedi', 'error');
                        }
                    }
                },
                secondaryButton: {
                    text: 'ƒ∞ptal',
                    onClick: () => {}
                }
            });
        }
        
        // Helper function to get device options for a patient
        function getDeviceOptionsForPatient(patientId) {
            if (!window.patientDetailsManager || !window.patientDetailsManager.devices) {
                return '';
            }
            
            const patientDevices = window.patientDetailsManager.devices.filter(device => device.patientId === patientId);
            
            if (patientDevices.length === 0) {
                return '<option value="" disabled>Bu hasta i√ßin cihaz bulunamadƒ±</option>';
            }
            
            return patientDevices.map(device => {
                const manufacturer = device.manufacturer.charAt(0).toUpperCase() + device.manufacturer.slice(1);
                const direction = device.direction === 'left' ? 'Sol' : device.direction === 'right' ? 'Saƒü' : 'Bilateral';
                return `<option value="${device.id}">${manufacturer} - ${device.model} (${direction})</option>`;
            }).join('');
        }

        function uploadDocument() {
            // Get the current patient data
            const patient = window.patientDetailsManager?.currentPatient || {};
            
            // Create modal content
            const modalContent = `
                <div class="space-y-4">
                    <div>
                        <label for="documentTitle" class="block text-sm font-medium text-gray-700">Belge Ba≈ülƒ±ƒüƒ±</label>
                        <input type="text" id="documentTitle" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Belge ba≈ülƒ±ƒüƒ±...">
                    </div>
                    <div>
                        <label for="documentType" class="block text-sm font-medium text-gray-700">Belge Tipi</label>
                        <select id="documentType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                            <option value="sgk_report">SGK Raporu</option>
                            <option value="hearing_test">ƒ∞≈üitme Testi</option>
                            <option value="prescription">Re√ßete</option>
                            <option value="invoice">Fatura</option>
                            <option value="id_card">Kimlik Belgesi</option>
                            <option value="other">Diƒüer</option>
                        </select>
                    </div>
                    <div>
                        <label for="documentDate" class="block text-sm font-medium text-gray-700">Belge Tarihi</label>
                        <input type="date" id="documentDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Belge Dosyasƒ±</label>
                        <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                            <div class="space-y-1 text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <div class="flex text-sm text-gray-600">
                                    <label for="documentFile" class="relative cursor-pointer bg-white rounded-md font-medium text-primary hover:text-primary-dark focus-within:outline-none">
                                        <span>Dosya se√ßin</span>
                                        <input id="documentFile" name="documentFile" type="file" class="sr-only">
                                    </label>
                                    <p class="pl-1">veya s√ºr√ºkleyip bƒ±rakƒ±n</p>
                                </div>
                                <p class="text-xs text-gray-500">PNG, JPG, PDF (max. 10MB)</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="documentNotes" class="block text-sm font-medium text-gray-700">Notlar</label>
                        <textarea id="documentNotes" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Belge ile ilgili notlar..."></textarea>
                    </div>
                </div>
            `;
            
            // Show modal
            Utils.showModal({
                title: 'Belge Y√ºkle',
                content: modalContent,
                primaryButton: {
                    text: 'Y√ºkle',
                    onClick: () => {
                        // Get form values
                        const title = document.getElementById('documentTitle').value;
                        const type = document.getElementById('documentType').value;
                        const date = document.getElementById('documentDate').value;
                        const notes = document.getElementById('documentNotes').value;
                        const fileInput = document.getElementById('documentFile');
                        
                        if (!title || !type || !date) {
                            Utils.showToast('L√ºtfen t√ºm gerekli alanlarƒ± doldurun', 'error');
                            return;
                        }
                        
                        if (!fileInput.files || fileInput.files.length === 0) {
                            Utils.showToast('L√ºtfen bir dosya se√ßin', 'error');
                            return;
                        }
                        
                        const file = fileInput.files[0];
                        if (file.size > 10 * 1024 * 1024) { // 10MB
                            Utils.showToast('Dosya boyutu 10MB\'dan b√ºy√ºk olamaz', 'error');
                            return;
                        }
                        
                        // In a real application, we would upload the file to a server here
                        // For this demo, we'll simulate a successful upload
                        
                        // Create new document
                        const newDocument = {
                            id: 'doc_' + Date.now(),
                            patientId: patient.id,
                            title: title,
                            type: type,
                            date: date,
                            notes: notes,
                            fileName: file.name,
                            fileSize: file.size,
                            fileType: file.type,
                            uploadDate: new Date().toISOString(),
                            url: '#' // In a real app, this would be the URL to the uploaded file
                        };
                        
                        // Add document to patient
                        if (window.patientDetailsManager) {
                            // Initialize documents array if it doesn't exist
                            if (!window.patientDetailsManager.documents) {
                                window.patientDetailsManager.documents = [];
                            }
                            
                            // Add new document
                            window.patientDetailsManager.documents.push(newDocument);
                            window.patientDetailsManager.savePatientToStorage();
                            
                            // Refresh documents display if available
                            if (typeof loadDocuments === 'function') {
                                loadDocuments();
                            }
                            
                            // Update timeline
                            if (typeof loadTimeline === 'function') {
                                loadTimeline();
                            }
                            
                            Utils.showToast('Belge ba≈üarƒ±yla y√ºklendi', 'success');
                        } else {
                            Utils.showToast('Belge y√ºklenemedi', 'error');
                        }
                    }
                },
                secondaryButton: {
                    text: 'ƒ∞ptal',
                    onClick: () => {}
                }
            });
            
            // Add event listener for file input
            setTimeout(() => {
                const fileInput = document.getElementById('documentFile');
                if (fileInput) {
                    fileInput.addEventListener('change', function() {
                        if (this.files && this.files.length > 0) {
                            const fileName = this.files[0].name;
                            const fileSize = (this.files[0].size / 1024).toFixed(2) + ' KB';
                            const fileInfo = document.createElement('p');
                            fileInfo.className = 'text-xs text-gray-700 mt-2';
                            fileInfo.textContent = `Se√ßilen dosya: ${fileName} (${fileSize})`;
                            
                            // Remove previous file info if exists
                            const previousFileInfo = this.parentElement.parentElement.parentElement.querySelector('.text-gray-700');
                            if (previousFileInfo) {
                                previousFileInfo.remove();
                            }
                            
                            this.parentElement.parentElement.parentElement.appendChild(fileInfo);
                        }
                    });
                }
            }, 100);
        }

        function addNote() {
            // Get the current patient data
            const patient = window.patientDetailsManager?.currentPatient || {};
            
            // Create modal content
            const modalContent = `
                <div class="space-y-4">
                    <div>
                        <label for="noteTitle" class="block text-sm font-medium text-gray-700">Not Ba≈ülƒ±ƒüƒ±</label>
                        <input type="text" id="noteTitle" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="G√∂r√º≈üme, Kontrol, Deneme vb.">
                    </div>
                    <div>
                        <label for="noteContent" class="block text-sm font-medium text-gray-700">Not ƒ∞√ßeriƒüi</label>
                        <textarea id="noteContent" rows="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Hasta ile ilgili notlarƒ± buraya yazƒ±n..."></textarea>
                    </div>
                    <div>
                        <label for="noteType" class="block text-sm font-medium text-gray-700">Not Tipi</label>
                        <select id="noteType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                            <option value="call">Telefon G√∂r√º≈ümesi</option>
                            <option value="visit">Merkez Ziyareti</option>
                            <option value="trial">Cihaz Denemesi</option>
                            <option value="follow-up">Kontrol</option>
                            <option value="other">Diƒüer</option>
                        </select>
                    </div>
                </div>
            `;
            
            // Show modal
            Utils.showModal({
                title: 'Hasta Notu Ekle',
                content: modalContent,
                primaryButton: {
                    text: 'Kaydet',
                    onClick: () => {
                        // Get form values
                        const noteTitle = document.getElementById('noteTitle').value;
                        const noteContent = document.getElementById('noteContent').value;
                        const noteType = document.getElementById('noteType').value;
                        
                        if (!noteTitle || !noteContent) {
                            Utils.showToast('L√ºtfen ba≈ülƒ±k ve i√ßerik alanlarƒ±nƒ± doldurun', 'error');
                            return;
                        }
                        
                        // Create new note
                        const newNote = {
                            id: 'note_' + Date.now(),
                            title: noteTitle,
                            content: noteContent,
                            type: noteType,
                            date: new Date().toISOString(),
                            createdBy: 'Kullanƒ±cƒ±' // This would be the logged-in user in a real app
                        };
                        
                        // Add note to patient
                        if (window.patientDetailsManager) {
                            // Initialize notes array if it doesn't exist
                            if (!window.patientDetailsManager.currentPatient.notes) {
                                window.patientDetailsManager.currentPatient.notes = [];
                            }
                            
                            // Add new note
                            window.patientDetailsManager.currentPatient.notes.unshift(newNote);
                            window.patientDetailsManager.savePatientToStorage();
                            
                            // Refresh notes display
                            loadNotes();
                            
                            Utils.showToast('Not ba≈üarƒ±yla eklendi', 'success');
                        } else {
                            Utils.showToast('Not eklenemedi', 'error');
                        }
                    }
                },
                secondaryButton: {
                    text: 'ƒ∞ptal',
                    onClick: () => {}
                }
            });
        }

        function editNotes() {
            if (window.patientDetailsManager && typeof window.patientDetailsManager.editNotes === 'function') {
                window.patientDetailsManager.editNotes();
            } else {
                // Wait for patientDetailsManager to be initialized
                const checkManager = () => {
                    if (window.patientDetailsManager && typeof window.patientDetailsManager.editNotes === 'function') {
                        window.patientDetailsManager.editNotes();
                    } else {
                        setTimeout(checkManager, 100);
                    }
                };
                checkManager();
            }
        }

        // Make sure patientDetailsManager is accessible globally
        if (!window.patientDetailsManager) {
            window.patientDetailsManager = {
                editNotes: function() {
                    Utils.showToast('Hasta notlarƒ± d√ºzenleme √∂zelliƒüi y√ºkleniyor...', 'info');
                    // Wait for the actual patientDetailsManager to load
                    const checkManager = () => {
                        if (window.patientDetailsManager && typeof window.patientDetailsManager.editNotes === 'function' && 
                            window.patientDetailsManager !== this) {
                            window.patientDetailsManager.editNotes();
                        } else {
                            setTimeout(checkManager, 100);
                        }
                    };
                    setTimeout(checkManager, 100);
                }
            };
        }

        // Function to update all patient displays
        function updateAllPatientDisplays(updatedPatient) {
            console.log('updateAllPatientDisplays called with:', updatedPatient);
            console.log('window.patientProfile exists:', !!window.patientProfile);
            
            // Update patient profile header
            if (window.patientProfile && typeof window.patientProfile.updatePatientData === 'function') {
                console.log('Updating PatientProfileWidget with data:', {
                    name: updatedPatient.name,
                    tc: updatedPatient.tcNumber,
                    tcNumber: updatedPatient.tcNumber, 
                    phone: updatedPatient.phone,
                    age: updatedPatient.age || Utils.calculateAge(updatedPatient.birthDate)
                });
                
                window.patientProfile.updatePatientData({
                    name: updatedPatient.name,
                    tc: updatedPatient.tcNumber,
                    tcNumber: updatedPatient.tcNumber, 
                    phone: updatedPatient.phone,
                    birthDate: updatedPatient.birthDate,
                    email: updatedPatient.email,
                    address: updatedPatient.address,
                    status: updatedPatient.status,
                    segment: updatedPatient.segment,
                    sgkStatus: updatedPatient.sgkStatus,
                    lastVisit: updatedPatient.lastVisit,
                    age: updatedPatient.age || Utils.calculateAge(updatedPatient.birthDate)
                });
                
                console.log('PatientProfileWidget updated successfully');
            } else {
                console.error('PatientProfileWidget not available or updatePatientData method missing');
            }

            // Update the personal info section
            loadPersonalInfo(updatedPatient);

            // Update any other patient displays that might exist
            console.log('All patient displays updated with:', updatedPatient);
        }

        function updateSGK() {
            // Get the current patient data
            const patient = window.patientDetailsManager?.currentPatient || {};
            
            // Get current SGK info if available
            const sgkInfo = window.patientDetailsManager?.sgkInfo || {};
            
            // Create modal content
            const modalContent = `
                <div class="space-y-4">
                    <div>
                        <label for="sgkNumber" class="block text-sm font-medium text-gray-700">SGK Numarasƒ±</label>
                        <input type="text" id="sgkNumber" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="${sgkInfo.sgkNumber || ''}" placeholder="SGK Numarasƒ±...">
                    </div>
                    <div>
                        <label for="deviceRightDate" class="block text-sm font-medium text-gray-700">Cihaz Hakkƒ± Tarihi</label>
                        <input type="date" id="deviceRightDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="${sgkInfo.deviceRightDate || ''}">
                        <p class="text-xs text-gray-500 mt-1">Cihaz hakkƒ± 5 yƒ±lda bir yenilenir</p>
                    </div>
                    <div>
                        <label for="batteryRightDate" class="block text-sm font-medium text-gray-700">Pil Hakkƒ± Tarihi</label>
                        <input type="date" id="batteryRightDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="${sgkInfo.batteryRightDate || ''}">
                        <p class="text-xs text-gray-500 mt-1">Pil hakkƒ± yƒ±lda bir yenilenir</p>
                    </div>
                    <div>
                        <label for="sgkStatus" class="block text-sm font-medium text-gray-700">SGK Durumu</label>
                        <select id="sgkStatus" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                            <option value="active" ${sgkInfo.status === 'active' ? 'selected' : ''}>Aktif</option>
                            <option value="pending" ${sgkInfo.status === 'pending' ? 'selected' : ''}>Beklemede</option>
                            <option value="expired" ${sgkInfo.status === 'expired' ? 'selected' : ''}>S√ºresi Dolmu≈ü</option>
                            <option value="not_eligible" ${sgkInfo.status === 'not_eligible' ? 'selected' : ''}>Uygun Deƒüil</option>
                        </select>
                    </div>
                    <div>
                        <label for="sgkNotes" class="block text-sm font-medium text-gray-700">SGK Notlarƒ±</label>
                        <textarea id="sgkNotes" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="SGK ile ilgili notlar...">${sgkInfo.notes || ''}</textarea>
                    </div>
                </div>
            `;
            
            // Show modal
            Utils.showModal({
                title: 'SGK Bilgilerini G√ºncelle',
                content: modalContent,
                primaryButton: {
                    text: 'Kaydet',
                    onClick: () => {
                        // Get form values
                        const sgkNumber = document.getElementById('sgkNumber').value;
                        const deviceRightDate = document.getElementById('deviceRightDate').value;
                        const batteryRightDate = document.getElementById('batteryRightDate').value;
                        const status = document.getElementById('sgkStatus').value;
                        const notes = document.getElementById('sgkNotes').value;
                        
                        if (!sgkNumber) {
                            Utils.showToast('L√ºtfen SGK numarasƒ±nƒ± girin', 'error');
                            return;
                        }
                        
                        // Calculate validity dates
                        let deviceValidityDate = null;
                        let batteryValidityDate = null;
                        
                        if (deviceRightDate) {
                            // Device right is valid for 5 years
                            const deviceDate = new Date(deviceRightDate);
                            deviceDate.setFullYear(deviceDate.getFullYear() + 5);
                            deviceValidityDate = deviceDate.toISOString().split('T')[0];
                        }
                        
                        if (batteryRightDate) {
                            // Battery right is valid for 1 year
                            const batteryDate = new Date(batteryRightDate);
                            batteryDate.setFullYear(batteryDate.getFullYear() + 1);
                            batteryValidityDate = batteryDate.toISOString().split('T')[0];
                        }
                        
                        // Create updated SGK info
                        const updatedSGKInfo = {
                            sgkNumber: sgkNumber,
                            deviceRightDate: deviceRightDate,
                            batteryRightDate: batteryRightDate,
                            deviceValidityDate: deviceValidityDate,
                            batteryValidityDate: batteryValidityDate,
                            status: status,
                            notes: notes,
                            updatedAt: new Date().toISOString()
                        };
                        
                        // Update SGK info
                        if (window.patientDetailsManager) {
                            window.patientDetailsManager.sgkInfo = updatedSGKInfo;
                            window.patientDetailsManager.savePatientToStorage();
                            
                            // Refresh SGK display
                            renderSGKInfo();
                            
                            // Update patient profile if SGK status changed
                            window.patientDetailsManager.renderPatientProfile();
                            
                            Utils.showToast('SGK bilgileri ba≈üarƒ±yla g√ºncellendi', 'success');
                        } else {
                            Utils.showToast('SGK bilgileri g√ºncellenemedi', 'error');
                        }
                    }
                },
                secondaryButton: {
                    text: 'ƒ∞ptal',
                    onClick: () => {}
                }
            });
        }
        
        // Function to render SGK info
        function renderSGKInfo() {
            const sgkInfoContainer = document.getElementById('sgkInfo');
            if (!sgkInfoContainer) return;
            
            const sgkInfo = window.patientDetailsManager?.sgkInfo || {};
            
            // Format dates for display
            const formatDate = (dateString) => {
                if (!dateString) return 'Belirtilmemi≈ü';
                return new Date(dateString).toLocaleDateString('tr-TR');
            };
            
            // Get status text and class
            let statusText = 'Belirtilmemi≈ü';
            let statusClass = 'text-gray-500';
            
            switch (sgkInfo.status) {
                case 'active':
                    statusText = 'Aktif';
                    statusClass = 'text-green-600';
                    break;
                case 'pending':
                    statusText = 'Beklemede';
                    statusClass = 'text-yellow-600';
                    break;
                case 'expired':
                    statusText = 'S√ºresi Dolmu≈ü';
                    statusClass = 'text-red-600';
                    break;
                case 'not_eligible':
                    statusText = 'Uygun Deƒüil';
                    statusClass = 'text-gray-600';
                    break;
            }
            
            sgkInfoContainer.innerHTML = `
                <div class="mb-4">
                    <h3 class="text-lg font-medium text-gray-900 mb-2">SGK Bilgileri</h3>
                    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">SGK Numarasƒ±</dt>
                                    <dd class="mt-1 text-sm text-gray-900">${sgkInfo.sgkNumber || 'Belirtilmemi≈ü'}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">SGK Durumu</dt>
                                    <dd class="mt-1 text-sm ${statusClass}">${statusText}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Cihaz Hakkƒ± Tarihi</dt>
                                    <dd class="mt-1 text-sm text-gray-900">${formatDate(sgkInfo.deviceRightDate)}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Cihaz Hakkƒ± Ge√ßerlilik</dt>
                                    <dd class="mt-1 text-sm text-gray-900">${formatDate(sgkInfo.deviceValidityDate)}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Pil Hakkƒ± Tarihi</dt>
                                    <dd class="mt-1 text-sm text-gray-900">${formatDate(sgkInfo.batteryRightDate)}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Pil Hakkƒ± Ge√ßerlilik</dt>
                                    <dd class="mt-1 text-sm text-gray-900">${formatDate(sgkInfo.batteryValidityDate)}</dd>
                                </div>
                                ${sgkInfo.notes ? `
                                <div class="sm:col-span-2">
                                    <dt class="text-sm font-medium text-gray-500">Notlar</dt>
                                    <dd class="mt-1 text-sm text-gray-900">${sgkInfo.notes}</dd>
                                </div>
                                ` : ''}
                            </dl>
                        </div>
                        <div class="px-4 py-3 bg-gray-50 text-right sm:px-6">
                            <button type="button" onclick="updateSGK()" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                                SGK Bilgilerini G√ºncelle
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadAppointments() {
            // Placeholder for appointments loading
        }

        function loadDevices() {
            // Placeholder for devices loading
        }

        function loadNotes() {
            const notesList = document.getElementById('notesList');
            if (notesList) {
                notesList.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-medium text-gray-900">ƒ∞lk Deƒüerlendirme</h4>
                            <span class="text-sm text-gray-500">15 Ocak 2024</span>
                        </div>
                        <p class="text-gray-700">Sol kulak i≈üitme kaybƒ± tespit edildi. Deneme cihazƒ± √∂nerildi.</p>
                        <div class="mt-2 text-sm text-gray-500">Dr. Elif Yƒ±ldƒ±z</div>
                    </div>
                `;
            }
        }

        function loadSGKInfo() {
            const sgkInfo = document.getElementById('sgkInfo');
            if (sgkInfo) {
                sgkInfo.innerHTML = `
                    <div class="space-y-4">
                        <div class="flex justify-between">
                            <span class="text-gray-600">SGK Durumu:</span>
                            <span class="status-badge status-active">Onaylƒ±</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Rapor Tarihi:</span>
                            <span class="font-medium">05 Ocak 2024</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Rapor No:</span>
                            <span class="font-medium">SGK-2024-001234</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Ge√ßerlilik:</span>
                            <span class="font-medium">2 Yƒ±l</span>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Katkƒ± Payƒ±:</span>
                            <span class="font-medium">‚Ç∫1.500</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">SGK Kar≈üƒ±lama:</span>
                            <span class="font-medium">‚Ç∫8.500</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Toplam Tutar:</span>
                            <span class="font-medium">‚Ç∫10.000</span>
                        </div>
                    </div>
                `;
            }
        }

        function loadTimeline() {
            // Get patient data
            const patient = window.patientDetailsManager?.currentPatient || {};
            
            // Collect all events with timestamps
            const events = [];
            
            // Add registration event
            if (patient.registrationDate) {
                events.push({
                    type: 'registration',
                    date: new Date(patient.registrationDate),
                    title: 'Hasta Kaydƒ±',
                    description: `${patient.firstName} ${patient.lastName} sisteme kaydedildi.`,
                    icon: 'user-plus'
                });
            }
            
            // Add notes
            if (Array.isArray(patient.notes)) {
                patient.notes.forEach(note => {
                    if (note.date) {
                        events.push({
                            type: 'note',
                            date: new Date(note.date),
                            title: note.title || 'Not Eklendi',
                            description: note.content,
                            icon: 'clipboard',
                            noteType: note.type
                        });
                    }
                });
            }
            
            // Add appointments
            const appointments = window.patientDetailsManager?.appointments || [];
            appointments.forEach(appointment => {
                if (appointment.date) {
                    events.push({
                        type: 'appointment',
                        date: new Date(appointment.date),
                        title: `Randevu: ${appointment.type || 'Genel'}`,
                        description: appointment.notes || 'Randevu detayƒ± belirtilmemi≈ü.',
                        icon: 'calendar',
                        status: appointment.status || 'scheduled'
                    });
                }
            });
            
            // Add device trials
            const deviceTrials = window.patientDetailsManager?.deviceTrials || [];
            deviceTrials.forEach(trial => {
                if (trial.startDate) {
                    events.push({
                        type: 'device_trial',
                        date: new Date(trial.startDate),
                        title: 'Cihaz Denemesi Ba≈üladƒ±',
                        description: `${trial.deviceName || 'Cihaz'} denemesi ba≈üladƒ±.`,
                        icon: 'headphones',
                        trialId: trial.id
                    });
                }
                
                if (trial.endDate) {
                    events.push({
                        type: 'device_trial_end',
                        date: new Date(trial.endDate),
                        title: 'Cihaz Denemesi Tamamlandƒ±',
                        description: `${trial.deviceName || 'Cihaz'} denemesi tamamlandƒ±. ${trial.result || ''}`,
                        icon: 'check-circle',
                        trialId: trial.id
                    });
                }
            });
            
            // Add device assignments
            if (Array.isArray(patient.devices)) {
                patient.devices.forEach(device => {
                    if (device.assignmentDate) {
                        events.push({
                            type: 'device_assignment',
                            date: new Date(device.assignmentDate),
                            title: 'Cihaz Atandƒ±',
                            description: `${device.manufacturer} ${device.model} ${device.direction || ''} cihazƒ± atandƒ±.`,
                            icon: 'headphones',
                            deviceId: device.id
                        });
                    }
                });
            }
            
            // Add payments
            const payments = window.patientDetailsManager?.payments || [];
            payments.forEach(payment => {
                if (payment.date) {
                    events.push({
                        type: 'payment',
                        date: new Date(payment.date),
                        title: '√ñdeme Alƒ±ndƒ±',
                        description: `${payment.amount} TL √∂deme ${payment.method || 'nakit'} olarak alƒ±ndƒ±. ${payment.description || ''}`,
                        icon: 'credit-card',
                        paymentId: payment.id
                    });
                }
            });
            
            // Add documents
            const documents = window.patientDetailsManager?.documents || [];
            documents.forEach(doc => {
                if (doc.date) {
                    events.push({
                        type: 'document',
                        date: new Date(doc.date),
                        title: `Belge Y√ºklendi: ${doc.title || 'Belge'}`,
                        description: `${doc.type || 'Belge'} y√ºklendi. ${doc.notes || ''}`,
                        icon: 'file',
                        documentId: doc.id
                    });
                }
            });
            
            // Add SMS history
            if (Array.isArray(patient.smsHistory)) {
                patient.smsHistory.forEach(sms => {
                    if (sms.date) {
                        events.push({
                            type: 'sms',
                            date: new Date(sms.date),
                            title: 'SMS G√∂nderildi',
                            description: sms.message,
                            icon: 'message-square',
                            smsId: sms.id
                        });
                    }
                });
            }
            
            // Add SGK updates
            if (window.patientDetailsManager?.sgkInfo?.updatedAt) {
                events.push({
                    type: 'sgk_update',
                    date: new Date(window.patientDetailsManager.sgkInfo.updatedAt),
                    title: 'SGK Bilgileri G√ºncellendi',
                    description: `SGK bilgileri g√ºncellendi. Durum: ${getSGKStatusText(window.patientDetailsManager.sgkInfo.status)}`,
                    icon: 'shield',
                });
            }
            
            // Sort events by date (newest first)
            events.sort((a, b) => b.date - a.date);
            
            // Helper function to format date
            const formatDate = (date) => {
                return date.toLocaleDateString('tr-TR', { 
                    day: '2-digit', 
                    month: 'long', 
                    year: 'numeric' 
                });
            };
            
            // Helper function to format time
            const formatTime = (date) => {
                return date.toLocaleTimeString('tr-TR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            };
            
            // Helper function to get SGK status text
            function getSGKStatusText(status) {
                switch (status) {
                    case 'active': return 'Aktif';
                    case 'pending': return 'Beklemede';
                    case 'expired': return 'S√ºresi Dolmu≈ü';
                    case 'not_eligible': return 'Uygun Deƒüil';
                    default: return 'Belirtilmemi≈ü';
                }
            }
            
            // Helper function to get icon class
            function getIconClass(iconName) {
                const iconMap = {
                    'user-plus': 'fas fa-user-plus',
                    'clipboard': 'fas fa-clipboard',
                    'calendar': 'fas fa-calendar-alt',
                    'headphones': 'fas fa-headphones',
                    'check-circle': 'fas fa-check-circle',
                    'credit-card': 'fas fa-credit-card',
                    'file': 'fas fa-file-alt',
                    'message-square': 'fas fa-comment-alt',
                    'shield': 'fas fa-shield-alt'
                };
                
                return iconMap[iconName] || 'fas fa-circle';
            }
            
            // Helper function to get color class based on event type
            function getColorClass(eventType) {
                const colorMap = {
                    'registration': 'bg-blue-500',
                    'note': 'bg-yellow-500',
                    'appointment': 'bg-green-500',
                    'device_trial': 'bg-purple-500',
                    'device_trial_end': 'bg-purple-700',
                    'device_assignment': 'bg-indigo-500',
                    'payment': 'bg-green-600',
                    'document': 'bg-gray-500',
                    'sms': 'bg-blue-400',
                    'sgk_update': 'bg-red-500'
                };
                
                return colorMap[eventType] || 'bg-gray-400';
            }
            
            // Get timeline tab content element
            const timelineTabContent = document.getElementById('timelineTabContent');
            if (!timelineTabContent) return;
            
            // Generate timeline HTML
            let timelineHTML = '';
            
            if (events.length === 0) {
                timelineHTML = `
                    <div class="p-4 text-center">
                        <p class="text-gray-500">Hen√ºz kayƒ±tlƒ± bir etkinlik bulunmamaktadƒ±r.</p>
                    </div>
                `;
            } else {
                let currentDate = null;
                
                timelineHTML = `<div class="p-4">`;
                
                events.forEach((event, index) => {
                    const eventDate = formatDate(event.date);
                    
                    // Add date header if this is a new date
                    if (currentDate !== eventDate) {
                        currentDate = eventDate;
                        timelineHTML += `
                            ${index > 0 ? '</div>' : ''}
                            <div class="mb-4">
                                <h3 class="text-lg font-medium text-gray-900 sticky top-0 bg-gray-100 p-2 rounded">${eventDate}</h3>
                        `;
                    }
                    
                    // Add event
                    timelineHTML += `
                        <div class="flex items-start mb-4">
                            <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center ${getColorClass(event.type)} text-white mr-3">
                                <i class="${getIconClass(event.icon)}"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex items-center">
                                    <h4 class="text-md font-medium text-gray-900">${event.title}</h4>
                                    <span class="ml-auto text-sm text-gray-500">${formatTime(event.date)}</span>
                                </div>
                                <p class="text-sm text-gray-600 mt-1">${event.description}</p>
                            </div>
                        </div>
                    `;
                });
                
                timelineHTML += `</div></div>`;
            }
            
            timelineTabContent.innerHTML = `
                <div class="p-4">
                    <h2 class="text-xl font-semibold mb-4">Zaman √áizelgesi</h2>
                    <div class="bg-white shadow rounded-lg overflow-hidden">
                        ${timelineHTML}
                    </div>
                </div>
            `;
        }

        // Patient List Functions
        async function loadPatientList() {
            try {
                // Load patients from localStorage and sample data
                let allPatients = [];
                
                // Load from localStorage
                const storedPatients = JSON.parse(localStorage.getItem('patients') || '[]');
                allPatients = [...storedPatients];
                
                // Load from global sample data if available
                if (window.sampleData && window.sampleData.patients) {
                    window.sampleData.patients.forEach(patient => {
                        if (!allPatients.find(p => p.id === patient.id)) {
                            allPatients.push(patient);
                        }
                    });
                }
                
                // Add default patients if none exist
                if (allPatients.length === 0) {
                    allPatients = [
                        {
                            id: 'p1',
                            firstName: 'Ahmet',
                            lastName: 'Yƒ±lmaz',
                            name: 'Ahmet Yƒ±lmaz',
                            phone: '0532 123 4567',
                            status: 'active',
                            conversionStep: 'device_trial'
                        },
                        {
                            id: 'p2',
                            firstName: 'Ay≈üe',
                            lastName: 'Kaya',
                            name: 'Ay≈üe Kaya',
                            phone: '0533 234 5678',
                            status: 'active',
                            conversionStep: 'purchased'
                        },
                        {
                            id: 'p3',
                            firstName: 'Mehmet',
                            lastName: 'Demir',
                            name: 'Mehmet Demir',
                            phone: '0534 345 6789',
                            status: 'pending',
                            conversionStep: 'hearing_test_done'
                        }
                    ];
                }
                
                renderPatientList(allPatients);
                window.allPatients = allPatients; // Store globally for search
                
            } catch (error) {
                console.error('Error loading patient list:', error);
            }
        }

        function renderPatientList(patients) {
            const container = document.getElementById('patientListContainer');
            if (!container) return;
            
            const currentPatientId = getPatientIdFromURL();
            
            const patientsHTML = patients.map(patient => {
                const isActive = patient.id === currentPatientId;
                const initials = getPatientInitials(patient);
                const statusClass = getStatusClass(patient.status);
                
                return `
                    <a href="patient-details-backup.html?id=${patient.id}" class="patient-list-item ${isActive ? 'active' : ''}" data-patient-id="${patient.id}">
                        <div class="patient-avatar">${initials}</div>
                        <div class="patient-info">
                            <div class="patient-name">${patient.name || `${patient.firstName} ${patient.lastName}`}</div>
                            <div class="patient-phone">${patient.phone || 'Telefon belirtilmemi≈ü'}</div>
                        </div>
                        <div class="patient-status ${statusClass}" title="${getStatusText(patient.status)}"></div>
                    </a>
                `;
            }).join('');
            
            container.innerHTML = patientsHTML;
        }

        function getPatientInitials(patient) {
            const name = patient.name || `${patient.firstName || ''} ${patient.lastName || ''}`;
            const parts = name.trim().split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            }
            return (parts[0] || 'H')[0].toUpperCase();
        }

        function getStatusClass(status) {
            switch (status) {
                case 'active': return 'active';
                case 'inactive': return 'inactive';
                case 'pending': return 'pending';
                default: return 'pending';
            }
        }

        function getStatusText(status) {
            switch (status) {
                case 'active': return 'Aktif';
                case 'inactive': return 'Pasif';
                case 'pending': return 'Beklemede';
                default: return 'Bilinmiyor';
            }
        }

        function setupPatientSearch() {
            const searchInput = document.getElementById('patientSearchInput');
            if (!searchInput) return;
            
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (!window.allPatients) return;
                
                const filteredPatients = window.allPatients.filter(patient => {
                    const name = (patient.name || `${patient.firstName} ${patient.lastName}`).toLowerCase();
                    const phone = (patient.phone || '').toLowerCase();
                    
                    return name.includes(query) || phone.includes(query);
                });
                
                renderPatientList(filteredPatients);
            });
        }

        // Patient List Toggle Function
        window.togglePatientList = function() {
            const patientSidebar = document.getElementById('patient-list-sidebar');
            
            if (patientSidebar) {
                patientSidebar.classList.toggle('collapsed');
                
                // Save state to localStorage
                const isCollapsed = patientSidebar.classList.contains('collapsed');
                localStorage.setItem('patientListCollapsed', isCollapsed);
                
                console.log('üîÑ Patient list toggled:', isCollapsed ? 'collapsed' : 'expanded');
                
                // Update layout immediately
                updateLayoutMargins();
                
                // Force a second update after transition completes
                setTimeout(() => {
                    updateLayoutMargins();
                    console.log('‚úÖ Patient list toggle layout update complete');
                }, 350); // Slightly longer than CSS transition
            }
        };

        // Adjust layout based on sidebar states
        function adjustLayoutForSidebars() {
            const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            const patientListCollapsed = localStorage.getItem('patientListCollapsed') === 'true';
            
            const sidebar = document.querySelector('.sidebar-nav');
            const patientSidebar = document.getElementById('patient-list-sidebar');
            const mainContent = document.querySelector('.patient-details-content');
            
            console.log('üîÑ Adjusting initial layout:', { sidebarCollapsed, patientListCollapsed });
            
            if (sidebarCollapsed && sidebar) {
                sidebar.classList.add('collapsed');
            }
            
            if (patientListCollapsed && patientSidebar) {
                patientSidebar.classList.add('collapsed');
            }
            
            // Ensure elements exist before applying layout
            if (sidebar && patientSidebar && mainContent) {
                // Apply layout adjustments immediately and again after DOM is fully ready
                updateLayoutMargins();
                setTimeout(() => {
                    updateLayoutMargins();
                    console.log('‚úÖ Initial layout adjustment complete');
                }, 100);
            } else {
                console.warn('‚ö†Ô∏è Some layout elements not found during initialization:', { 
                    sidebar: !!sidebar, 
                    patientSidebar: !!patientSidebar, 
                    mainContent: !!mainContent 
                });
                // Retry after a longer delay if elements are missing
                setTimeout(() => adjustLayoutForSidebars(), 500);
            }
        }

        function updateLayoutMargins() {
            const sidebar = document.querySelector('.sidebar-nav');
            const patientSidebar = document.getElementById('patient-list-sidebar');
            const mainContent = document.querySelector('.patient-details-content');
            const toggleButton = document.getElementById('patient-list-toggle-collapsed');
            
            if (!sidebar || !patientSidebar || !mainContent) {
                console.log('Missing elements for layout update');
                return;
            }
            
            const sidebarCollapsed = sidebar.classList.contains('collapsed');
            const patientListCollapsed = patientSidebar.classList.contains('collapsed');
            
            console.log('Layout update:', { sidebarCollapsed, patientListCollapsed });
            
            // Clear all existing classes first
            patientSidebar.classList.remove('main-sidebar-collapsed');
            mainContent.classList.remove('main-sidebar-collapsed', 'patient-list-collapsed');
            
            // Apply classes to control layout via CSS
            if (sidebarCollapsed) {
                patientSidebar.classList.add('main-sidebar-collapsed');
                mainContent.classList.add('main-sidebar-collapsed');
            }
            
            if (patientListCollapsed) {
                mainContent.classList.add('patient-list-collapsed');
                // Show toggle button when patient list is collapsed
                if (toggleButton) {
                    toggleButton.style.display = 'block';
                    // Position it correctly based on main sidebar state
                    toggleButton.style.left = sidebarCollapsed ? '90px' : '250px';
                }
            } else {
                // Hide toggle button when patient list is open
                if (toggleButton) {
                    toggleButton.style.display = 'none';
                }
            }
            
            // Force a reflow to ensure the layout changes take effect immediately
            mainContent.offsetHeight;
            
            // Remove any inline styles that might override CSS
            patientSidebar.style.width = '';
            patientSidebar.style.left = '';
            mainContent.style.marginLeft = '';
            
            console.log('‚úÖ Layout updated - Classes applied:', {
                patientSidebarClasses: Array.from(patientSidebar.classList),
                mainContentClasses: Array.from(mainContent.classList)
            });
            
            console.log('CSS classes applied, toggle button visibility updated');
        }

        // Override the global sidebar toggle to adjust patient list position
        window.toggleSidebar = function() {
            const sidebar = document.querySelector('.sidebar-nav');
            
            if (sidebar) {
                sidebar.classList.toggle('collapsed');
                const isCollapsed = sidebar.classList.contains('collapsed');
                
                // Save state to localStorage
                localStorage.setItem('sidebarCollapsed', isCollapsed);
                
                updateLayoutMargins();
            }
        };

        // Load documents tab data
        function loadDocumentsTabData() {
            console.log('üìÑ Loading documents tab data...');
            
            // Populate E-re√ßete No field if patient has this data
            if (window.patientDetailsManager?.currentPatient) {
                const patient = window.patientDetailsManager.currentPatient;
                const eReceiptField = document.getElementById('eReceiptNo');
                
                if (eReceiptField && patient.eReceiptNo) {
                    eReceiptField.value = patient.eReceiptNo;
                    console.log('‚úÖ E-re√ßete No loaded:', patient.eReceiptNo);
                }
            }
        }

        // E-receipt query function
        async function queryEReceipt() {
            const eReceiptNo = document.getElementById('eReceiptNo').value.trim();
            const resultDiv = document.getElementById('eReceiptResult');
            
            if (!eReceiptNo) {
                alert('L√ºtfen E-re√ßete numarasƒ±nƒ± giriniz.');
                return;
            }
            
            // Show loading
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = `
                <div class="flex items-center justify-center p-4 bg-blue-50 rounded-lg">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-3"></div>
                    <span class="text-blue-700">E-re√ßete sorgulanƒ±yor...</span>
                </div>
            `;
            
            try {
                // Simulate API call - replace with actual SGK e-receipt API
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Mock response with comprehensive material list
                const mockResponse = {
                    success: true,
                    receiptNumber: eReceiptNo,
                    doctorName: 'Dr. Ahmet Yƒ±lmaz',
                    receiptDate: new Date().toLocaleDateString('tr-TR'),
                    patientInfo: {
                        name: document.querySelector('[data-field="name"]')?.textContent || 'Hasta Adƒ±',
                        tcNo: document.querySelector('[data-field="tcNo"]')?.textContent || 'TC No'
                    },
                    materials: [
                        {
                            id: 'hearing_aid_right',
                            name: 'Dijital programlanabilir i≈üitme cihazƒ± - saƒü',
                            kdv: '0 KDV',
                            available: true,
                            selected: false
                        },
                        {
                            id: 'hearing_aid_left',
                            name: 'Dijital programlanabilir i≈üitme cihazƒ± - sol',
                            kdv: '0 KDV',
                            available: true,
                            selected: false
                        },
                        {
                            id: 'mold_right',
                            name: 'ƒ∞≈üitme cihazƒ± kalƒ±bƒ± - saƒü',
                            kdv: '0 KDV',
                            available: true,
                            selected: false
                        },
                        {
                            id: 'mold_left',
                            name: 'ƒ∞≈üitme cihazƒ± kalƒ±bƒ± - sol',
                            kdv: '0 KDV',
                            available: true,
                            selected: false
                        },
                        {
                            id: 'battery_right',
                            name: 'ƒ∞≈üitme cihazƒ± pili - saƒü',
                            kdv: '%20 KDV',
                            available: true,
                            selected: false
                        },
                        {
                            id: 'battery_left',
                            name: 'ƒ∞≈üitme cihazƒ± pili - sol',
                            kdv: '%20 KDV',
                            available: true,
                            selected: false
                        },
                        {
                            id: 'ci_battery_right',
                            name: 'Koklear implant pili - saƒü',
                            kdv: '%20 KDV',
                            available: false,
                            selected: false
                        },
                        {
                            id: 'ci_battery_left',
                            name: 'Koklear implant pili - sol',
                            kdv: '%20 KDV',
                            available: false,
                            selected: false
                        }
                    ],
                    status: 'Ge√ßerli',
                    validUntil: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toLocaleDateString('tr-TR')
                };
                
                if (mockResponse.success) {
                    resultDiv.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center mb-4">
                                <svg class="w-5 h-5 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                                <h5 class="text-green-800 font-medium">E-re√ßete Bulundu</h5>
                            </div>
                            
                            <!-- Receipt Info -->
                            <div class="mb-4 p-3 bg-white rounded border">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                                    <div><span class="font-medium">E-re√ßete Tarihi:</span> ${mockResponse.receiptDate}</div>
                                    <div><span class="font-medium">Doktor:</span> ${mockResponse.doctorName}</div>
                                    <div><span class="font-medium">Ge√ßerlilik:</span> ${mockResponse.validUntil}</div>
                                </div>
                            </div>
                            
                            <!-- Materials List -->
                            <div class="mb-4">
                                <h6 class="font-medium text-gray-800 mb-3">Re√ßete Kapsamƒ±ndaki Malzemeler:</h6>
                                <div class="space-y-2" id="materialsList">
                                    ${mockResponse.materials.map(material => `
                                        <div class="flex items-center justify-between p-3 bg-white rounded border ${!material.available ? 'opacity-50' : ''}">
                                            <div class="flex items-center">
                                                <input 
                                                    type="checkbox" 
                                                    id="material_${material.id}"
                                                    ${!material.available ? 'disabled' : ''}
                                                    class="mr-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                                    onchange="toggleMaterial('${material.id}', this.checked)"
                                                >
                                                <div>
                                                    <div class="font-medium text-gray-900">${material.name}</div>
                                                    <div class="text-sm text-gray-500">${material.kdv}</div>
                                                </div>
                                            </div>
                                            ${!material.available ? '<span class="text-red-500 text-xs">Mevcut Deƒüil</span>' : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Application Date Selection -->
                            <div class="mb-4">
                                <label for="applicationDate" class="block text-sm font-medium text-gray-700 mb-2">Hasta Ba≈üvuru Tarihi:</label>
                                <input 
                                    type="date" 
                                    id="applicationDate"
                                    value="${new Date().toISOString().split('T')[0]}"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                >
                            </div>
                            
                            <!-- Save Button -->
                            <div class="flex justify-end">
                                <button 
                                    onclick="saveEReceipt('${eReceiptNo}')" 
                                    class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
                                    E-re√ßete Kaydet
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Store the receipt data for saving
                    window.currentEReceiptData = mockResponse;
                } else {
                    resultDiv.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-red-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                </svg>
                                <span class="text-red-800">E-re√ßete bulunamadƒ± veya ge√ßersiz.</span>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('E-re√ßete sorgulama hatasƒ±:', error);
                resultDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-red-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                            </svg>
                            <span class="text-red-800">Sorgu sƒ±rasƒ±nda bir hata olu≈ütu. L√ºtfen tekrar deneyin.</span>
                        </div>
                    </div>
                `;
            }
        }

        // E-re√ßete query function (alias for compatibility)
        window.queryErecepte = queryEReceipt;

        // Toggle material selection
        function toggleMaterial(materialId, isSelected) {
            if (window.currentEReceiptData && window.currentEReceiptData.materials) {
                const material = window.currentEReceiptData.materials.find(m => m.id === materialId);
                if (material) {
                    material.selected = isSelected;
                }
            }
        }

        // Material delivery function
        function deliverMaterial(materialId, receiptId) {
            const deliveryDate = document.getElementById(`deliveryDate_${materialId}`).value;
            if (!deliveryDate) {
                alert('L√ºtfen teslim tarihini se√ßin.');
                return;
            }

            const patient = window.patientDetailsManager?.currentPatient;
            if (!patient || !patient.savedEReceipts) return;

            const receipt = patient.savedEReceipts.find(r => r.id === receiptId);
            if (!receipt) return;

            const material = receipt.materials.find(m => m.id === materialId);
            if (!material) return;

            // Mark material as delivered
            material.delivered = true;
            material.deliveryDate = deliveryDate;
            material.deliveredBy = 'Current User'; // You can get this from user session

            // Update patient data
            updatePatientInStorage(patient);

            // Reload the display
            loadSavedEReceipts();

            showNotification('Malzeme teslimi kaydedildi.', 'success');
        }
        
        // Use e-receipt data to populate patient form
        function useEReceiptData(receiptNo) {
            console.log('Using e-receipt data for:', receiptNo);
            
            // Update the patient's E-re√ßete No
            if (window.patientDetailsManager?.currentPatient) {
                window.patientDetailsManager.currentPatient.eReceiptNo = receiptNo;
                
                // Save to storage
                if (window.patientDetailsManager.savePatientToStorage) {
                    window.patientDetailsManager.savePatientToStorage();
                }
                
                // Update the field (it should already be filled)
                const eReceiptField = document.getElementById('eReceiptNo');
                if (eReceiptField) {
                    eReceiptField.value = receiptNo;
                }
                
                alert('‚úÖ E-re√ßete numarasƒ± hasta kaydƒ±na eklendi.');
            } else {
                alert('E-re√ßete verileri hastanƒ±n bilgilerine eklendi.\n(Bu √∂zellik geli≈ütirilme a≈üamasƒ±nda)');
            }
        }
        
        // Print e-receipt
        function printEReceipt(receiptNo) {
            console.log('Printing e-receipt:', receiptNo);
            alert('E-re√ßete yazdƒ±rƒ±lƒ±yor...\n(Bu √∂zellik geli≈ütirilme a≈üamasƒ±nda)');
        }

        // Document upload handling functions
        function handleDocumentUpload(type, fileInput) {
            const file = fileInput.files[0];
            if (!file) return;

            const statusEl = document.querySelector(`[data-doc-type="${type}"] .upload-status`);
            const previewEl = document.querySelector(`[data-doc-type="${type}"] .document-preview`);
            
            // Show loading
            statusEl.innerHTML = '<span class="text-yellow-600">Y√ºkleniyor...</span>';
            
            // Create file reader
            const reader = new FileReader();
            reader.onload = function(e) {
                // Store the file data
                if (!window.uploadedDocuments) {
                    window.uploadedDocuments = {};
                }
                
                window.uploadedDocuments[type] = {
                    name: file.name,
                    type: file.type,
                    data: e.target.result,
                    uploadDate: new Date().toISOString()
                };
                
                // Update status
                statusEl.innerHTML = '<span class="text-green-600">‚úì Y√ºklendi</span>';
                
                // Show preview
                if (file.type.startsWith('image/')) {
                    previewEl.innerHTML = `
                        <img src="${e.target.result}" alt="Belge √ñnizleme" 
                             class="w-full h-32 object-cover rounded border">
                    `;
                } else {
                    previewEl.innerHTML = `
                        <div class="w-full h-32 bg-gray-100 rounded border flex items-center justify-center">
                            <span class="text-gray-600">üìÑ ${file.name}</span>
                        </div>
                    `;
                }
                
                // Convert to PDF if it's an image
                if (file.type.startsWith('image/')) {
                    convertImageToPDF(type, e.target.result, file.name);
                }
            };
            
            reader.readAsDataURL(file);
        }

        function convertImageToPDF(type, imageData, fileName) {
            return new Promise((resolve, reject) => {
                try {
                    console.log(`üîÑ Starting PDF conversion for: ${fileName}`);
                    
                    // Check if jsPDF is available
                    if (!window.jspdf || !window.jspdf.jsPDF) {
                        console.warn('jsPDF not available, using canvas fallback for:', fileName);
                        return convertImageToPDFCanvas(type, imageData, fileName)
                            .then(resolve)
                            .catch(reject);
                    }

                    const { jsPDF } = window.jspdf;
                    
                    // Create a new image element to get dimensions
                    const img = new Image();
                    img.crossOrigin = 'anonymous'; // Handle CORS issues
                    
                    img.onload = function() {
                        try {
                            console.log(`üìê Image loaded: ${img.width}x${img.height} for ${fileName}`);
                            
                            // Create PDF document
                            const pdf = new jsPDF({
                                orientation: img.width > img.height ? 'landscape' : 'portrait',
                                unit: 'mm',
                                format: 'a4'
                            });
                            
                            // Get page dimensions
                            const pageWidth = pdf.internal.pageSize.getWidth();
                            const pageHeight = pdf.internal.pageSize.getHeight();
                            const margin = 10;
                            
                            // Calculate image dimensions to fit the page
                            const maxWidth = pageWidth - (margin * 2);
                            const maxHeight = pageHeight - (margin * 2);
                            
                            const imgAspectRatio = img.width / img.height;
                            let imgWidth = maxWidth;
                            let imgHeight = maxWidth / imgAspectRatio;
                            
                            // If height exceeds page, scale down
                            if (imgHeight > maxHeight) {
                                imgHeight = maxHeight;
                                imgWidth = maxHeight * imgAspectRatio;
                            }
                            
                            // Center the image on the page
                            const x = (pageWidth - imgWidth) / 2;
                            const y = (pageHeight - imgHeight) / 2;
                            
                            console.log(`üìÑ Adding image to PDF: ${imgWidth}x${imgHeight} at (${x},${y})`);
                            
                            // Determine image format from data URL
                            let imageFormat = 'JPEG';
                            if (imageData.indexOf('data:image/png') === 0) {
                                imageFormat = 'PNG';
                            } else if (imageData.indexOf('data:image/gif') === 0) {
                                imageFormat = 'GIF';
                            }
                            
                            // Add image to PDF
                            pdf.addImage(imageData, imageFormat, x, y, imgWidth, imgHeight, '', 'FAST');
                            
                            // Add metadata footer
                            const today = new Date().toLocaleDateString('tr-TR');
                            const patientName = document.querySelector('.patient-name')?.textContent || 
                                             window.patientDetailsManager?.currentPatient?.name || 'Bilinmiyor';
                            
                            pdf.setFontSize(8);
                            pdf.setTextColor(128);
                            pdf.text(`Tarih: ${today}`, margin, pageHeight - 10);
                            pdf.text(`Hasta: ${patientName}`, margin, pageHeight - 5);
                            pdf.text(`Dosya: ${fileName}`, pageWidth - 60, pageHeight - 5);
                            
                            // Convert to data URL
                            const pdfData = pdf.output('datauristring');
                            
                            // Store PDF data in the correct structure
                            if (window.uploadedDocuments && window.uploadedDocuments[type]) {
                                if (Array.isArray(window.uploadedDocuments[type])) {
                                    // Find the correct document in the array
                                    const docArray = window.uploadedDocuments[type];
                                    const targetDoc = docArray.find(doc => 
                                        doc.suggestedName === fileName || 
                                        doc.originalName === fileName ||
                                        doc.name === fileName
                                    );
                                    if (targetDoc) {
                                        targetDoc.pdf = {
                                            data: pdfData,
                                            name: fileName.replace(/\.[^/.]+$/, "") + ".pdf",
                                            size: pdfData.length,
                                            converted: true
                                        };
                                        console.log(`‚úÖ PDF stored in array for ${type}: ${targetDoc.pdf.name}`);
                                    } else {
                                        console.warn(`‚ö†Ô∏è Could not find target document in array for ${fileName}`);
                                    }
                                } else {
                                    window.uploadedDocuments[type].pdf = {
                                        data: pdfData,
                                        name: fileName.replace(/\.[^/.]+$/, "") + ".pdf",
                                        size: pdfData.length,
                                        converted: true
                                    };
                                    console.log(`‚úÖ PDF stored as single object for ${type}: ${window.uploadedDocuments[type].pdf.name}`);
                                }
                            }
                            
                            console.log(`‚úÖ PDF created successfully for ${type}: ${fileName}`);
                            resolve(pdfData);
                            
                        } catch (pdfError) {
                            console.error('PDF creation error, trying canvas fallback:', pdfError);
                            // Fallback to canvas method
                            convertImageToPDFCanvas(type, imageData, fileName)
                                .then(resolve)
                                .catch(reject);
                        }
                    };
                    
                    img.onerror = function(error) {
                        console.error('Image loading failed for PDF conversion:', error);
                        // Try canvas fallback
                        convertImageToPDFCanvas(type, imageData, fileName)
                            .then(resolve)
                            .catch(reject);
                    };
                    
                    // Load the image
                    img.src = imageData;
                    
                } catch (error) {
                    console.error('PDF conversion error:', error);
                    reject(error);
                }
            });
        }

        function sendToSGK() {
            const uploadedDocs = window.uploadedDocuments || {};
            const requiredDocTypes = ['recete', 'odyogram', 'uygunluk', 'pil-recete'];
            
            const missingDocs = requiredDocTypes.filter(type => !uploadedDocs[type]);
            
            if (missingDocs.length > 0) {
                const missingNames = {
                    'recete': 'Re√ßete',
                    'odyogram': 'Odyogram',
                    'uygunluk': 'Uygunluk Belgesi',
                    'pil-recete': 'Pil Re√ßetesi'
                };
                const missingList = missingDocs.map(type => missingNames[type]).join(', ');
                alert(`Eksik belgeler: ${missingList}\n\nGerekli belgeleri y√ºkledikten sonra SGK'ya g√∂nderebilirsiniz.\n\nNot: "Diƒüer Belge" isteƒüe baƒülƒ±dƒ±r.`);
                return;
            }
            
            // Check OCR confidence for quality assurance
            const lowConfidenceDocs = [];
            Object.entries(uploadedDocs).forEach(([type, doc]) => {
                if (doc.ocrData && doc.ocrData.classification.confidence < 0.7) {
                    lowConfidenceDocs.push(doc.ocrData.classification.name);
                }
            });
            
            if (lowConfidenceDocs.length > 0) {
                const proceed = confirm(`A≈üaƒüƒ±daki belgelerin OCR g√ºven oranƒ± d√º≈ü√ºk:\n${lowConfidenceDocs.join(', ')}\n\nYine de SGK'ya g√∂ndermek istediƒüinizden emin misiniz?`);
                if (!proceed) return;
            }
            
            // Simulate sending to SGK
            const sgkButton = document.querySelector('.btn-success') || document.getElementById('sendToSGKBtn');
            const originalText = sgkButton.innerHTML;
            
            sgkButton.innerHTML = '<span class="animate-pulse">SGK\'ya G√∂nderiliyor...</span>';
            sgkButton.disabled = true;
            
            setTimeout(() => {
                sgkButton.innerHTML = '‚úì SGK\'ya G√∂nderildi';
                sgkButton.classList.remove('btn-success', 'btn-primary');
                sgkButton.classList.add('bg-green-700');
                
                // Store SGK submission with OCR data
                const submissionData = {
                    patient: document.querySelector('.patient-name')?.textContent || 'Hasta',
                    documents: uploadedDocs,
                    submissionDate: new Date().toISOString(),
                    status: 'submitted',
                    ocrProcessed: Object.values(uploadedDocs).some(doc => doc.ocrData),
                    totalDocuments: Object.keys(uploadedDocs).length,
                    requiredDocuments: requiredDocTypes.length,
                    additionalDocuments: uploadedDocs.diger ? 1 : 0
                };
                
                localStorage.setItem('sgk_submission_' + Date.now(), JSON.stringify(submissionData));
                
                // Create submission summary
                const totalDocs = Object.keys(uploadedDocs).length;
                const ocrProcessed = Object.values(uploadedDocs).filter(doc => doc.ocrData).length;
                
                alert(`‚úÖ Belgeler ba≈üarƒ±yla SGK'ya g√∂nderildi!\n\nüìä √ñzet:\n‚Ä¢ Toplam ${totalDocs} belge\n‚Ä¢ ${ocrProcessed} belge OCR ile i≈ülendi\n‚Ä¢ ${requiredDocTypes.length} zorunlu belge\n‚Ä¢ ${uploadedDocs.diger ? '1 ek belge' : 'Ek belge yok'}`);
            }, 2000);
        }

        function downloadAllDocuments() {
            const uploadedDocs = window.uploadedDocuments || {};
            
            if (Object.keys(uploadedDocs).length === 0) {
                alert('ƒ∞ndirilecek belge bulunamadƒ±.');
                return;
            }
            
            // Create a zip file simulation
            const downloadButton = document.querySelector('.btn-purple');
            const originalText = downloadButton.innerHTML;
            
            downloadButton.innerHTML = '<span class="animate-pulse">Hazƒ±rlanƒ±yor...</span>';
            downloadButton.disabled = true;
            
            setTimeout(() => {
                // In a real application, you would create and download actual files
                Object.entries(uploadedDocs).forEach(([type, doc]) => {
                    const link = document.createElement('a');
                    link.href = doc.data;
                    link.download = doc.name;
                    link.click();
                });
                
                downloadButton.innerHTML = originalText;
                downloadButton.disabled = false;
                
                alert('T√ºm belgeler indirildi!');
            }, 1500);
        }

        // OCR and document classification functions
        async function performOCR(imageData) {
            try {
                // Use Tesseract.js for real OCR
                const { data: { text, confidence } } = await Tesseract.recognize(
                    imageData,
                    'tur+eng', // Turkish and English language support
                    {
                        logger: m => console.log('OCR Progress:', m)
                    }
                );
                
                return {
                    text: text,
                    confidence: confidence / 100, // Convert to 0-1 range
                    detectedType: null // Will be determined by classification
                };
                
            } catch (error) {
                console.error('OCR Error:', error);
                
                // Fallback to mock data if OCR fails
                const mockOCRResults = [
                    {
                        text: "RE√áETE\nDoktor: Dr. Mehmet √ñzkan\nHasta: Ahmet Yƒ±lmaz\nƒ∞≈üitme Cihazƒ± Re√ßetesi\nTarih: 25.08.2024\nƒ∞mza: Dr. M. √ñzkan",
                        confidence: 0.92,
                        detectedType: "recete"
                    },
                    {
                        text: "ODYOGRAMƒ∞ TEST SONU√áLARI\nHasta: Ahmet Yƒ±lmaz\nSaƒü Kulak: 45 dB\nSol Kulak: 50 dB\nTest Tarihi: 20.08.2024\nAudiyolog: Uzm. Dr. Ay≈üe Kaya",
                        confidence: 0.89,
                        detectedType: "odyogram"
                    },
                    {
                        text: "UYGUNLUK BELGESƒ∞\nSosyal G√ºvenlik Kurumu\nHasta: Ahmet Yƒ±lmaz\nƒ∞≈üitme Cihazƒ± Kullanƒ±mƒ± ƒ∞√ßin Uygun\nBelge No: SGK/2024/1234\nTarih: 22.08.2024",
                        confidence: 0.95,
                        detectedType: "uygunluk"
                    },
                    {
                        text: "Pƒ∞L RE√áETESƒ∞\nHasta: Ahmet Yƒ±lmaz\nPil T√ºr√º: Zinc Air 312\nAdet: 60\nDoktor: Dr. Mehmet √ñzkan\nTarih: 25.08.2024",
                        confidence: 0.88,
                        detectedType: "pil-recete"
                    }
                ];
                
                // Return a random mock result for demonstration
                const randomResult = mockOCRResults[Math.floor(Math.random() * mockOCRResults.length)];
                return randomResult;
            }
        }

        function classifyDocument(ocrText) {
            const text = ocrText.toLowerCase();
            
            // Enhanced document classification rules with Turkish language support
            const classifications = [
                {
                    type: 'recete',
                    name: 'Re√ßete',
                    keywords: ['re√ßete', 'recete', 'doktor', 'dr.', 'i≈üitme cihazƒ±', 'i≈üitme cihazi', 'prescription', 'ila√ß', 'ilac'],
                    weightedKeywords: {
                        're√ßete': 3,
                        'recete': 3,
                        'doktor': 2,
                        'dr.': 2,
                        'i≈üitme cihazƒ±': 4,
                        'i≈üitme cihazi': 4,
                        'prescription': 3,
                        'ila√ß': 1,
                        'ilac': 1
                    },
                    excludeKeywords: ['test', 'sonu√ß', 'sonuc', 'uygunluk']
                },
                {
                    type: 'odyogram',
                    name: 'Odyogram',
                    keywords: ['odyogram', 'audiyogram', 'audiogram', 'kulak', 'test', 'sonu√ß', 'sonuc', 'db', 'desibel', 'saƒü kulak', 'sol kulak', 'right ear', 'left ear'],
                    weightedKeywords: {
                        'odyogram': 4,
                        'audiyogram': 4,
                        'audiogram': 4,
                        'kulak': 2,
                        'test': 2,
                        'sonu√ß': 2,
                        'sonuc': 2,
                        'db': 3,
                        'desibel': 3,
                        'saƒü kulak': 3,
                        'sol kulak': 3
                    },
                    excludeKeywords: ['re√ßete', 'recete', 'uygunluk', 'pil']
                },
                {
                    type: 'uygunluk',
                    name: 'Uygunluk Belgesi',
                    keywords: ['uygunluk', 'belge', 'belgesi', 'sgk', 'sosyal g√ºvenlik', 'sosyal guvenlik', 'onay', 'uygun', 'eligible', 'approval'],
                    weightedKeywords: {
                        'uygunluk': 4,
                        'belge': 2,
                        'belgesi': 3,
                        'sgk': 4,
                        'sosyal g√ºvenlik': 4,
                        'sosyal guvenlik': 4,
                        'onay': 3,
                        'uygun': 3
                    },
                    excludeKeywords: ['re√ßete', 'recete', 'test', 'pil']
                },
                {
                    type: 'pil-recete',
                    name: 'Pil Re√ßetesi',
                    keywords: ['pil', 'battery', 'zinc air', 're√ßete', 'recete', 'adet', 'piece', '312', '13', '675', '10'],
                    weightedKeywords: {
                        'pil': 4,
                        'battery': 4,
                        'zinc air': 4,
                        're√ßete': 2,
                        'recete': 2,
                        'adet': 3,
                        '312': 3,
                        '13': 3,
                        '675': 3,
                        '10': 3
                    },
                    excludeKeywords: ['odyogram', 'test', 'sonu√ß', 'sonuc']
                }
            ];
            
            let bestMatch = { type: 'diger', name: 'Diƒüer Belge', confidence: 0.1 };
            
            classifications.forEach(classification => {
                let score = 0;
                let keywordCount = 0;
                
                // Check weighted keywords
                Object.entries(classification.weightedKeywords).forEach(([keyword, weight]) => {
                    if (text.includes(keyword)) {
                        score += weight;
                        keywordCount++;
                    }
                });
                
                // Check regular keywords
                classification.keywords.forEach(keyword => {
                    if (text.includes(keyword) && !classification.weightedKeywords[keyword]) {
                        score += 1;
                        keywordCount++;
                    }
                });
                
                // Check exclude keywords (reduce score)
                if (classification.excludeKeywords) {
                    classification.excludeKeywords.forEach(keyword => {
                        if (text.includes(keyword)) {
                            score -= 2;
                        }
                    });
                }
                
                // Calculate confidence based on score and keyword density
                const textLength = text.split(' ').length;
                const keywordDensity = keywordCount / Math.max(textLength, 1);
                const confidence = Math.min((score / 10) + (keywordDensity * 2), 0.95);
                
                if (confidence > bestMatch.confidence && confidence > 0.3) {
                    bestMatch = {
                        type: classification.type,
                        name: classification.name,
                        confidence: confidence
                    };
                }
            });
            
            return bestMatch;
        }

        async function handleDocumentUploadWithOCR(fileInput, originalType) {
            const file = fileInput.files[0];
            if (!file) return;

            const statusEl = document.getElementById('otherDocStatus');
            const ocrResultsEl = document.getElementById('ocrResults');
            const ocrTextEl = document.getElementById('ocrText');
            const classificationEl = document.getElementById('documentClassification');
            
            // Show loading
            statusEl.innerHTML = '<span class="text-yellow-600">‚è≥ Dosya y√ºkleniyor ve OCR i≈üleniyor...</span>';
            ocrResultsEl.classList.add('hidden');
            
            try {
                // Read file
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const imageData = e.target.result;
                    
                    // Perform OCR
                    statusEl.innerHTML = '<span class="text-blue-600">üîç OCR ile metin tanƒ±nƒ±yor...</span>';
                    const ocrResult = await performOCR(imageData);
                    
                    // Classify document
                    statusEl.innerHTML = '<span class="text-purple-600">üß† Belge t√ºr√º belirleniyor...</span>';
                    const classification = classifyDocument(ocrResult.text);
                    
                    // Store the document with OCR data
                    if (!window.uploadedDocuments) {
                        window.uploadedDocuments = {};
                    }
                    
                    const documentKey = classification.type;
                    const suggestedName = generateDocumentName(classification, file.name);
                    
                    window.uploadedDocuments[documentKey] = {
                        originalName: file.name,
                        suggestedName: suggestedName,
                        type: file.type,
                        data: imageData,
                        uploadDate: new Date().toISOString(),
                        ocrData: {
                            text: ocrResult.text,
                            confidence: ocrResult.confidence,
                            classification: classification
                        }
                    };
                    
                    // Update UI
                    statusEl.innerHTML = `<span class="text-green-600">‚úÖ ${classification.name} olarak tanƒ±ndƒ± (%${Math.round(classification.confidence * 100)} g√ºven)</span>`;
                    
                    // Show OCR results
                    ocrTextEl.textContent = ocrResult.text.substring(0, 200) + (ocrResult.text.length > 200 ? '...' : '');
                    classificationEl.innerHTML = `
                        <span class="inline-block bg-${getColorForType(classification.type)}-100 text-${getColorForType(classification.type)}-800 px-2 py-1 rounded text-xs font-medium">
                            ${classification.name} (%${Math.round(classification.confidence * 100)} g√ºven)
                        </span>
                    `;
                    ocrResultsEl.classList.remove('hidden');
                    
                    // Auto-convert to PDF
                    await convertImageToPDF(documentKey, imageData, suggestedName);
                    
                    // Update documents summary
                    updateDocumentsSummary();
                };
                
                reader.readAsDataURL(file);
                
            } catch (error) {
                console.error('OCR processing error:', error);
                statusEl.innerHTML = '<span class="text-red-600">‚ùå OCR i≈ülemi ba≈üarƒ±sƒ±z oldu</span>';
            }
        }

        function generateDocumentName(classification, originalName) {
            const date = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            
            // Get current patient name from the patient data manager
            const currentPatient = window.patientDetailsManager?.currentPatient;
            let patientName = 'Hasta'; // Default fallback
            
            if (currentPatient && currentPatient.name) {
                // Clean the patient name for filename use
                patientName = currentPatient.name
                    .replace(/[√ß√á]/g, 'c')
                    .replace(/[ƒüƒû]/g, 'g') 
                    .replace(/[ƒ±I]/g, 'i')
                    .replace(/[√∂√ñ]/g, 'o')
                    .replace(/[≈ü≈û]/g, 's')
                    .replace(/[√º√ú]/g, 'u')
                    .replace(/[^a-zA-Z0-9\s]/g, '') // Remove special characters
                    .replace(/\s+/g, '_'); // Replace spaces with underscores
            }
            
            const extension = originalName.split('.').pop();
            
            const typeNames = {
                'recete': 'Recete',
                'odyogram': 'Odyogram', 
                'uygunluk': 'Uygunluk_Belgesi',
                'pil-recete': 'Pil_Recetesi',
                'diger': 'Diger_Belge'
            };
            
            const finalName = `${patientName}_${typeNames[classification.type] || 'Belge'}_${date}.${extension}`;
            console.log('üìù Generated document name (classification):', {
                patientName: currentPatient?.name,
                cleanPatientName: patientName,
                classificationType: classification.type,
                finalName
            });
            
            return finalName;
        }

        function getColorForType(type) {
            const colors = {
                'recete': 'orange',
                'odyogram': 'blue',
                'uygunluk': 'green',
                'pil-recete': 'purple',
                'diger': 'gray'
            };
            return colors[type] || 'gray';
        }

        function reclassifyDocument() {
            // Allow user to manually reclassify the document
            const classification = window.uploadedDocuments[Object.keys(window.uploadedDocuments).pop()]?.ocrData?.classification;
            
            if (!classification) return;
            
            const options = [
                { value: 'recete', label: 'Re√ßete' },
                { value: 'odyogram', label: 'Odyogram' },
                { value: 'uygunluk', label: 'Uygunluk Belgesi' },
                { value: 'pil-recete', label: 'Pil Re√ßetesi' },
                { value: 'diger', label: 'Diƒüer Belge' }
            ];
            
            let optionsHtml = options.map(opt => 
                `<option value="${opt.value}" ${opt.value === classification.type ? 'selected' : ''}>${opt.label}</option>`
            ).join('');
            
            const newType = prompt(`Belge t√ºr√ºn√º se√ßin:\n\n${options.map((opt, i) => `${i+1}. ${opt.label}`).join('\n')}\n\nSe√ßiminizi girin (1-5):`, '1');
            
            if (newType && newType >= 1 && newType <= 5) {
                const selectedType = options[parseInt(newType) - 1];
                
                // Update classification
                const lastDocKey = Object.keys(window.uploadedDocuments).pop();
                const doc = window.uploadedDocuments[lastDocKey];
                
                // Remove from old key and add to new key
                delete window.uploadedDocuments[lastDocKey];
                window.uploadedDocuments[selectedType.value] = {
                    ...doc,
                    suggestedName: generateDocumentName(selectedType, doc.originalName),
                    ocrData: {
                        ...doc.ocrData,
                        classification: { ...selectedType, confidence: 1.0 }
                    }
                };
                
                // Update UI
                const classificationEl = document.getElementById('documentClassification');
                classificationEl.innerHTML = `
                    <span class="inline-block bg-${getColorForType(selectedType.value)}-100 text-${getColorForType(selectedType.value)}-800 px-2 py-1 rounded text-xs font-medium">
                        ${selectedType.label} (Manuel Sƒ±nƒ±flandƒ±rma)
                    </span>
                `;
                
                updateDocumentsSummary();
                alert(`Belge "${selectedType.label}" olarak yeniden sƒ±nƒ±flandƒ±rƒ±ldƒ±.`);
            }
        }

        function processAllWithOCR() {
            alert('T√ºm y√ºklenmi≈ü belgeler OCR ile i≈ülenecek...\n(Bu √∂zellik geli≈ütirilme a≈üamasƒ±nda)');
        }

        function updateDocumentsSummary() {
            const summaryEl = document.getElementById('documentsListSummary');
            const uploadedDocs = window.uploadedDocuments || {};
            
            if (Object.keys(uploadedDocs).length === 0) {
                summaryEl.innerHTML = '<p class="text-gray-500 text-center py-4">Hen√ºz belge y√ºklenmedi</p>';
                return;
            }
            
            let summaryHtml = '';
            let totalDocuments = 0;
            let totalPDFs = 0;
            let totalImages = 0;
            
            Object.entries(uploadedDocs).forEach(([type, docs]) => {
                // Handle both single documents and arrays of documents
                const docArray = Array.isArray(docs) ? docs : [docs];
                
                docArray.forEach((doc, index) => {
                    totalDocuments++;
                    
                    const classification = doc.classification || doc.ocrData?.classification;
                    const confidence = classification ? Math.round(classification.confidence * 100) : 'N/A';
                    const isManual = doc.manualClassification;
                    const isPDFConverted = doc.pdf && doc.pdf.data;
                    const isImage = doc.type && doc.type.startsWith('image/');
                    
                    if (isImage) totalImages++;
                    if (isPDFConverted) totalPDFs++;
                    
                    summaryHtml += `
                        <div class="flex items-center justify-between p-3 bg-white rounded border">
                            <div class="flex items-center space-x-3">
                                <span class="text-2xl">${getIconForType(type)}</span>
                                <div>
                                    <p class="font-medium text-gray-900">${doc.suggestedName || doc.originalName}</p>
                                    <div class="flex items-center space-x-2 text-sm text-gray-500">
                                        ${isManual ? 
                                            '<span class="text-green-600">üë§ Manuel Sƒ±nƒ±flandƒ±rma</span>' :
                                            `<span>ü§ñ OCR G√ºven: %${confidence}</span>`
                                        }
                                        ${docArray.length > 1 ? `<span class="text-blue-600">(${index + 1}/${docArray.length})</span>` : ''}
                                        ${isImage ? (isPDFConverted ? 
                                            '<span class="text-green-600">üìÑ PDF ‚úì</span>' : 
                                            '<span class="text-orange-600">üìÑ PDF ‚úó</span>') : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="inline-block bg-${getColorForType(type)}-100 text-${getColorForType(type)}-800 px-2 py-1 rounded text-xs font-medium">
                                    ${classification?.name || type}
                                </span>
                                ${isPDFConverted ? `
                                    <button onclick="downloadPDF('${type}', '${doc.suggestedName || doc.originalName}')" 
                                            class="text-blue-600 hover:text-blue-800 text-xs px-2 py-1 rounded border border-blue-300 hover:bg-blue-50"
                                            title="PDF ƒ∞ndir">
                                        üì• PDF
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
            });
            
            // Add summary header with PDF conversion stats
            const pdfStatusText = totalImages > 0 ? 
                (totalPDFs === totalImages ? 
                    `‚úÖ T√ºm resimler PDF'e d√∂n√º≈üt√ºr√ºld√º (${totalPDFs}/${totalImages})` :
                    `‚ö†Ô∏è PDF d√∂n√º≈üt√ºrme: ${totalPDFs}/${totalImages} resim`) : '';
            
            const headerHtml = `
                <div class="bg-blue-50 p-3 rounded-lg mb-4">
                    <h6 class="font-medium text-blue-900">üìä Belge √ñzeti</h6>
                    <p class="text-sm text-blue-700">Toplam ${totalDocuments} belge y√ºklendi</p>
                    ${pdfStatusText ? `<p class="text-sm text-blue-700">${pdfStatusText}</p>` : ''}
                </div>
            `;
            
            summaryEl.innerHTML = headerHtml + summaryHtml;
            
            // Enable/disable action buttons
            const sendBtn = document.getElementById('sendToSGKBtn');
            const downloadBtn = document.getElementById('downloadAllBtn');
            
            if (sendBtn && downloadBtn) {
                sendBtn.disabled = false;
                downloadBtn.disabled = false;
                sendBtn.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed');
                downloadBtn.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed');
            }
        }

        function getIconForType(type) {
            const icons = {
                'recete': 'üìã',
                'odyogram': 'üëÇ',
                'uygunluk': '‚úÖ',
                'pil-recete': 'üîã',
                'diger': 'üìÑ'
            };
            return icons[type] || 'üìÑ';
        }

        // Bulk document upload and manual classification functions
        let uploadedFiles = []; // Store uploaded files temporarily

        function handleBulkDocumentUpload(fileInput) {
            const files = Array.from(fileInput.files);
            const statusEl = document.getElementById('bulkUploadStatus');
            const classificationArea = document.getElementById('uploadedFilesClassification');
            const classificationList = document.getElementById('filesClassificationList');
            
            if (files.length === 0) return;
            
            statusEl.innerHTML = `<span class="text-blue-600">üìÅ ${files.length} dosya y√ºklendi, sƒ±nƒ±flandƒ±rma i√ßin hazƒ±rlanƒ±yor...</span>`;
            
            // Clear previous uploads
            uploadedFiles = [];
            classificationList.innerHTML = '';
            
            // Process each file
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileData = {
                        id: `file_${Date.now()}_${index}`,
                        name: file.name,
                        type: file.type,
                        data: e.target.result,
                        size: file.size,
                        uploadDate: new Date().toISOString(),
                        classification: null // Will be set by user
                    };
                    
                    uploadedFiles.push(fileData);
                    
                    // Create classification UI for this file
                    createFileClassificationUI(fileData);
                    
                    // Show classification area when all files are loaded
                    if (uploadedFiles.length === files.length) {
                        classificationArea.classList.remove('hidden');
                        statusEl.innerHTML = `<span class="text-green-600">‚úÖ ${files.length} dosya y√ºklendi. L√ºtfen her dosyanƒ±n t√ºr√ºn√º se√ßin.</span>`;
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        function createFileClassificationUI(fileData) {
            const classificationList = document.getElementById('filesClassificationList');
            
            const fileDiv = document.createElement('div');
            fileDiv.className = 'bg-gray-50 p-4 rounded-lg border';
            fileDiv.id = `file-${fileData.id}`;
            
            fileDiv.innerHTML = `
                <div class="flex items-start space-x-4">
                    <!-- File Preview -->
                    <div class="flex-shrink-0">
                        ${fileData.type.startsWith('image/') ? 
                            `<img src="${fileData.data}" alt="√ñnizleme" class="w-20 h-20 object-cover rounded border">` :
                            `<div class="w-20 h-20 bg-gray-200 rounded border flex items-center justify-center">
                                <span class="text-2xl">üìÑ</span>
                            </div>`
                        }
                    </div>
                    
                    <!-- File Info and Classification -->
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-2">
                            <h6 class="font-medium text-gray-900">${fileData.name}</h6>
                            <span class="text-xs text-gray-500">${formatFileSize(fileData.size)}</span>
                        </div>
                        
                        <!-- Document Type Selection -->
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Belge T√ºr√º:</label>
                            <select id="docType-${fileData.id}" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" onchange="updateFileClassification('${fileData.id}', this.value)">
                                <option value="">Belge t√ºr√ºn√º se√ßin...</option>
                                <option value="recete">üìã Re√ßete</option>
                                <option value="odyogram">üëÇ Odyogram</option>
                                <option value="uygunluk">‚úÖ Uygunluk Belgesi</option>
                                <option value="pil-recete">üîã Pil Re√ßetesi</option>
                                <option value="diger">üìÑ Diƒüer Belge</option>
                            </select>
                        </div>
                        
                        <!-- Custom Name (Optional) -->
                        <div class="mb-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">√ñzel Dosya Adƒ± (ƒ∞steƒüe baƒülƒ±):</label>
                            <input type="text" id="customName-${fileData.id}" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm" placeholder="Bo≈ü bƒ±rakƒ±rsanƒ±z otomatik isim verilir">
                        </div>
                        
                        <!-- Generated Name Preview -->
                        <div id="namePreview-${fileData.id}" class="text-sm text-gray-600 bg-blue-50 p-2 rounded hidden">
                            <span class="font-medium">Olu≈üturulan dosya adƒ±:</span> <span id="generatedName-${fileData.id}"></span>
                        </div>
                    </div>
                </div>
            `;
            
            classificationList.appendChild(fileDiv);
        }

        function updateFileClassification(fileId, docType) {
            const fileData = uploadedFiles.find(f => f.id === fileId);
            if (!fileData) return;
            
            fileData.classification = docType;
            
            // Generate and show preview name
            if (docType) {
                const generatedName = generateDocumentNameForFile(docType, fileData.name);
                const namePreviewEl = document.getElementById(`namePreview-${fileId}`);
                const generatedNameEl = document.getElementById(`generatedName-${fileId}`);
                
                generatedNameEl.textContent = generatedName;
                namePreviewEl.classList.remove('hidden');
                
                // Check if all files are classified
                checkAllFilesClassified();
            }
        }

        function generateDocumentNameForFile(docType, originalName) {
            const date = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            
            // Get current patient name from the patient data manager
            const currentPatient = window.patientDetailsManager?.currentPatient;
            let patientName = 'Hasta'; // Default fallback
            
            if (currentPatient && currentPatient.name) {
                // Clean the patient name for filename use
                patientName = currentPatient.name
                    .replace(/[√ß√á]/g, 'c')
                    .replace(/[ƒüƒû]/g, 'g') 
                    .replace(/[ƒ±I]/g, 'i')
                    .replace(/[√∂√ñ]/g, 'o')
                    .replace(/[≈ü≈û]/g, 's')
                    .replace(/[√º√ú]/g, 'u')
                    .replace(/[^a-zA-Z0-9\s]/g, '') // Remove special characters
                    .replace(/\s+/g, '_'); // Replace spaces with underscores
            }
            
            const extension = originalName.split('.').pop();
            
            const typeNames = {
                'recete': 'Recete',
                'odyogram': 'Odyogram', 
                'uygunluk': 'Uygunluk_Belgesi',
                'pil-recete': 'Pil_Recetesi',
                'diger': 'Diger_Belge'
            };
            
            const finalName = `${patientName}_${typeNames[docType] || 'Belge'}_${date}.${extension}`;
            console.log('üìù Generated document name:', {
                patientName: currentPatient?.name,
                cleanPatientName: patientName,
                docType,
                finalName
            });
            
            return finalName;
        }

        function checkAllFilesClassified() {
            const allClassified = uploadedFiles.every(file => file.classification);
            const processBtn = document.getElementById('processDocsBtn');
            
            if (allClassified && uploadedFiles.length > 0) {
                processBtn.classList.remove('hidden');
            } else {
                processBtn.classList.add('hidden');
            }
        }

        function processClassifiedDocuments() {
            if (uploadedFiles.length === 0) return;
            
            const processBtn = document.getElementById('processDocsBtn');
            const originalText = processBtn.innerHTML;
            
            processBtn.innerHTML = '<span class="animate-pulse">ƒ∞≈üleniyor...</span>';
            processBtn.disabled = true;
            
            // Initialize uploadedDocuments if not exists
            if (!window.uploadedDocuments) {
                window.uploadedDocuments = {};
            }
            
            let processedCount = 0;
            let pdfConversionCount = 0;
            const totalFiles = uploadedFiles.length;
            const imageFiles = uploadedFiles.filter(file => file.type.startsWith('image/'));
            
            // Process each file
            uploadedFiles.forEach(async (fileData, index) => {
                try {
                    // Get custom name or generate one
                    const customNameInput = document.getElementById(`customName-${fileData.id}`);
                    const customName = customNameInput?.value?.trim();
                    const finalName = customName || generateDocumentNameForFile(fileData.classification, fileData.name);
                    
                    // Store document in the appropriate category
                    const docKey = fileData.classification;
                    
                    const documentData = {
                        originalName: fileData.name,
                        suggestedName: finalName,
                        type: fileData.type,
                        data: fileData.data,
                        uploadDate: fileData.uploadDate,
                        manualClassification: true,
                        classification: {
                            type: docKey,
                            name: getDocumentTypeName(docKey),
                            confidence: 1.0 // Manual classification = 100% confidence
                        }
                    };
                    
                    // If document type already exists, create array or add to existing
                    if (!window.uploadedDocuments[docKey]) {
                        window.uploadedDocuments[docKey] = documentData;
                    } else {
                        // Handle multiple documents of same type
                        if (!Array.isArray(window.uploadedDocuments[docKey])) {
                            // Convert single document to array
                            const existingDoc = window.uploadedDocuments[docKey];
                            window.uploadedDocuments[docKey] = [existingDoc];
                        }
                        
                        // Add new document to array
                        window.uploadedDocuments[docKey].push(documentData);
                    }
                    
                    processedCount++;
                    
                    // Convert to PDF if it's an image
                    if (fileData.type.startsWith('image/')) {
                        try {
                            processBtn.innerHTML = `<span class="animate-pulse">PDF'e d√∂n√º≈üt√ºr√ºl√ºyor... (${pdfConversionCount + 1}/${imageFiles.length})</span>`;
                            
                            await convertImageToPDF(docKey, fileData.data, finalName);
                            pdfConversionCount++;
                            
                            console.log(`‚úÖ PDF conversion completed for: ${finalName}`);
                            
                        } catch (pdfError) {
                            console.error('PDF conversion failed for:', finalName, pdfError);
                            
                            // Continue without PDF for this file
                            pdfConversionCount++;
                        }
                    }
                    
                    // Update UI when all files are processed
                    if (processedCount === totalFiles) {
                        setTimeout(() => {
                            processBtn.innerHTML = '‚úÖ Tamamlandƒ±';
                            
                            // Update documents summary
                            updateDocumentsSummary();
                            
                            // Clear the classification area
                            setTimeout(() => {
                                document.getElementById('uploadedFilesClassification').classList.add('hidden');
                                document.getElementById('bulkUploadStatus').innerHTML = `
                                    <div class="text-green-600">
                                        ‚úÖ ${totalFiles} belge i≈ülendi<br>
                                        üìÑ ${pdfConversionCount}/${imageFiles.length} resim PDF'e d√∂n√º≈üt√ºr√ºld√º
                                    </div>
                                `;
                                uploadedFiles = [];
                                
                                // Reset the file input
                                document.getElementById('bulkDocUpload').value = '';
                                processBtn.innerHTML = originalText;
                                processBtn.disabled = false;
                            }, 2000);
                            
                            const pdfMessage = imageFiles.length > 0 ? 
                                `\nüìÑ ${pdfConversionCount}/${imageFiles.length} resim PDF'e d√∂n√º≈üt√ºr√ºld√º` : '';
                            
                            alert(`‚úÖ ${totalFiles} belge ba≈üarƒ±yla i≈ülendi!${pdfMessage}\n\nBelgeler kendi kategorilerine kaydedildi.`);
                        }, 500);
                    }
                    
                } catch (error) {
                    console.error('Error processing file:', fileData.name, error);
                    processedCount++;
                    
                    // Still check if all files are done
                    if (processedCount === totalFiles) {
                        processBtn.innerHTML = '‚ö†Ô∏è Bazƒ± dosyalar i≈ülenemedi';
                        processBtn.disabled = false;
                    }
                }
            });
        }

        function getDocumentTypeName(type) {
            const names = {
                'recete': 'Re√ßete',
                'odyogram': 'Odyogram',
                'uygunluk': 'Uygunluk Belgesi',
                'pil-recete': 'Pil Re√ßetesi',
                'diger': 'Diƒüer Belge'
            };
            return names[type] || 'Bilinmeyen Belge';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Test PDF functionality on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                testPDFLibrary();
            }, 1000);
        });

        function testPDFLibrary() {
            try {
                console.log('üß™ Testing PDF library...');
                
                if (window.jspdf && window.jspdf.jsPDF) {
                    console.log('‚úÖ jsPDF library loaded successfully');
                    
                    // Test PDF creation
                    try {
                        const { jsPDF } = window.jspdf;
                        const testPdf = new jsPDF();
                        testPdf.text('Test', 10, 10);
                        console.log('‚úÖ jsPDF test creation successful');
                        
                        // Show success message to user
                        const statusElements = document.querySelectorAll('#bulkUploadStatus, #otherDocStatus');
                        statusElements.forEach(el => {
                            if (el) {
                                el.innerHTML = '<div class="text-green-600 text-sm">‚úÖ PDF d√∂n√º≈üt√ºrme sistemi hazƒ±r</div>';
                            }
                        });
                        
                    } catch (testError) {
                        console.error('‚ùå jsPDF creation test failed:', testError);
                        showPDFWarning();
                    }
                    
                } else {
                    console.warn('‚ö†Ô∏è jsPDF library not found');
                    showPDFWarning();
                }
            } catch (error) {
                console.error('‚ùå PDF library test failed:', error);
                showPDFWarning();
            }
        }

        function showPDFWarning() {
            const statusElements = document.querySelectorAll('#bulkUploadStatus, #otherDocStatus');
            statusElements.forEach(el => {
                if (el) {
                    el.innerHTML = '<div class="text-yellow-600 text-sm">‚ö†Ô∏è PDF d√∂n√º≈üt√ºrme k√ºt√ºphanesi y√ºklenemedi. Belgeler optimized image formatƒ±nda kaydedilecek.</div>';
                }
            });
        }

        // Add download function for PDFs
        function downloadPDF(type, fileName) {
            try {
                let pdfData = null;
                
                if (window.uploadedDocuments && window.uploadedDocuments[type]) {
                    if (Array.isArray(window.uploadedDocuments[type])) {
                        const docArray = window.uploadedDocuments[type];
                        const targetDoc = docArray.find(doc => 
                            doc.suggestedName === fileName || 
                            doc.originalName === fileName ||
                            doc.name === fileName
                        );
                        pdfData = targetDoc?.pdf?.data;
                    } else {
                        pdfData = window.uploadedDocuments[type].pdf?.data;
                    }
                }
                
                if (pdfData) {
                    // Create download link
                    const link = document.createElement('a');
                    link.href = pdfData;
                    link.download = fileName.replace(/\.[^/.]+$/, "") + ".pdf";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    console.log(`üì• PDF downloaded: ${link.download}`);
                } else {
                    alert('PDF bulunamadƒ±. L√ºtfen √∂nce belgeyi PDF\'e d√∂n√º≈üt√ºr√ºn.');
                }
                
            } catch (error) {
                console.error('Download error:', error);
                alert('ƒ∞ndirme sƒ±rasƒ±nda bir hata olu≈ütu.');
            }
        }

        // Add function to manually convert documents to PDF
        function convertDocumentsToPDF() {
            if (!window.uploadedDocuments) {
                alert('Y√ºklenmi≈ü belge bulunamadƒ±.');
                return;
            }

            let conversionCount = 0;
            let totalImages = 0;
            
            // Count total image files first
            Object.entries(window.uploadedDocuments).forEach(([type, docs]) => {
                if (Array.isArray(docs)) {
                    docs.forEach(doc => {
                        if (doc.type && doc.type.startsWith('image/')) {
                            totalImages++;
                        }
                    });
                } else if (docs.type && docs.type.startsWith('image/')) {
                    totalImages++;
                }
            });

            if (totalImages === 0) {
                alert('PDF\'e d√∂n√º≈üt√ºr√ºlecek resim dosyasƒ± bulunamadƒ±.');
                return;
            }

            const statusDiv = document.getElementById('bulkUploadStatus');
            if (statusDiv) {
                statusDiv.innerHTML = `<div class="text-blue-600">üîÑ PDF d√∂n√º≈üt√ºrme ba≈ülatƒ±lƒ±yor... (0/${totalImages})</div>`;
            }

            // Process each document type
            Object.entries(window.uploadedDocuments).forEach(([type, docs]) => {
                if (Array.isArray(docs)) {
                    docs.forEach(async (doc, index) => {
                        if (doc.type && doc.type.startsWith('image/')) {
                            try {
                                const fileName = doc.suggestedName || doc.originalName || doc.name || `document_${index}`;
                                await convertImageToPDF(type, doc.data, fileName);
                                conversionCount++;
                                
                                if (statusDiv) {
                                    statusDiv.innerHTML = `<div class="text-blue-600">üîÑ PDF d√∂n√º≈üt√ºr√ºl√ºyor... (${conversionCount}/${totalImages})</div>`;
                                }
                                
                                if (conversionCount === totalImages) {
                                    setTimeout(() => {
                                        if (statusDiv) {
                                            statusDiv.innerHTML = `<div class="text-green-600">‚úÖ ${conversionCount} belge PDF'e d√∂n√º≈üt√ºr√ºld√º</div>`;
                                        }
                                        updateDocumentsSummary();
                                    }, 500);
                                }
                                
                            } catch (error) {
                                console.error(`PDF conversion failed for ${fileName}:`, error);
                                conversionCount++;
                                
                                if (conversionCount === totalImages) {
                                    setTimeout(() => {
                                        if (statusDiv) {
                                            statusDiv.innerHTML = `<div class="text-yellow-600">‚ö†Ô∏è ${conversionCount} belge i≈ülendi (bazƒ± PDF d√∂n√º≈üt√ºrmeleri ba≈üarƒ±sƒ±z)</div>`;
                                        }
                                        updateDocumentsSummary();
                                    }, 500);
                                }
                            }
                        }
                    });
                } else if (docs.type && docs.type.startsWith('image/')) {
                    (async () => {
                        try {
                            const fileName = docs.suggestedName || docs.originalName || docs.name || 'document';
                            await convertImageToPDF(type, docs.data, fileName);
                            conversionCount++;
                            
                            if (statusDiv) {
                                statusDiv.innerHTML = `<div class="text-green-600">‚úÖ ${conversionCount} belge PDF'e d√∂n√º≈üt√ºr√ºld√º</div>`;
                            }
                            updateDocumentsSummary();
                            
                        } catch (error) {
                            console.error(`PDF conversion failed for ${type}:`, error);
                            conversionCount++;
                            
                            if (statusDiv) {
                                statusDiv.innerHTML = `<div class="text-yellow-600">‚ö†Ô∏è ${conversionCount} belge i≈ülendi (PDF d√∂n√º≈üt√ºrme ba≈üarƒ±sƒ±z)</div>`;
                            }
                        }
                    })();
                }
            });
        }

        // Alternative PDF conversion using canvas (fallback method)
        function convertImageToPDFCanvas(type, imageData, fileName) {
            return new Promise((resolve, reject) => {
                try {
                    console.log(`üîÑ Using canvas fallback for PDF conversion: ${fileName}`);
                    
                    const img = new Image();
                    img.onload = function() {
                        try {
                            // Create canvas
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // Set canvas size (A4 proportions)
                            const maxWidth = 595; // A4 width in points
                            const maxHeight = 842; // A4 height in points
                            
                            const imgAspectRatio = img.width / img.height;
                            let canvasWidth = maxWidth;
                            let canvasHeight = maxWidth / imgAspectRatio;
                            
                            if (canvasHeight > maxHeight) {
                                canvasHeight = maxHeight;
                                canvasWidth = maxHeight * imgAspectRatio;
                            }
                            
                            canvas.width = canvasWidth;
                            canvas.height = canvasHeight;
                            
                            // Draw image on canvas with white background
                            ctx.fillStyle = 'white';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            
                            // Convert canvas to blob and then to data URL
                            canvas.toBlob((blob) => {
                                if (!blob) {
                                    reject(new Error('Canvas to blob conversion failed'));
                                    return;
                                }
                                
                                const reader = new FileReader();
                                reader.onload = function() {
                                    const optimizedData = reader.result;
                                    
                                    // Store as "PDF" (actually optimized image)
                                    if (window.uploadedDocuments && window.uploadedDocuments[type]) {
                                        if (Array.isArray(window.uploadedDocuments[type])) {
                                            const docArray = window.uploadedDocuments[type];
                                            const targetDoc = docArray.find(doc => 
                                                doc.suggestedName === fileName || 
                                                doc.originalName === fileName ||
                                                doc.name === fileName
                                            );
                                            if (targetDoc) {
                                                targetDoc.pdf = {
                                                    data: optimizedData,
                                                    name: fileName.replace(/\.[^/.]+$/, "") + ".pdf",
                                                    note: "Optimized image (Canvas fallback)",
                                                    size: optimizedData.length,
                                                    converted: true
                                                };
                                                console.log(`‚úÖ Canvas PDF stored for ${type}: ${targetDoc.pdf.name}`);
                                            }
                                        } else {
                                            window.uploadedDocuments[type].pdf = {
                                                data: optimizedData,
                                                name: fileName.replace(/\.[^/.]+$/, "") + ".pdf",
                                                note: "Optimized image (Canvas fallback)",
                                                size: optimizedData.length,
                                                converted: true
                                            };
                                            console.log(`‚úÖ Canvas PDF stored for ${type}: ${window.uploadedDocuments[type].pdf.name}`);
                                        }
                                    }
                                    
                                    console.log(`‚úÖ Canvas-based "PDF" created for ${type}: ${fileName}`);
                                    resolve(optimizedData);
                                };
                                reader.onerror = () => reject(new Error('FileReader error'));
                                reader.readAsDataURL(blob);
                            }, 'image/jpeg', 0.9);
                            
                        } catch (canvasError) {
                            console.error('Canvas processing error:', canvasError);
                            reject(canvasError);
                        }
                    };
                    
                    img.onerror = () => reject(new Error('Image loading failed in canvas fallback'));
                    img.src = imageData;
                    
                } catch (error) {
                    console.error('Canvas fallback setup error:', error);
                    reject(error);
                }
            });
        }

        // Function to open the dedicated documents page
        function openDocumentsPage() {
            const baseUrl = window.location.origin + window.location.pathname.replace('patient-details-backup.html', 'patient-documents.html');
            const url = `${baseUrl}?patient=${currentPatientId}`;
            window.location.href = url;
        }

        // ==================== NEW SGK ENHANCED FUNCTIONS ====================

        // Query patient report using TC number
        async function queryPatientReport() {
            const patient = window.patientDetailsManager?.currentPatient;
            if (!patient || !patient.tcNumber) {
                alert('Hasta TC kimlik numarasƒ± bulunamadƒ±. L√ºtfen hasta bilgilerini kontrol edin.');
                return;
            }

            const resultDiv = document.getElementById('reportResult');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = `
                <div class="flex items-center justify-center p-4 bg-blue-50 rounded-lg">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-3"></div>
                    <span class="text-blue-700">Rapor sorgulanƒ±yor...</span>
                </div>
            `;

            try {
                // Simulate API call - replace with actual SGK API
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Mock response
                const mockReportData = {
                    success: true,
                    tcNumber: patient.tcNumber,
                    patientName: patient.name,
                    reports: [
                        {
                            type: 'device',
                            name: 'ƒ∞≈üitme Cihazƒ± Raporu',
                            issueDate: '2024-01-15',
                            validUntil: '2029-01-15',
                            remainingYears: Math.round((new Date('2029-01-15') - new Date()) / (365 * 24 * 60 * 60 * 1000)),
                            status: 'active'
                        },
                        {
                            type: 'battery',
                            name: 'Pil Raporu',
                            issueDate: '2024-08-01',
                            validUntil: '2025-08-01',
                            remainingMonths: Math.round((new Date('2025-08-01') - new Date()) / (30 * 24 * 60 * 60 * 1000)),
                            status: 'active'
                        }
                    ]
                };

                if (mockReportData.success) {
                    resultDiv.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h5 class="text-green-800 font-medium mb-3">Rapor Sorgu Sonucu</h5>
                            <div class="space-y-3">
                                ${mockReportData.reports.map(report => `
                                    <div class="bg-white p-3 rounded border">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <h6 class="font-medium text-gray-900">${report.name}</h6>
                                                <p class="text-sm text-gray-600">Rapor Tarihi: ${report.issueDate}</p>
                                                <p class="text-sm text-gray-600">Ge√ßerlilik: ${report.validUntil}</p>
                                            </div>
                                            <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Aktif</span>
                                        </div>
                                        <div class="mt-2">
                                            ${report.type === 'device' ? 
                                                `<p class="text-sm text-blue-600">Kalan s√ºre: ${report.remainingYears} yƒ±l</p>` :
                                                `<p class="text-sm text-blue-600">Kalan s√ºre: ${report.remainingMonths} ay</p>`
                                            }
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <span class="text-yellow-800">Bu hasta i√ßin aktif rapor bulunamadƒ±.</span>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Rapor sorgulama hatasƒ±:', error);
                resultDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <span class="text-red-800">Rapor sorgulanƒ±rken bir hata olu≈ütu.</span>
                    </div>
                `;
            }
        }

        // Load patient notes
        function loadPatientNotes() {
            const patient = window.patientDetailsManager?.currentPatient;
            const notesContainer = document.getElementById('patientNotes');
            
            if (!notesContainer) return;

            // Get notes from patient data and ensure it's an array
            let notes = patient?.notes || [];
            if (!Array.isArray(notes)) {
                notes = [];
            }
            
            if (notes.length === 0) {
                notesContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p>Hen√ºz not eklenmemi≈ü.</p>
                        <button onclick="addPatientNote()" class="btn-primary mt-2">ƒ∞lk Notu Ekle</button>
                    </div>
                `;
                return;
            }

            // Sort notes by date (newest first)
            notes.sort((a, b) => new Date(b.date) - new Date(a.date));

            notesContainer.innerHTML = `
                <div class="space-y-4">
                    ${notes.map(note => `
                        <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg">
                            <div class="flex justify-between items-start mb-2">
                                <h5 class="font-medium text-gray-900">${note.title || 'Hasta Notu'}</h5>
                                <div class="flex items-center space-x-2">
                                    <span class="text-sm text-gray-500">${note.date}</span>
                                    <button onclick="editPatientNote('${note.id}')" class="text-blue-600 hover:text-blue-800 text-sm">D√ºzenle</button>
                                    <button onclick="deletePatientNote('${note.id}')" class="text-red-600 hover:text-red-800 text-sm">Sil</button>
                                </div>
                            </div>
                            <p class="text-gray-700">${note.content}</p>
                            ${note.type ? `<span class="inline-block mt-2 px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">${note.type}</span>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Add new patient note
        function addPatientNote() {
            const noteModal = `
                <div id="noteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-900">Yeni Not Ekle</h3>
                            <button onclick="closeNoteModal()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <form onsubmit="savePatientNote(event)">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Not Ba≈ülƒ±ƒüƒ±</label>
                                <input type="text" id="noteTitle" class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Not ba≈ülƒ±ƒüƒ±..." required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Not T√ºr√º</label>
                                <select id="noteType" class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                                    <option value="">Se√ßiniz</option>
                                    <option value="Arama Notu">Arama Notu</option>
                                    <option value="Deƒüerlendirme">Deƒüerlendirme</option>
                                    <option value="Deneme Sonucu">Deneme Sonucu</option>
                                    <option value="Kontrol">Kontrol</option>
                                    <option value="Genel">Genel</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Not ƒ∞√ßeriƒüi</label>
                                <textarea id="noteContent" rows="4" class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Not i√ßeriƒüini buraya yazƒ±n..." required></textarea>
                            </div>
                            <div class="flex justify-end space-x-3">
                                <button type="button" onclick="closeNoteModal()" class="btn-secondary">ƒ∞ptal</button>
                                <button type="submit" class="btn-primary">Kaydet</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', noteModal);
        }

        // Save patient note
        function savePatientNote(event) {
            event.preventDefault();
            
            const title = document.getElementById('noteTitle').value;
            const type = document.getElementById('noteType').value;
            const content = document.getElementById('noteContent').value;
            
            const patient = window.patientDetailsManager?.currentPatient;
            if (!patient) return;

            // Initialize notes array if it doesn't exist
            if (!patient.notes) {
                patient.notes = [];
            }

            const newNote = {
                id: 'note_' + Date.now(),
                title: title,
                type: type,
                content: content,
                date: new Date().toLocaleDateString('tr-TR'),
                timestamp: new Date().toISOString()
            };

            patient.notes.push(newNote);
            
            // Update patient data in storage
            updatePatientInStorage(patient);
            
            // Reload notes display
            loadPatientNotes();
            
            // Close modal
            closeNoteModal();
            
            // Show success message
            showNotification('Not ba≈üarƒ±yla kaydedildi.', 'success');
        }

        // Close note modal
        function closeNoteModal() {
            const modal = document.getElementById('noteModal');
            if (modal) {
                modal.remove();
            }
        }

        // Check device assignment eligibility
        function checkDeviceAssignmentEligibility() {
            const patient = window.patientDetailsManager?.currentPatient;
            const devicePanel = document.getElementById('deviceAssignmentPanel');
            
            if (!patient || !devicePanel) return;

            // Show device assignment panel if patient is "Kontrol Hastasƒ±"
            if (patient.conversionStep === 'control_patient' || patient.status === 'Kontrol Hastasƒ±') {
                devicePanel.style.display = 'block';
                loadAssignedDevices();
            } else {
                devicePanel.style.display = 'none';
            }
        }

        // Load assigned devices
        function loadAssignedDevices() {
            const patient = window.patientDetailsManager?.currentPatient;
            const devicesContainer = document.getElementById('assignedDevices');
            
            if (!devicesContainer || !patient) return;

            const assignedDevices = patient.assignedDevices || [];
            
            if (assignedDevices.length === 0) {
                devicesContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p>Atanmƒ±≈ü cihaz bulunmamaktadƒ±r.</p>
                        <button onclick="assignDevice()" class="btn-primary mt-2">Cihaz Ata</button>
                    </div>
                `;
                return;
            }

            devicesContainer.innerHTML = `
                <div class="space-y-4">
                    ${assignedDevices.map(device => `
                        <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h5 class="font-medium text-gray-900">${device.manufacturer} ${device.model}</h5>
                                    <p class="text-sm text-gray-600">Y√∂n: ${device.direction} | Fiyat: ‚Ç∫${device.price}</p>
                                    <p class="text-sm text-gray-600">Seri No: ${device.serialNo} | Barkod: ${device.barcode}</p>
                                    <p class="text-sm text-gray-600">Atama Tarihi: ${device.assignmentDate}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="editAssignedDevice('${device.id}')" class="text-blue-600 hover:text-blue-800 text-sm">D√ºzenle</button>
                                    <button onclick="removeAssignedDevice('${device.id}')" class="text-red-600 hover:text-red-800 text-sm">Kaldƒ±r</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Assign device function
        function assignDevice() {
            const patient = window.patientDetailsManager?.currentPatient;
            
            // Check required patient information
            if (!patient.address || !patient.tcNumber || !patient.phone) {
                const missing = [];
                if (!patient.address) missing.push('Adres');
                if (!patient.tcNumber) missing.push('TC Kimlik No');
                if (!patient.phone) missing.push('Telefon');
                
                alert(`Cihaz atamak i√ßin ≈üu bilgiler eksik: ${missing.join(', ')}\n\nL√ºtfen hasta bilgilerini tamamlayƒ±n.`);
                return;
            }

            // Show device assignment modal
            const deviceModal = `
                <div id="deviceModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-2/3 shadow-lg rounded-md bg-white">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-900">Cihaz Atama</h3>
                            <button onclick="closeDeviceModal()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <form onsubmit="saveDeviceAssignment(event)">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">√úretici</label>
                                    <select id="deviceManufacturer" class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" required>
                                        <option value="">Se√ßiniz</option>
                                        <option value="Phonak">Phonak</option>
                                        <option value="Oticon">Oticon</option>
                                        <option value="ReSound">ReSound</option>
                                        <option value="Widex">Widex</option>
                                        <option value="Signia">Signia</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Model</label>
                                    <input type="text" id="deviceModel" class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Model adƒ±..." required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Y√∂n</label>
                                    <select id="deviceDirection" class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" required>
                                        <option value="">Se√ßiniz</option>
                                        <option value="Saƒü">Saƒü</option>
                                        <option value="Sol">Sol</option>
                                        <option value="Bilateral">Bilateral</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Adet</label>
                                    <input type="number" id="deviceCount" class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="1" min="1" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Fiyat (‚Ç∫)</label>
                                    <input type="number" id="devicePrice" class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="0.00" step="0.01" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Seri No</label>
                                    <input type="text" id="deviceSerialNo" class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Seri numarasƒ±..." required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Barkod No</label>
                                    <input type="text" id="deviceBarcode" class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Barkod numarasƒ±..." required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">UBB Firma Kodu</label>
                                    <input type="text" id="ubbCode" class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="12345" placeholder="UBB kodu...">
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3">
                                <button type="button" onclick="closeDeviceModal()" class="btn-secondary">ƒ∞ptal</button>
                                <button type="submit" class="btn-primary">Cihazƒ± Ata</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', deviceModal);
        }

        // Save device assignment
        function saveDeviceAssignment(event) {
            event.preventDefault();
            
            const patient = window.patientDetailsManager?.currentPatient;
            if (!patient) return;

            const deviceData = {
                id: 'device_' + Date.now(),
                manufacturer: document.getElementById('deviceManufacturer').value,
                model: document.getElementById('deviceModel').value,
                direction: document.getElementById('deviceDirection').value,
                count: parseInt(document.getElementById('deviceCount').value),
                price: parseFloat(document.getElementById('devicePrice').value),
                serialNo: document.getElementById('deviceSerialNo').value,
                barcode: document.getElementById('deviceBarcode').value,
                ubbCode: document.getElementById('ubbCode').value,
                assignmentDate: new Date().toLocaleDateString('tr-TR'),
                timestamp: new Date().toISOString()
            };

            // Initialize assignedDevices array if it doesn't exist
            if (!patient.assignedDevices) {
                patient.assignedDevices = [];
            }

            patient.assignedDevices.push(deviceData);
            
            // Update patient data in storage
            updatePatientInStorage(patient);
            
            // Reload devices display
            loadAssignedDevices();
            
            // Close modal
            closeDeviceModal();
            
            // Show success message
            showNotification('Cihaz ba≈üarƒ±yla atandƒ±.', 'success');
        }

        // Close device modal
        function closeDeviceModal() {
            const modal = document.getElementById('deviceModal');
            if (modal) {
                modal.remove();
            }
        }

        // Load saved e-receipts
        function loadSavedEReceipts() {
            const patient = window.patientDetailsManager?.currentPatient;
            const receiptsContainer = document.getElementById('savedEReceipts');
            
            if (!receiptsContainer || !patient) return;

            const savedReceipts = patient.savedEReceipts || [];
            
            if (savedReceipts.length === 0) {
                receiptsContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        Kaydedilmi≈ü e-re√ßete bulunmamaktadƒ±r.
                    </div>
                `;
                return;
            }

            receiptsContainer.innerHTML = `
                <div class="space-y-4">
                    ${savedReceipts.map(receipt => `
                        <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h5 class="font-medium text-gray-900">E-re√ßete: ${receipt.receiptNumber}</h5>
                                    <p class="text-sm text-gray-600">Doktor: ${receipt.doctorName}</p>
                                    <p class="text-sm text-gray-600">Tarih: ${receipt.receiptDate}</p>
                                </div>
                                <button onclick="toggleReceiptDetails('${receipt.id}')" class="text-blue-600 hover:text-blue-800 text-sm">Detaylar</button>
                            </div>
                            <div id="receiptDetails_${receipt.id}" class="hidden mt-4">
                                <h6 class="font-medium text-gray-800 mb-2">Malzemeler:</h6>
                                <div class="space-y-2">
                                    ${receipt.materials.map(material => `
                                        <div class="bg-white p-3 rounded border flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">${material.name}</span>
                                                <span class="text-xs text-gray-500 ml-2">${material.kdv}</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <input type="date" id="deliveryDate_${material.id}" class="text-xs rounded border-gray-300">
                                                <button onclick="deliverMaterial('${material.id}', '${receipt.id}')" class="btn-sm btn-primary">Malzeme Teslim Et</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Toggle receipt details
        function toggleReceiptDetails(receiptId) {
            const detailsDiv = document.getElementById(`receiptDetails_${receiptId}`);
            if (detailsDiv) {
                detailsDiv.classList.toggle('hidden');
            }
        }

        // Helper functions
        function updatePatientInStorage(patient) {
            // Update in sample data
            if (window.sampleData && window.sampleData.patients) {
                const index = window.sampleData.patients.findIndex(p => p.id === patient.id);
                if (index !== -1) {
                    window.sampleData.patients[index] = patient;
                }
            }
            
            // Update in localStorage
            try {
                localStorage.setItem('patients', JSON.stringify(window.sampleData?.patients || []));
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-md shadow-lg z-50 ${type === 'success' ? 'bg-green-100 text-green-800' : type === 'error' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Enhanced queryEReceipt with save functionality
        function saveEReceipt(receiptNo = null) {
            const receiptData = window.currentEReceiptData;
            if (!receiptData) {
                alert('√ñnce e-re√ßete sorgulamasƒ± yapmalƒ±sƒ±nƒ±z.');
                return;
            }

            const patient = window.patientDetailsManager?.currentPatient;
            if (!patient) return;

            // Get selected materials
            const selectedMaterials = [];
            const checkboxes = document.querySelectorAll('input[name="material"]:checked');
            if (checkboxes.length === 0) {
                // If no checkboxes with name="material", check for individual material checkboxes
                receiptData.materials.forEach(material => {
                    const checkbox = document.getElementById(`material_${material.id}`);
                    if (checkbox && checkbox.checked) {
                        selectedMaterials.push({
                            ...material,
                            appliedDate: document.getElementById('applicationDate')?.value || new Date().toISOString().split('T')[0],
                            delivered: false
                        });
                    }
                });
            } else {
                checkboxes.forEach(checkbox => {
                    const materialId = checkbox.value;
                    const material = receiptData.materials.find(m => m.id === materialId);
                    if (material) {
                        selectedMaterials.push({
                            ...material,
                            appliedDate: document.getElementById('applicationDate')?.value || new Date().toISOString().split('T')[0],
                            delivered: false
                        });
                    }
                });
            }

            if (selectedMaterials.length === 0) {
                alert('L√ºtfen en az bir malzeme se√ßin.');
                return;
            }

            // Initialize savedEReceipts array if it doesn't exist
            if (!patient.savedEReceipts) {
                patient.savedEReceipts = [];
            }

            const savedReceipt = {
                id: 'receipt_' + Date.now(),
                receiptNumber: receiptData.receiptNumber,
                doctorName: receiptData.doctorName,
                receiptDate: receiptData.receiptDate,
                materials: selectedMaterials,
                savedDate: new Date().toLocaleDateString('tr-TR')
            };

            patient.savedEReceipts.push(savedReceipt);
            
            // Update patient data in storage
            updatePatientInStorage(patient);
            
            // Reload saved receipts display
            loadSavedEReceipts();
            
            // Clear the current query
            document.getElementById('eReceiptResult').innerHTML = '';
            document.getElementById('eReceiptNo').value = '';
            window.currentEReceiptData = null;
            
            // Show success message
            showNotification('E-re√ßete ba≈üarƒ±yla kaydedildi.', 'success');
        }

        // ==================== PATIENT LABEL MANAGEMENT ====================

        // Patient acquisition types and conversion steps
        const ACQUISITION_TYPES = {
            'tabela': 'Tabela',
            'sosyal_medya': 'Sosyal Medya',
            'tanitim': 'Tanƒ±tƒ±m',
            'referans': 'Referans',
            'walk_in': 'Direkt Ba≈üvuru'
        };

        const CONVERSION_STEPS = {
            'yeni': 'Yeni Hasta',
            'arama_yapildi': 'Arama Yapƒ±ldƒ±',
            'randevu_verildi': 'Randevu Verildi',
            'randevuya_geldi': 'Randevuya Geldi',
            'deneme_yapildi': 'Deneme Yapƒ±ldƒ±',
            'satis_tamamlandi': 'Satƒ±≈ü Tamamlandƒ±',
            'kontrol_hastasi': 'Kontrol Hastasƒ±'
        };

        // Update patient label
        function updatePatientLabel(patientId, newLabel) {
            const patient = window.patientDetailsManager?.currentPatient;
            if (!patient || patient.id !== patientId) return;

            const oldLabel = patient.conversionStep;
            patient.conversionStep = newLabel;
            patient.lastLabelUpdate = new Date().toISOString();

            // Add label change to notes
            if (!patient.notes) patient.notes = [];
            patient.notes.push({
                id: 'label_change_' + Date.now(),
                title: 'Etiket Deƒüi≈üikliƒüi',
                type: 'Sistem',
                content: `Hasta etiketi "${CONVERSION_STEPS[oldLabel] || oldLabel}" den "${CONVERSION_STEPS[newLabel] || newLabel}" olarak deƒüi≈ütirildi.`,
                date: new Date().toLocaleDateString('tr-TR'),
                timestamp: new Date().toISOString()
            });

            // Update patient data
            updatePatientInStorage(patient);

            // Reload patient profile and notes
            if (window.patientProfile && window.patientProfile.updatePatientData) {
                window.patientProfile.updatePatientData(patient);
            }
            loadPatientNotes();
            checkDeviceAssignmentEligibility();

            showNotification(`Hasta etiketi "${CONVERSION_STEPS[newLabel]}" olarak g√ºncellendi.`, 'success');
        }

        // Quick label update buttons
        function showLabelUpdateModal() {
            const patient = window.patientDetailsManager?.currentPatient;
            if (!patient) return;

            const labelModal = `
                <div id="labelModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-900">Hasta Etiketini G√ºncelle</h3>
                            <button onclick="closeLabelModal()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="mb-4">
                            <p class="text-sm text-gray-600 mb-2">Mevcut Etiket: <span class="font-medium">${CONVERSION_STEPS[patient.conversionStep] || patient.conversionStep}</span></p>
                            <p class="text-sm text-gray-600 mb-4">Kazanƒ±m T√ºr√º: <span class="font-medium">${ACQUISITION_TYPES[patient.acquisitionType] || patient.acquisitionType}</span></p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            ${Object.entries(CONVERSION_STEPS).map(([key, label]) => `
                                <button 
                                    onclick="updatePatientLabel('${patient.id}', '${key}'); closeLabelModal();"
                                    class="p-3 text-left border rounded-lg hover:bg-gray-50 ${patient.conversionStep === key ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}"
                                    ${patient.conversionStep === key ? 'disabled' : ''}
                                >
                                    <div class="font-medium text-gray-900">${label}</div>
                                    <div class="text-sm text-gray-500">${getLabelDescription(key)}</div>
                                </button>
                            `).join('')}
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button onclick="closeLabelModal()" class="btn-secondary">ƒ∞ptal</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', labelModal);
        }

        // Get label description
        function getLabelDescription(labelKey) {
            const descriptions = {
                'yeni': 'ƒ∞lk kayƒ±t yapƒ±lan hasta',
                'arama_yapildi': 'Hasta ile ileti≈üim kuruldu',
                'randevu_verildi': 'Randevu planlandƒ±',
                'randevuya_geldi': 'Randevuya geldi, deƒüerlendirme yapƒ±ldƒ±',
                'deneme_yapildi': 'Cihaz denemesi tamamlandƒ±',
                'satis_tamamlandi': 'Satƒ±≈ü i≈ülemi tamamlandƒ±',
                'kontrol_hastasi': 'D√ºzenli takip edilen hasta'
            };
            return descriptions[labelKey] || '';
        }

        // Close label modal
        function closeLabelModal() {
            const modal = document.getElementById('labelModal');
            if (modal) {
                modal.remove();
            }
        }

        // Add label update button to patient profile
        function addLabelUpdateButton() {
            const profileContainer = document.getElementById('patient-profile-container');
            if (!profileContainer) return;

            const existingButton = document.getElementById('updateLabelButton');
            if (existingButton) return; // Button already exists

            const buttonHTML = `
                <div class="mt-3">
                    <button id="updateLabelButton" onclick="showLabelUpdateModal()" class="btn-sm btn-secondary">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.997 1.997 0 013 12V7a4 4 0 014-4z"></path>
                        </svg>
                        Etiket G√ºncelle
                    </button>
                </div>
            `;
            
            profileContainer.insertAdjacentHTML('beforeend', buttonHTML);
        }
    </script>

    <style>
        .tab-button {
            padding: 1rem 0;
            border-bottom: 2px solid transparent;
            color: #6B7280;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .tab-button:hover {
             color: #374151;
         }
         
         .tab-button.active {
             color: #2563EB;
             border-bottom-color: #2563EB;
         }
    </style>
</body>
</html>